ray.length){var e=this._getDistance()/this._distance;this.network.setZoom(this._zoom*e,!1)}else if(1==this._pointerIdArray.length&&this._startTouchPoint){var i=this.overview.getLogicalPoint(t);if(null==i)return;this._startTouchPoint=i,this.overview.centerNetwork(this._startTouchPoint,!1)}},handleTouchend:function(t){var e=this.overview.getLogicalPoint(t);if(1==this._pointerIdArray.length&&e){var i=this._endTouchPoint&&this._endTouchTime&&(new Date).getTime()-this._endTouchTime.getTime()<=500&&W.getDistance(this._endTouchPoint,e)<=10;i?(this._endTouchPoint=null,this._endTouchTime=null):(this._endTouchPoint=e,this._endTouchTime=new Date),i?D.callLater(this.network.zoomReset,this.network,[this.overview._animate]):this.overview.centerNetwork(this._endTouchPoint,this.overview._animate)}this._pointerMap={},this._pointerIdArray=[]},_getDistance:function(){return W.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),R.vector.OverviewInteraction=function(t){this.overview=t,this.network=t.getNetwork(),this.view=t._view,X.addEventListener(\"mousedown\",\"handleMousedown\",this.view,this)},D.ext(\"twaver.vector.OverviewInteraction\",Object,{handleMousedown:function(t){this.clear(),this.endPoint=this.overview.getLogicalPoint(t),D.isCtrlDown(t)&&(this.startPoint=this.endPoint,X.setVisible(this.overview._selectDiv,!0)),X.addEventListener(\"mousemove\",\"handleMousemove\",this.view,this),X.addEventListener(\"mouseup\",\"handleMouseup\",z,this)},handleMouseup:function(t){if(this.endPoint=this.overview.getLogicalPoint(t),\"detail\"in t&&2===t.detail)D.callLater(this.network.zoomReset,this.network,[this.endPoint,this.overview._animate]);else if(X.isVisible(this.overview._selectDiv)&&this.startPoint){var e=this.overview._imageDiv._viewRect,i=this.overview._selectDiv._viewRect.x,n=this.overview._selectDiv._viewRect.y,s=e.width/this.overview._selectDiv._viewRect.width,o=e.height/this.overview._selectDiv._viewRect.height,r=Math.min(s,o);this.network.setZoom(r*Math.min(this.network.getViewRect().width/this.network.getCanvasSize().width,this.network.getViewRect().height/this.network.getCanvasSize().height)*this.network.getZoom(),!1);var a=this.network.getCanvasSize().width*((i-e.x+this.overview._selectDiv._viewRect.width/2)/e.width),h=this.network.getCanvasSize().height*((n-e.y+this.overview._selectDiv._viewRect.height/2)/e.height);D.callLater(this.network.centerByLogicalPoint,this.network,[a,h,this.overview._animate]),X.setVisible(this.overview._selectDiv,!1),X.setDiv(this.overview._selectDiv,{x:0,y:0,width:0,height:0},null,0,null),this.startPoint=null}else this.overview.centerNetwork(this.endPoint,this.overview._animate);this.clear()},handleMousemove:function(t){var e=this.overview.getLogicalPoint(t);if(this.endPoint=e,X.isVisible(this.overview._selectDiv)&&this.startPoint){var i=e.x>this.startPoint.x?this.startPoint.x:e.x,n=e.x>this.startPoint.x?this.startPoint.y:e.y;e.x>this.startPoint.x&&e.y<this.startPoint.y&&(n=e.y),e.x<this.startPoint.x&&e.y>this.startPoint.y&&(n=this.startPoint.y);var s=this.overview._imageDiv._viewRect;i<s.x&&(i=s.x),i>s.x+s.width&&(i=s.x+s.width),n<s.y&&(n=s.y),n>s.y+s.height&&(n=s.y+s.height);var o=Math.abs(e.x-this.startPoint.x),r=Math.abs(e.y-this.startPoint.y);i+o>s.x+s.width&&(o=s.x+s.width-i),n+r>s.y+s.height&&(r=s.y+s.height-n),X.setDiv(this.overview._selectDiv,{x:i,y:n,width:o,height:r},null,this.overview._selectWidth,this.overview._selectColor)}else this.overview.centerNetwork(e,!1)},clear:function(){this.endPoint&&(this.endPoint=null,X.removeEventListener(\"mousemove\",this.view,this),X.removeEventListener(\"mouseup\",z,this))}}),R.vector.ElementUI=function(t,e){this._network=t,this._element=e,this._attachments=new R.List,this._bodyBounds=new R.List,this._hitTest=!1,this._hitTest=!1,this._intersectTest=!1,this.invalidate(!0)},D.ext(\"twaver.vector.ElementUI\",Object,{getElement:function(){return this._element},getNetwork:function(){return this._network},handlePropertyChange:function(t){},handleSelectionChange:function(t){},invalidate:function(t){void 0===t&&(t=!0),t&&(this._invalidateAttachmentsFlag=!0),this._invalidateFlag||(this._hotSpot=null,this._bodyRect=null,this._invalidateFlag=!0,this.invalidateZoom(),this.setAttachmentVisible&&this.setAttachmentVisible(!1))},invalidateZoom:function(){this._zoomBodyRect=null,this._zoomViewRect=null,this._zoomHotSpot=null},updateStyle:function(){this._innerColor=this._network.getInnerColor(this._element),this._outerColor=this._network.getOuterColor(this._element),this._glowBlur=this._element.getStyle(\"glow.blur\"),this._shadowColor=this._network.getShadowColor(this._element),this._shadowXOffset=this._element.getStyle(\"shadow.xoffset\"),this._shadowYOffset=this._element.getStyle(\"shadow.yoffset\"),this._shadowBlur=this._element.getStyle(\"shadow.blur\"),this._wholeAlpha=this._element.getStyle(\"whole.alpha\")},validate:function(){var t=this;if(0!=this._invalidateFlag){this._bodyBounds.clear(),this._invalidateAttachmentsFlag&&(this._invalidateAttachmentsFlag=!1,this.checkAttachments()),this._invalidateFlag=!1,this.updateStyle(),this.validateImpl(),this._attachments.forEach(function(t){t.validate()});var e;this._bodyBounds.forEach(function(t){e=W.unionRect(e,t)}),null==e&&((e=D.cloneRect(this._element.getLocation())).width=0,e.height=0),this._unionBodyBounds={x:e.x,y:e.y,width:e.width,height:e.height},this._attachments.forEach(function(i){e=i instanceof R.vector.EditAttachment?i.getElementUI()instanceof R.vector.LinkUI?W.unionRect(e,i._viewRect):W.unionRect(e,t._network.zoomManager._reverseElementZoomRect(t,i._viewRect)):i.getElementUI()instanceof R.vector.LinkUI?W.unionRect(e,t._network.zoomManager._getAttachmentZoomOutLineRect(i,i._viewRect)):i.getElementUI()instanceof R.vector.GroupUI&&i.getElementUI()._shapeRect?i instanceof R.vector.IconsAttachment?W.unionRect(e,i._viewRect):W.unionRect(e,t._network.zoomManager._getAttachmentZoomOutLineRect(i,i._viewRect)):W.unionRect(e,i._viewRect)}),this._viewRect=e}},validateImpl:function(){},setGlow:function(t,e){\"glow\"===this._element.getStyle(\"outer.style\")&&(e.shadowColor=this._outerColor,e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=this._glowBlur)},clearGlow:function(t){0==t.shadowOffsetX&&0==t.shadowOffsetY&&0==t.shadowBlur||(t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0)},setShadow:function(t,e){var i=this._network.zoomManager,n=t.isShadowable()&&this._shadowColor&&!this._editAttachment;if(e.shadowOffsetX===this._shadowXOffset&&e.shadowOffsetY===this._shadowYOffset&&e.shadowBlur===this._shadowBlur)return e;if(n||this._network._showShadowInEdit){var s=i.getGraphicsZoom();(s*=i.getSizeZoom())>1&&(s=1),e.shadowOffsetX=this._shadowXOffset*s,e.shadowOffsetY=this._shadowYOffset*s,e.shadowBlur=this._shadowBlur*s,e.shadowColor=this._shadowColor}return e},clearShadow:function(t){0==t.shadowOffsetX&&0==t.shadowOffsetY&&0==t.shadowBlur||(t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0)},appendShadowBound:function(t,e){if(t.isShadowable()&&this._shadowColor&&!this._editAttachment){var i=this._network.zoomManager,n=i.getGraphicsZoom();(n*=i.getSizeZoom())>1&&(n=1),this._shadowXOffset>0?e.width+=this._shadowXOffset:(e.x+=this._shadowXOffset,e.width+=-this._shadowXOffset),this._shadowYOffset>0?e.height+=this._shadowYOffset:(e.y+=this._shadowYOffset,e.height+=-this._shadowYOffset);var s=this._shadowBlur;s=Math.ceil(s/n),W.grow(e,s+1,s+1)}return e},appendGlowBound:function(t,e){if(\"glow\"===this._element.getStyle(\"outer.style\")){var i=this._network.zoomManager,n=i.getGraphicsZoom();(n*=i.getSizeZoom())>1&&(n=1);var s=this._glowBlur;s=Math.ceil(s/n),W.grow(e,s+1,s+1)}},isShadowable:function(){return!(!this._shadowColor||!this._network.isSelected(this._element)||\"shadow\"!==this._element.getStyle(\"select.style\"))},addAttachment:function(t){this._attachments.add(t),this.invalidate(!1)},removeAttachment:function(t){this._attachments.remove(t),this._network._hitTestTopAttachmentList.remove(t),this.invalidate(!1)},getAttachments:function(){return this._attachments},checkAttachments:function(){this.checkLabelAttachment(),this.checkLabel2Attachment(),this.checkAlarmAttachment(),this.checkIconsAttachment(),this.checkEditAttachment()},checkLabelAttachment:function(){var t=this._network.getLabel(this._element);null!=t&&\"\"!==t?this._labelAttachment||(this._labelAttachment=new R.vector.LabelAttachment(this,xe.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkLabel2Attachment:function(){var t=this._network.getLabel2(this._element);null!=t&&\"\"!==t?this._label2Attachment||(this._label2Attachment=new R.vector.Label2Attachment(this,xe.SHOW_LABEL2_IN_ATTACHMENT_DIV),this.addAttachment(this._label2Attachment)):this._label2Attachment&&(this.removeAttachment(this._label2Attachment),this._label2Attachment=null)},checkAlarmAttachment:function(){var t=this._network.getAlarmLabel(this._element);null!=t&&\"\"!==t?this._alarmAttachment||(this._alarmAttachment=new R.vector.AlarmAttachment(this,xe.SHOW_ALARM_IN_ATTACHMENT_DIV),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},checkIconsAttachment:function(){var t=this._network.getIconsNames(this._element);t&&t.length>0?this._iconsAttachment||(this._iconsAttachment=new R.vector.IconsAttachment(this,xe.SHOW_ICON_IN_ATTACHMENT_DIV),this.addAttachment(this._iconsAttachment)):this._iconsAttachment&&(this.removeAttachment(this._iconsAttachment),this._iconsAttachment=null)},checkEditAttachment:function(){this._network.hasEditInteraction()&&this._network.isSelected(this._element)&&this._network.isEditable(this._element)&&this.isEditable()?this._editAttachment||(this._editAttachment=new R.vector.EditAttachment(this,xe.SHOW_EDIT_IN_ATTACHMENT_DIV),this.addAttachment(this._editAttachment)):this._editAttachment&&(this.removeAttachment(this._editAttachment),this._editAttachment=null)},getLabelAttachment:function(){return this._labelAttachment},getAlarmAttachment:function(){return this._alarmAttachment},getIconsAttachment:function(){return this._iconsAttachment},getEditAttachment:function(){return this._editAttachment},isEditable:function(){return!0},getInnerColor:function(){return this._innerColor},getOuterColor:function(){return this._outerColor},getShadowColor:function(){return this._shadowColor},getDyeColor:function(t){return this._innerColor?this._innerColor:this.getStyle(t)},getStyle:function(t){return this._element.getStyle(t)},getFont:function(t){var e=this._element.getStyle(t);return e||R.Defaults.FONT},paint:function(t){t.save(),t.globalAlpha=this._wholeAlpha,t.beginPath(),this.paintBody(t),this.clearShadow(t),this.clearGlow(t),t.closePath(),t.beginPath(),this.paintAttachments(t),t.closePath(),t.restore(),this._network._debug&&Y.strokeRect(t,this.getZoomBodyRect(),\"orange\")},paintBody:function(t){},getZoomBodyRect:function(t){return this._network.zoomManager._getElementZoomRect(this,this.getBodyRect())},getZoomHotSpot:function(){return this._zoomHotSpot||(this._zoomHotSpot=this._network.zoomManager._getZoomHotSpot(this,this._hotSpot)),D.clone(this._zoomHotSpot)},getZoomPointers:function(t,e){return this._network.zoomManager._getZoomPointers(t,this,e)},_getZoomViewRect:function(t,e,i){var n=this._network.zoomManager;if(e){return D.cloneRect(n._getAttachmentZoomRect(e,t))}var s=n.getLocationZoom(),o=n.getSizeZoom(this),r=this._bodyRect?this._bodyRect:this.getBodyRect();t=t||{x:r.x,y:r.y,width:0,height:0};var a=r.x+r.width/2,h=r.y+r.height/2;return{x:a*s+(t.x-a)*o,y:h*s+(t.y-h)*o,width:t.width*o,height:t.height*o}},getZoomViewRect:function(t){var e=this._network.zoomManager,i=e.getLocationZoom();e.getGraphicsZoom();if(1==i)return D.cloneRect(this._viewRect);if(!this._zoomViewRect||t){var n,s=this._getZoomViewRect(D.cloneRect(this._unionBodyBounds),!1);n=W.unionRect(n,s);this._attachments.forEach(function(t){n=t instanceof R.vector.EditAttachment?W.unionRect(n,t._viewRect):W.unionRect(n,t.getZoomViewRect())}),this._zoomViewRect=n}return D.cloneRect(this._zoomViewRect)},paintAttachments:function(t){t.beginPath();for(var e=this._attachments.size(),i=0;i<e;i++){var n=this._attachments.get(i);(this._network.isShowAttachOnChg()||this._network.isVisibleAttachment(n))&&(1==this._hitTest&&0==n.isShowOnTop()&&this.paintAttachment(t,n),1==this._intersectTest&&this.paintAttachment(t,n),0==this._hitTest&&0==this._intersectTest&&(n.isShowOnTop()?this._network._topAttachmentList.add(n):this.paintAttachment(t,n)))}},paintAttachment:function(t,e){var i=this._network.zoomManager;i.isAttachmentVisible(this._element)&&(e!=this._labelAttachment&&e!=this._label2Attachment||i.isLabelVisible(this._element))&&(e!=this._alarmAttachment||i.isAlarmBalloonVisible(this._element))&&(t.beginPath(),e.paint(t),this.clearShadow(t))},getViewRect:function(){return D.cloneRect(this._viewRect)},getUnionBodyBounds:function(){return D.cloneRect(this._unionBodyBounds)},addBodyBounds:function(t){t&&this._bodyBounds.add(t)},getBodyRect:function(t){return void 0==t&&(t=!0),this._bodyRect||(this._bodyRect=this.createBodyRect()),t?D.cloneRect(this._bodyRect):this._bodyRect},getHotSpot:function(){return this._hotSpot?D.clone(this._hotSpot):{x:0,y:0}},setHotSpot:function(t){this._hotSpot=t},hit:function(t,e){return!1},intersects:function(t){return!!W.contains(t,this.getZoomViewRect())},hitCanvasRectAtBody:function(t){t.width<1&&(t.width=1),t.height<1&&(t.height=1);var e=Me.getHitCanvas(t.width,t.height),i=Me.getCtx(e);if(i.save(),i.translate(-t.x,-t.y),this._element.getImage){var n=D.getImageAsset(this._element.getImage());if(n&&n.getImage()instanceof be)return 1}this.paintBody(i);try{for(var s=i.getImageData(0,0,t.width,t.height),o=s.data,r=0;r<s.width;r++)for(var a=0;a<s.height;a++){if(0!==o[4*(a*s.width+r)+3])return i.restore(),1}}catch(e){if(Me.disposeHitCanvas(),W.contains(this.getUnionBodyBounds(),t))return 0}return i.restore(),-1},hitCanvasRectAtAttachments:function(t){var e=Me.getHitCanvas(t.width,t.height),i=Me.getCtx(e);i.save(),i.translate(-t.x,-t.y),this.paintAttachments(i);try{for(var n=i.getImageData(0,0,t.width,t.height),s=n.data,o=0;o<n.width;o++)for(var r=0;r<n.height;r++){if(0!==s[4*(r*n.width+o)+3])return i.restore(),1}}catch(t){Me.disposeHitCanvas()}return i.restore(),-1},hitCanvasRect:function(t){this._intersectTest=!0,1==this._hitTest&&(this._intersectTest=!1);var e=W.intersection(t,this.getZoomViewRect()),i=this.hitCanvasRectAtBody(e);if(1==i)return this._intersectTest=!1,!0;return 1==this.hitCanvasRectAtAttachments(e)?(this._intersectTest=!1,!0):(this._intersectTest=!1,0==i)},hitCanvasPoint:function(t,e){var i={x:t,y:e,width:0,height:0},n=this._network.getSelectionTolerance();if(n&&n>0&&W.grow(i,n,n),!W.intersects(this.getZoomViewRect(),i))return!1;this._hitTest=!0;var s=this.hitCanvasRect(i);return this._hitTest=!1,s},hitTest:function(t,e){var i={x:t,y:e,width:0,height:0},n=this._network.getSelectionTolerance();if(n&&n>0&&W.grow(i,n,n),!W.intersects(this.getZoomViewRect(),i))return null;for(var s=W.intersection(i,this.getZoomViewRect()),o=this._attachments.size(),r=0;r<o;r++){var a=this._attachments.get(r);if(a.hit(t,e))return a}var h=this.hitCanvasRectAtBody(s);return 1==h?this:0==h?this:null},dispose:function(){this._attachments.forEach(function(t){t.dispose()}),this._attachments.clear()}}),R.vector.NodeUI=function(t,e){R.vector.NodeUI.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.NodeUI\",R.vector.ElementUI,{invalidate:function(t){this.curInterval&&clearInterval(this.curInterval),R.vector.NodeUI.superClass.invalidate.call(this,t)},createBodyRect:function(){return this._element.getRect()},validateImpl:function(){R.vector.NodeUI.superClass.validateImpl.call(this);var t=this.getStyle(\"vector.shape\"),e=this.getBodyRect();this._hotSpot=W.getHotSpot(e.x,e.y,e.width,e.height,t),this.validateBodyBounds()},validate:function(){0!=this._invalidateFlag&&R.vector.NodeUI.superClass.validate.call(this)},validateBodyBounds:function(){var t=this.getStyle(\"body.type\");\"default\"===t?this.addBodyBounds(this.getDefaultBodyRect()):\"vector\"===t?this.addBodyBounds(this.getVectorBody()):\"default.vector\"===t?(this.addBodyBounds(this.getVectorBody()),this.addBodyBounds(this.getDefaultBodyRect())):\"vector.default\"===t&&(this.addBodyBounds(this.getDefaultBodyRect()),this.addBodyBounds(this.getVectorBody())),this._outerColor&&\"border\"===this.getStyle(\"outer.style\")&&this.addBodyBounds(this.getOuterBorderRect()),!this._editAttachment&&\"border\"===this.getStyle(\"select.style\")&&this._network.isSelected(this._element)&&this.addBodyBounds(this.getSelectBorderRect())},getDefaultBodyRect:function(){var t=this._element,e=this.getBodyRect();if(!t.getImage()||\"string\"==typeof t.getImage()&&!D.getImageAsset(t.getImage()))return e;W.addPadding(e,this._element,\"image.padding\",1);var i=D.cloneRect(e);return this.appendGlowBound(this,i),this.appendShadowBound(this,i),e=i},getVectorBody:function(){return this.getPathRect(\"vector\")},getOuterBorderRect:function(){return this._getBorderRect(\"outer\")},getSelectBorderRect:function(){return this._getBorderRect(\"select\")},_getBorderRect:function(t){var e=this._element,i=e.getStyle(t+\".width\"),n=e.getStyle(\"select.physicalZoom\")?1:this._network.getGraphicsZoom();if(i>0){i=\"select\"===t?i/n:i;var s=this.getBodyRect();W.addPadding(s,e,t+\".padding\",\"select\"===t?1/n:1);var o=D.cloneRect(s);return W.grow(o,2*i,2*i),o}return null},getPathRect:function(t,e){var i=this._element,n=this.getBodyRect();this._network.zoomManager.getSizeZoom();e&&W.addPadding(n,i,t+\".padding\",1);var s=D.cloneRect(n),o=i.getStyle(t+\".outline.width\");if(o>0)if(this._getZoomPoints){for(var r=this._element._points,a=r.size(),h=0,l=0;l<a;l++){if(0==l)var c=r.get(l),d=r.get(a-1),u=r.get(l+1);else if(l==a-1)c=r.get(l),d=r.get(l-1),u=r.get(0);else c=r.get(l),d=r.get(l-1),u=r.get(l+1);var _=W.getCenterPoint(d,u),g=W.getAngle(_,c),f=Math.abs(5*(o+1)*Math.sin(g));h=(h=h<f?f:h)<(f=Math.abs(5*(o+1)*Math.cos(g)))?f:h}W.grow(s,h,h)}else W.grow(s,o/2,o/2);return this.appendGlowBound(this,s),this.appendShadowBound(this,s),s},getZoomPathRect:function(t,e){var i=this._element,n=this.getZoomBodyRect();this._network.zoomManager.getSizeZoom();e&&W.addPadding(n,i,t+\".padding\",1);var s=D.cloneRect(n),o=i.getStyle(t+\".outline.width\");if(o>0)if(this._getZoomPoints){for(var r=this._getZoomPoints(),a=r.size(),h=0,l=0;l<a;l++){if(0==l)var c=r.get(l),d=r.get(a-1),u=r.get(l+1);else if(l==a-1)c=r.get(l),d=r.get(l-1),u=r.get(0);else c=r.get(l),d=r.get(l-1),u=r.get(l+1);var _=W.getCenterPoint(d,u),g=W.getAngle(_,c),f=Math.abs(5*(o+1)*Math.sin(g));h=(h=h<f?f:h)<(f=Math.abs(5*(o+1)*Math.cos(g)))?f:h}W.grow(s,h,h)}else W.grow(s,o/2,o/2);return this.appendGlowBound(this,s),this.appendShadowBound(this,s),s},paintBody:function(t){this.curInterval&&clearInterval(this.curInterval);var e=this.getStyle(\"body.type\");\"default\"===e?this.drawDefaultBody(t):\"vector\"===e?this.drawVectorBody(t):\"default.vector\"===e?(this.drawVectorBody(t),this.drawDefaultBody(t)):\"vector.default\"===e&&(this.drawDefaultBody(t),this.drawVectorBody(t)),this._outerColor&&\"border\"===this.getStyle(\"outer.style\")&&this.drawOuterBorder(t),\"border\"===this.getStyle(\"select.style\")&&this._network.isSelected(this._element)&&this.drawSelectBorder(t)},drawOuterBorder:function(t){var e=this._element,i=e.getStyle(\"outer.width\");if(i>0){var n=this.getZoomBodyRect();W.addPadding(n,e,\"outer.padding\",1),t.lineWidth=i,t.lineCap=e.getStyle(\"outer.cap\"),t.lineJoin=e.getStyle(\"outer.join\"),t.strokeStyle=this._outerColor,Y.drawVector(t,e.getStyle(\"outer.shape\"),null,n),t.stroke()}},drawDefaultBody:function(t){var e,i=this._element;if(i.getImage()&&(\"string\"!=typeof i.getImage()||(e=D.getImageAsset(i.getImage())))&&(!this._shapeRect||i.getStyle(\"group.expend.image\")&&(\"string\"!=typeof i.getStyle(\"group.expend.image\")||(e=D.getImageAsset(i.getStyle(\"group.expend.image\")))))){var n=this.getZoomBodyRect();W.addPadding(n,this._element,\"image.padding\",1),0!=i.getAngle()&&(t.save(),n=i.getOriginalRect(),n=this._network.zoomManager._getElementZoomRect(this,n),R.Util.rotateCanvas(t,n,i.getAngle())),this.setGlow(this,t),this.setShadow(this,t);if(e&&e.getImage()instanceof be){var s,o=e.getImage().frames,r=e.getImage().size,a=0;s=Le(o,r,0),t.drawImage(s,n.x,n.y,n.width,n.height),this.curInterval=setInterval(function(){a=(a+o.length)%o.length,s=Le(o,r,a),t.drawImage(s,n.x,n.y,n.width,n.height),a++},100)}else this._shapeRect?Dt(t,i.getStyle(\"group.expend.image\"),this.getInnerColor(),n,i,this._network):Dt(t,i.getImage(),this.getInnerColor(),n,i,this._network);0!=i.getAngle()&&t.restore()}},drawSelectBorder:function(t){this.clearGlow(t);var e=this._element,i=e.getStyle(\"select.width\");if(i>0){var n=this.getZoomBodyRect();n=D.cloneRect(n);var s=e.getStyle(\"select.physicalZoom\")?1:this._network.getGraphicsZoom();W.addPadding(n,e,\"select.padding\",1/s),W.grow(n,i/2/s,i/2/s),t.lineWidth=i/s,t.lineCap=e.getStyle(\"select.cap\"),t.lineJoin=e.getStyle(\"select.join\"),t.strokeStyle=e.getStyle(\"select.color\"),Y.drawVector(t,e.getStyle(\"select.shape\"),null,n),t.stroke()}},drawVectorBody:function(t){this.drawPath(t,\"vector\",!0,this._element.getStyle(\"vector.outline.pattern\"));var e=this.getStyle(\"vector.deep\"),i=this.getStyle(\"vector.fill.color\");if(0!==e&&i&&\"rectangle\"===this.getStyle(\"vector.shape\")){var n=this.getZoomBodyRect(),s=this._element.getAngle();if(0!=s){t.save();var o=this._element.getOriginalRect();o=this._network.zoomManager._getElementZoomRect(this,o),R.Util.rotateCanvas(t,o,s)}Y.draw3DRect(t,i,e,n),0!=s&&t.restore()}},drawPath:function(t,e,i,n,s,o,r){var a=this._network.zoomManager,h=this._element,l=null;l=\"group\"==e?this._shapeRect:this.getZoomBodyRect(),i&&W.addPadding(l,h,e+\".padding\",1);var c=h.getStyle(e+\".outline.width\");this.setGlow(this,t),this.setShadow(this,t),0!=h.getAngle()&&(h instanceof De||(l=h.getOriginalRect(),l=a._getElementZoomRect(this,l)),t.save(),R.Util.rotateCanvas(t,l,h.getAngle()));var d,u=h.getStyle(e+\".fill\");if(u){d=this._innerColor&&!vt.hasDefault(this._element)?this._innerColor:h.getStyle(e+\".fill.color\");var _=h.getStyle(e+\".gradient\");_?Y.fill(t,d,_,h.getStyle(e+\".gradient.color\"),l):t.fillStyle=d}var g=h.getStyle(e+\".shape\"),f=h.getStyle(\"group.shape.roundrect.radius\");f<0&&(f=10),u&&(t.beginPath(),s?Y.drawLinePoints(t,s,null,o,r):\"roundrect\"===g&&\"group\"===e?Y.drawVector(t,g,null,l,f):Y.drawVector(t,g,null,l),t.fill()),c>0&&(t.lineWidth=c,t.lineCap=h.getStyle(e+\".cap\"),t.lineJoin=h.getStyle(e+\".join\"),t.strokeStyle=h.getStyle(e+\".outline.color\"),t.beginPath(),s?Y.drawLinePoints(t,s,n,o,r):\"roundrect\"===g&&\"group\"===e?Y.drawVector(t,g,n,l,f):Y.drawVector(t,g,n,l),t.stroke()),0!=h.getAngle()&&t.restore()},hit:function(t,e){var i={x:t,y:e,width:0,height:0},n=this._network.getSelectionTolerance();if(n&&n>0&&W.grow(i,n,n),this._network._transparentSelectionEnable){var s=this.getBodyRect();if(D.math.intersects(s,i))return!0}return!!W.intersects(this.getZoomViewRect(),i)&&this.hitCanvasPoint(t,e)},intersects:function(t){if(1==R.vector.NodeUI.superClass.intersects.apply(this,arguments))return!0;if(this._network._transparentSelectionEnable){var e=this.getBodyRect();if(D.math.intersects(e,t))return!0}return!!W.intersects(t,this.getZoomViewRect())&&this.hitCanvasRect(t)}}),R.vector.LinkUI=function(t,e){R.vector.LinkUI.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.LinkUI\",R.vector.ElementUI,{isEditable:function(){return!0},invalidate:function(t){this._linkPoints=null,this._fromPoint=null,this._toPoint=null,this._angle=null,R.vector.LinkUI.superClass.invalidate.call(this,t)},invalidateZoom:function(){this._fromPoint=null,this._toPoint=null,this._linkPoints=null,R.vector.LinkUI.superClass.invalidateZoom.call(this)},validateImpl:function(){this.validateBodyBounds(),R.vector.LinkUI.superClass.validateImpl.call(this)},validateBodyBounds:function(){var t=this.getLinkPoints();if(t&&!(t.size()<2)){var e=this._element,i=W.getLineRect(t),n=e.getStyle(\"link.width\");if(this._outerColor){n+=2*e.getStyle(\"outer.width\")}if(!this._editAttachment&&\"border\"===e.getStyle(\"select.style\")&&this._network.isSelected(this._element)){n+=2*e.getStyle(\"select.width\")}W.grow(i,n/2,n/2),e.getStyle(\"arrow.from\")&&(this._network._edgeDetect?(this._network._debug&&(this._arrowFromRect=re.getArrowRect(this,t,!0,e.getStyle(\"arrow.from.shape\"),e.getStyle(\"arrow.from.width\"),e.getStyle(\"arrow.from.height\"),0,0,this._network.zoomManager)),i=W.unionRect(i,re.getArrowRect(this,t,!0,e.getStyle(\"arrow.from.shape\"),e.getStyle(\"arrow.from.width\"),e.getStyle(\"arrow.from.height\"),0,0,this._network.zoomManager))):(this._network._debug&&(this._arrowFromRect=re.getArrowRect(this,t,!0,e.getStyle(\"arrow.from.shape\"),e.getStyle(\"arrow.from.width\"),e.getStyle(\"arrow.from.height\"),e.getStyle(\"arrow.from.xoffset\"),e.getStyle(\"arrow.from.yoffset\"),this._network.zoomManager)),i=W.unionRect(i,re.getArrowRect(this,t,!0,e.getStyle(\"arrow.from.shape\"),e.getStyle(\"arrow.from.width\"),e.getStyle(\"arrow.from.height\"),e.getStyle(\"arrow.from.xoffset\"),e.getStyle(\"arrow.from.yoffset\"),this._network.zoomManager)))),e.getStyle(\"arrow.to\")&&(this._network._edgeDetect?(this._network._debug&&(this._arrowToRect=re.getArrowRect(this,t,!1,e.getStyle(\"arrow.to.shape\"),e.getStyle(\"arrow.to.width\"),e.getStyle(\"arrow.to.height\"),0,0,this._network.zoomManager)),i=W.unionRect(i,re.getArrowRect(this,t,!1,e.getStyle(\"arrow.to.shape\"),e.getStyle(\"arrow.to.width\"),e.getStyle(\"arrow.to.height\"),0,0,this._network.zoomManager))):(this._network._debug&&(this._arrowToRect=re.getArrowRect(this,t,!1,e.getStyle(\"arrow.to.shape\"),e.getStyle(\"arrow.to.width\"),e.getStyle(\"arrow.to.height\"),e.getStyle(\"arrow.to.xoffset\"),e.getStyle(\"arrow.to.yoffset\"),this._network.zoomManager)),i=W.unionRect(i,re.getArrowRect(this,t,!1,e.getStyle(\"arrow.to.shape\"),e.getStyle(\"arrow.to.width\"),e.getStyle(\"arrow.to.height\"),e.getStyle(\"arrow.to.xoffset\"),e.getStyle(\"arrow.to.yoffset\"),this._network.zoomManager)))),this.appendShadowBound(this,i),this.addBodyBounds(i),this._growLinkJoinBounds(i,n)}},_growLinkJoinBounds:function(t,e){},createBodyRect:function(){var t=this.getHotSpot();return t?{x:t.x-1,y:t.y-1,width:2,height:2}:null},paintBody:function(t){var e=this.getLinkPoints();if(e&&!(e.size()<2)){var i=this._element,n=i.isBundleAgent()&&i.getStyle(\"link.agent\"),s=n?i.getStyle(\"link.agent.width\"):i.getStyle(\"link.width\"),o=s;if(this._outerColor&&\"border\"===this.getStyle(\"outer.style\")){var r=i.getStyle(\"outer.width\");o+=2*r}var a=!this._editAttachment&&\"border\"===i.getStyle(\"select.style\")&&this._network.isSelected(this._element);if(a){o+=2*i.getStyle(\"select.width\")}this.setGlow(this,t),this.setShadow(this,t),t.lineCap=n?i.getStyle(\"link.agent.cap\"):i.getStyle(\"link.cap\"),t.lineJoin=n?i.getStyle(\"link.agent.join\"):i.getStyle(\"link.join\");var h=n?i.getStyle(\"link.agent.pattern\"):i.getStyle(\"link.pattern\");a&&this.drawLinePoints(t,e,o,i.getStyle(\"select.color\"),h),this._outerColor&&\"border\"===this.getStyle(\"outer.style\")&&this.drawLinePoints(t,e,s+2*r,this._outerColor,h),this.drawLinePoints(t,e,s,this._innerColor||(n?i.getStyle(\"link.agent.color\"):i.getStyle(\"link.color\")),h),re.drawLinkArrow(this,t,e,this._network.zoomManager),this._network._debug&&(Y.strokeRect(t,this._arrowToRect,R.Util.randomColor()),Y.strokeRect(t,this._arrowFromRect,R.Util.randomColor()))}},drawLinePoints:function(t,e,i,n,s){t.lineWidth=i,t.strokeStyle=n;var o=this._element.isBundleAgent()&&this._element.getStyle(\"link.agent\");if(!0===this._element.getStyle(o?\"link.agent.flow\":\"link.flow\")&&s&&s.length>1&&s[0]&&s[1]){var r=new ft(t,s[0],s[1]),a=this._element.getStyle(o?\"link.agent.flow.offset\":\"link.flow.offset\"),h=Math.floor(a/(s[0]+s[1]));h>2&&(a-=(s[0]+s[1])*h),this._element.getStyle(o?\"link.agent.flow.converse\":\"link.flow.converse\")?a<s[0]?r.overflow=s[0]-a:a>=s[0]&&a<=s[0]+s[1]?(r.overflow=s[1]-(a-s[0]),r.overflow&&(r.isLine=!1)):(a-=s[0]+s[1],r.overflow=s[0]-a):a<=s[1]?(r.overflow=a,a&&(r.isLine=!1)):a>s[1]&&a<=s[0]+s[1]?r.overflow=a-s[1]:((a-=s[0]+s[1])&&(r.isLine=!1),r.overflow=a),this._element._styleMap[o?\"link.agent.flow.offset\":\"link.flow.offset\"]=a,t.beginPath(),Y._drawLine(e,t),t.stroke(),t.shadowColor=\"transparent\",t.beginPath();var l=this._element.getStyle(o?\"link.agent.flow.color\":\"link.flow.color\");l=l||xe.NETWORK_LINK_FLOW_COLOR,t.strokeStyle=l,Y._drawLine(e,r),t.stroke(),t.shadowColor=this._shadowColor}else t.beginPath(),Y.drawLinePoints(t,e,s),t.stroke()},getLinkPoints:function(){return this._linkPoints||(this._linkPoints=this.createLinkPoints(),this._lineLength=W.calculateLineLength(this._linkPoints)),this._linkPoints},getFromPosition:function(t,e){var i=this.getFromPoint();return i?{x:i.x+t,y:i.y+e}:null},getToPosition:function(t,e){var i=this.getToPoint();return i?{x:i.x+t,y:i.y+e}:null},getFromPoint:function(){return this._fromPoint||(this._fromPoint=pt.createFromPoint(this,this._network.zoomManager)),this._fromPoint},getToPoint:function(){return this._toPoint||(this._toPoint=pt.createToPoint(this,this._network.zoomManager)),this._toPoint},getZoomBodyRect:function(){return this.getBodyRect()},getZoomViewRect:function(){return this._viewRect},createLinkPoints:function(){var t=this._network.zoomManager,e=this.getStyle(\"link.type\"),i=new R.List;if(pt.isOrthogonalOrFlexionalLink(this._element))i=pt.orthogonalAndFlexional(this,e,t);else if(this._element.isLooped()){var n=this._network.getElementUI(this._element.getFromAgent());null!=n&&(this._hotSpot=pt.fillLoopedPoints(this,n.getZoomBodyRect(),i))}else{if(\"arc\"!==e&&\"triangle\"!==e&&\"parallel\"!==e)throw\"Can not resolve link type '\"+e+\"'\";var s=this.getFromPoint(),o=this.getToPoint();this._hotSpot=pt.fillBundlePoints(this,e,s,o,i,t)}if(this._network._linkPathFunction){var r=this._network._linkPathFunction(this,i);r&&(i=r)}return i},checkAttachments:function(){R.vector.LinkUI.superClass.checkAttachments.call(this),this.checkLinkHandlerAttachment()},checkLinkHandlerAttachment:function(){var t=this._network.getLinkHandlerLabel(this._element);null!=t&&\"\"!==t?this._linkHandlerAttachment||(this._linkHandlerAttachment=new R.vector.LinkHandlerAttachment(this),this.addAttachment(this._linkHandlerAttachment)):this._linkHandlerAttachment&&(this.removeAttachment(this._linkHandlerAttachment),this._linkHandlerAttachment=null)},getLinkHandlerAttachment:function(){return this._linkHandlerAttachment},getControlPoint:function(){return pt.getControlPoint(this._element,this,this._network.zoomManager)},setControlPoint:function(t){if(t){var e=this.getStyle(\"link.type\");if(pt.hasControlPoint(e)){var i=pt.getLinkSourceBounds(this,this._network.zoomManager),n=pt.getLinkTargetBounds(this,this._network.zoomManager);pt.setParamsByControlPoint(t,i,n,e,this._element)}}},getLineLength:function(){return this._lineLength},hit:function(t,e){var i={x:t,y:e,width:0,height:0},n=this._network.getSelectionTolerance();return n&&n>0&&W.grow(i,n,n),!!W.intersects(this._viewRect,i)&&this.hitCanvasPoint(t,e)},intersects:function(t){if(1==R.vector.NodeUI.superClass.intersects.apply(this,arguments))return!0;if(0==W.intersects(t,this._viewRect))return!1;var e=this.getLinkPoints(),i=e.size();if(2==i)for(var n=0;n<i;n+=2){var s=e.get(n);if(n+1<i){var o=e.get(n+1);if(Me.intersectsLine(s.x,s.y,o.x,o.y,t.x,t.y,t.width,t.height))return!0}}return this.hitCanvasRect(t)},getAngle:function(){return!this._angle&&this._fromPoint&&this._toPoint&&(this._angle=W.getAngle(this._fromPoint,this._toPoint)),this._angle||0},getAbsoluteAngle:function(){var t=10,e=0,i=this._fromPoint,n=this._toPoint,s=n.x-i.x,o=n.y-i.y,r=180*Math.acos((s*t+o*e)/(Math.sqrt(t*t+e*e)*Math.sqrt(s*s+o*o)))/Math.PI;return r=i.y<=n.y?r:360-r,r=r%360*Math.PI/180},appendShadowBound:function(t,e){if(t.isShadowable()&&this._shadowColor&&!this._editAttachment){this._shadowXOffset>0?e.width+=this._shadowXOffset:(e.x+=this._shadowXOffset,e.width+=-this._shadowXOffset),this._shadowYOffset>0?e.height+=this._shadowYOffset:(e.y+=this._shadowYOffset,e.height+=-this._shadowYOffset);var i=this._shadowBlur;W.grow(e,i+1,i+1)}return e}}),R.vector.GroupUI=function(t,e){R.vector.GroupUI.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.GroupUI\",R.vector.NodeUI,{isEditable:function(){return!this._element.isExpanded()},paintBody:function(t){this._shapeRect?this._element.getStyle(\"group.expend.image\")?(R.vector.GroupUI.superClass.paintBody.apply(this,arguments),this._element.getStyle(\"group.expend.image.vector\")&&this.drawExpandedGroup(t)):this.drawExpandedGroup(t):R.vector.GroupUI.superClass.paintBody.apply(this,arguments)},validateBodyBounds:function(){if(this.getBodyRect(),this._shapeRect){var t=this.getPathRect(\"group\",!1),e=this.getStyle(\"group.deep\");W.grow(t,e+1,e+1),this.addBodyBounds(t)}else R.vector.GroupUI.superClass.validateBodyBounds.call(this)},getZoomBodyRect:function(){return this._element.isExpanded()?this.getBodyRect():R.vector.GroupUI.superClass.getZoomBodyRect.call(this)},getZoomViewRect:function(){return this._element.isExpanded()?this.getViewRect():R.vector.GroupUI.superClass.getZoomViewRect.call(this)},drawExpandedGroup:function(t){this.drawPath(t,\"group\",!1,this._element.getStyle(\"vector.outline.pattern\"));var e=this.getStyle(\"group.deep\"),i=this.getStyle(\"group.fill.color\");0!==e&&i&&\"rectangle\"===this.getStyle(\"group.shape\")&&Y.draw3DRect(t,i,e,this._shapeRect)},getChildrenRects:function(){return this._network.getGroupChildrenRects(this._element)},createBodyRect:function(){this._shapeRect=null;var t=this._element,e=this._network;if(t.isExpanded()){t.getChildren().forEach(function(t){var i=e.getElementUI(t);i&&i.validate()});var i=this.getChildrenRects();if(!i.isEmpty()){var n=t.getStyle(\"group.shape\"),s=Z[n];if(!s)throw\"Can not resolve group shape '\"+n+\"'\";this._shapeRect=s(i)}}return this._shapeRect?(W.addPadding(this._shapeRect,t,\"group.padding\",1),this._shapeRect):R.vector.GroupUI.superClass.createBodyRect.call(this)},appendShadowBound:function(t,e){if(t.isShadowable()&&this._shadowColor&&!this._editAttachment){this._shadowXOffset>0?e.width+=this._shadowXOffset:(e.x+=this._shadowXOffset,e.width+=-this._shadowXOffset),this._shadowYOffset>0?e.height+=this._shadowYOffset:(e.y+=this._shadowYOffset,e.height+=-this._shadowYOffset);var i=this._shadowBlur;W.grow(e,i+1,i+1)}return e}}),R.vector.ShapeNodeUI=function(t,e){R.vector.ShapeNodeUI.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.ShapeNodeUI\",R.vector.NodeUI,{getDefaultBodyRect:function(){return this._element._points.size()<2?null:this._reverseZoomPathRect()},drawDefaultBody:function(t){this._element._points.size()<2||(this.drawPath(t,\"vector\",!0,this._element.getStyle(\"vector.outline.pattern\"),this._getZoomPoints(),this._element._segments,this._element.getStyle(\"shapenode.closed\")),re.drawLinkArrow(this,t,W.getPointObject(this._element._points,this._element._segments)))},invalidateZoom:function(){this._zoomPoints=null,R.vector.LinkUI.superClass.invalidateZoom.call(this)},_getZoomPoints:function(){return this._zoomPoints=this._network.zoomManager._getShapeNodeZoomPoints(this,this._element._points),this._zoomPoints},_reverseZoomPathRect:function(){return this._network.zoomManager._reverseElementZoomRect(this,this.getZoomPathRect(\"vector\",!0))}}),R.vector.ShapeLinkUI=function(t,e){R.vector.ShapeLinkUI.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.ShapeLinkUI\",R.vector.LinkUI,{isEditable:function(){return!0},createLinkPoints:function(){var t=this.getFromPoint(),e=this.getToPoint(),i=new R.List,n=this.getStyle(\"shapelink.type\");i.add(t),null!=this._element._points&&this._element._points.size()>0&&i.addAll(this._network.zoomManager._getShapeLinkZoomPoints(this._element._points)),i.add(e);var s,o,r;if(\"lineto\"===n);else if(\"quadto\"===n){for(s=new R.List(i.get(0)),o=1,pointCount=i.size();o<pointCount;o++)o<pointCount-1?s.add(new R.List([i.get(o++),i.get(o)])):s.add(i.get(o));i=s}else if(\"cubicto\"===n){for(s=new R.List(i.get(0)),o=1,pointCount=i.size();o<pointCount;o++)o<pointCount-2?s.add(new R.List([i.get(o++),i.get(o++),i.get(o)])):o<pointCount-1?s.add(new R.List([i.get(o++),i.get(o)])):s.add(i.get(o));i=s}else{if(\"orthogonalto\"!==n)throw\"Can not resolve shapelink type '\"+n+\"'\";for(r=i.get(0),s=new R.List(r),o=1,pointCount=i.size();o<pointCount;o++)if(o<pointCount-1){var a=(g=D.clone(i.get(o))).x,h=g.y,l=a-r.x,c=h-r.y;Math.abs(l)>Math.abs(c)?(g.x=a,g.y=r.y):(g.x=r.x,g.y=h),r=g,s.add(r)}else s.add(i.get(o));i=s}var d,u,_,g,f,v=W.calculateLineLength(i)/2,m=i.size(),p=0,w=0;for(d=0;d<m;d++)if(g=i.get(d),0!=d){if((_=g)instanceof oe&&(_=_._as),_ instanceof Array?(f=W.calculateCurveLength(u,_,1),u=_[_.length-1]):(c=g.y-u.y,l=g.x-u.x,f=Math.sqrt(l*l+c*c),u=_),w+=f,p<=v&&w>=v){var y=v-p,A=i.get(d-1);A instanceof oe&&(A=A._as)instanceof Array&&(A=A[A.length-1]);var x=i.get(d),C=W.getPathInfo(x,A,y,0,-1).point;this._hotSpot=D.clone(C)}p=w}else u=g;return i},_growLinkJoinBounds:function(t,e){W.grow(t,3*e,3*e)}}),R.vector.GridUI=function(t,e){R.vector.GridUI.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.GridUI\",R.vector.NodeUI,{drawDefaultBody:function(t){this._element.getImage()?R.vector.GridUI.superClass.drawDefaultBody.apply(this,arguments):this.drawGridBody(t)},validateBodyBounds:function(){if(this._element.getImage())R.vector.GridUI.superClass.validateBodyBounds.call(this);else{var t=this.getBodyRect(),e=D.clone(t),i=this._element.getStyle(\"outer.width\");W.grow(e,i,i),this.appendShadowBound(this,e),this.addBodyBounds(e)}},_getZoomCellRect:function(t,e){var i=this._element.getCellRect(t,e),n=this._element.getRect(),s=n.x+n.width/2,o=n.y+n.height/2,r=this.getZoomBodyRect(),a=r.width/n.width,h=r.x+r.width/2,l=0==s?1:h/s;return{x:s*l+(i.x-s)*a,y:o*l+(i.y-o)*a,width:i.width*a,height:i.height*a}},drawGridBody:function(t){var e=this.getStyle(\"grid.fill\"),i=this.getStyle(\"grid.deep\"),n=this.getStyle(\"grid.cell.deep\");if(e||0!==i||0!==n){t.beginPath();var s=this.getZoomBodyRect(),o=this.getDyeColor(\"grid.fill.color\");if(this.setGlow(this,t),this.setShadow(this,t),e&&(t.fillStyle=o,t.rect(s.x,s.y,s.width,s.height),t.fill()),t.closePath(),this.clearShadow(t),t.beginPath(),0!=i&&Y.draw3DRect(t,o,i,s.x,s.y,s.width,s.height),t.closePath(),0!=n)for(var r=this.getStyle(\"grid.row.count\"),a=this.getStyle(\"grid.column.count\"),h=0;h<r;h++)for(var l=0;l<a;l++){var c=this._getZoomCellRect(h,l);null!=c&&(t.beginPath(),Y.draw3DRect(t,o,n,c.x,c.y,c.width,c.height),t.closePath())}}}}),R.vector.RotatableNodeUI=function(t,e){R.vector.RotatableNodeUI.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.RotatableNodeUI\",R.vector.NodeUI,{isEditable:function(){return!1},getDefaultBodyRect:function(){var t=this._element,e=D.getImageAsset(t.getImage()),i=this.getBodyRect();return e?(W.addPadding(i,this._element,\"image.padding\",1),i):i},drawDefaultBody:function(t){var e=this._element,i=D.getImageAsset(e.getImage());if(i){var n=this.getBodyRect();if(W.addPadding(n,this._element,\"image.padding\",1),i.getImage()){var s=this._element._getOrignalWidth(),o=this._element._getOrignalHeight(),r=this._element._getRotateRect();t.save(),t.translate(n.x-r.x+s/2,n.y-r.y+o/2),t.rotate(this._element._angle*Math.PI/180),t.drawImage(i.getImage(this._innerColor),-s/2,-o/2,s,o),t.restore()}else if(i.getSrc());else if(!i.getFunction())throw\"ImageAsset '\"+e.getImage()+\" ' is empty\"}}}),R.vector.HTMLNodeUI=function(t,e){R.vector.HTMLNodeUI.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.HTMLNodeUI\",R.vector.NodeUI,{checkAttachments:function(){R.vector.NodeUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var t=this._element.getStyle(\"attachment.label.style\");if(t&&\"none\"===t)R.vector.HTMLNodeUI.superClass.checkLabelAttachment.call(this);else{var e=this._network.getLabel(this._element);null!=e&&\"\"!==e?this._labelAttachment||(this._labelAttachment=new R.vector.HTMLLabelAttachment(this,xe.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)}},checkLabel2Attachment:function(){var t=this._element.getStyle(\"attachment.label2.style\");if(t&&\"none\"===t)R.vector.HTMLNodeUI.superClass.checkLabel2Attachment.call(this);else{var e=this._network.getLabel2(this._element);null!=e&&\"\"!==e?this._label2Attachment||(this._label2Attachment=new R.vector.HTMLLabel2Attachment(this,xe.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._label2Attachment)):this._label2Attachment&&(this.removeAttachment(this._label2Attachment),this._label2Attachment=null)}},checkAlarmAttachment:function(){var t=this._element.getStyle(\"attachment.alarm.style\");if(t&&\"none\"===t)R.vector.HTMLNodeUI.superClass.checkAlarmAttachment.call(this);else{var e=this._network.getAlarmLabel(this._element);null!=e&&\"\"!==e?this._alarmAttachment||(this._alarmAttachment=new R.vector.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)}},setAttachmentVisible:function(t){t?(this._labelAttachment&&this._labelAttachment.setVisibility(\"visible\"),this._label2Attachment&&this._label2Attachment.setVisibility(\"visible\"),this._alarmAttachment&&this._alarmAttachment.setVisibility(\"visible\")):(this._labelAttachment&&this._labelAttachment.setVisibility(\"hidden\"),this._label2Attachment&&this._label2Attachment.setVisibility(\"hidden\"),this._alarmAttachment&&this._alarmAttachment.setVisibility(\"hidden\"))},validateZIndex:function(t){this._labelAttachment&&this._labelAttachment.validateZIndex(t)}}),R.vector.HTMLLinkUI=function(t,e){R.vector.HTMLLinkUI.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.HTMLLinkUI\",R.vector.LinkUI,{checkAttachments:function(){R.vector.LinkUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var t=this._element.getStyle(\"attachment.label.style\");if(t&&\"none\"===t)R.vector.HTMLLinkUI.superClass.checkLabelAttachment.call(this);else{var e=this._network.getLabel(this._element);null!=e&&\"\"!==e?this._labelAttachment||(this._labelAttachment=new R.vector.HTMLLabelAttachment(this,xe.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)}},checkLabel2Attachment:function(){var t=this._element.getStyle(\"attachment.label2.style\");if(t&&\"none\"===t)R.vector.HTMLNodeUI.superClass.checkLabelAttachment.call(this);else{var e=this._network.getLabel2(this._element);null!=e&&\"\"!==e?this._label2Attachment||(this._label2Attachment=new R.vector.HTMLLabel2Attachment(this,xe.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._label2Attachment)):this._label2Attachment&&(this.removeAttachment(this._label2Attachment),this._label2Attachment=null)}},checkAlarmAttachment:function(){var t=this._element.getStyle(\"attachment.alarm.style\");if(t&&\"none\"===t)R.vector.HTMLLinkUI.superClass.checkAlarmAttachment.call(this);else{var e=this._network.getAlarmLabel(this._element);null!=e&&\"\"!==e?this._alarmAttachment||(this._alarmAttachment=new R.vector.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)}},setAttachmentVisible:function(t){t?(this._labelAttachment&&this._labelAttachment.setVisibility(\"visible\"),this._label2Attachment&&this._label2Attachment.setVisibility(\"visible\"),this._alarmAttachment&&this._alarmAttachment.setVisibility(\"visible\")):(this._labelAttachment&&this._labelAttachment.setVisibility(\"hidden\"),this._label2Attachment&&this._label2Attachment.setVisibility(\"hidden\"),this._alarmAttachment&&this._alarmAttachment.setVisibility(\"hidden\"))}}),R.vector.Attachment=function(t,e){this._ui=t,this._element=this._ui.getElement(),this._network=t.getNetwork(),this._showOnTop=e,e&&this._network._hitTestTopAttachmentList.add(this)},D.ext(\"twaver.vector.Attachment\",Object,{getElement:function(){return this._element},getElementUI:function(){return this._ui},getNetwork:function(){return this._network},isShowOnTop:function(){return!0===this._showOnTop},setShowOnTop:function(t){this._showOnTop=t},getStyle:function(t){return this._ui.getStyle(t)},getFont:function(t){return this._ui.getFont(t)},getViewRect:function(){return D.clone(this._viewRect)},getAlpha:function(){return 1},validate:function(){},paint:function(t){},getZoomViewRect:function(){return this._network.zoomManager._getAttachmentZoomOutLineRect(this,this._viewRect)},hit:function(t,e){return!!W.containsPoint(this.getZoomViewRect(),t,e)&&this.hitCanvasRect({x:t-1,y:e-1,width:2,height:2})},hitCanvasRect:function(t){var e=Me.getHitCanvas(t.width,t.height),i=Me.getCtx(e);i.save(),i.translate(-t.x,-t.y),this.paint(i);try{for(var n=i.getImageData(0,0,t.width,t.height),s=n.data,o=0;o<n.width;o++)for(var r=0;r<n.height;r++){if(0!==s[4*(r*n.width+o)+3])return i.restore(),!0}}catch(t){Me.disposeHitCanvas()}return i.restore(),!1},dispose:function(){this._network._hitTestTopAttachmentList.remove(this)},_rotatePoint:function(t,e,i){return W.createMatrix(e*Math.PI/180,i.x+i.width/2,i.y+i.height/2).transform(t)},_rotatePointList:function(t,e,i){var n=this,s=new R.List;return t.forEach(function(t){s.add(n._rotatePoint(t,e,i))}),s}}),R.vector.BasicAttachment=function(t,e){R.vector.BasicAttachment.superClass.constructor.call(this,t,e),this._roundRect={x:0,y:0,width:0,height:0},this._contentRect={x:0,y:0,width:0,height:0}},D.ext(\"twaver.vector.BasicAttachment\",R.vector.Attachment,{paint:function(t){R.vector.BasicAttachment.superClass.paint.apply(this,arguments);var e=this.isFill(),i=this.getOutlineWidth(),n=this._network.zoomManager._getAttachmentZoomOutLineRect(this,this._roundRect);if(this.getElementUI().setGlow(this,t),this.getElementUI().setShadow(this,t),i>0||e){if(Y.drawRoundRect(t,n.x,n.y,n.width,n.height,this.getCornerRadius()),this._network._debug&&Y.strokeRect(t,n,\"#C71585\"),this._pointers){var s=this._ui.getZoomPointers(this,this._pointers);t.moveTo(s[0].x,s[0].y),t.lineTo(s[1].x,s[1].y),t.lineTo(s[2].x,s[2].y)}if(t.closePath(),i>0&&(t.lineWidth=i,t.strokeStyle=this.getOutlineColor(),t.lineCap=this.getCap(),t.lineJoin=this.getJoin(),t.stroke()),e){var o=this.getFillColor(),r=this.getGradient();r?Y.fill(t,o,r,this.getGradientColor(),this._viewRect):t.fillStyle=o,t.fill()}}},validate:function(){R.vector.BasicAttachment.superClass.validate.call(this),this.calculateMeasure();var t=this.getOutlineWidth();(null==t||t<=0)&&(t=1),this._viewRect=W.getRect(this._pointers),this._viewRect=W.unionRect(this._viewRect,this._roundRect),t>0&&W.grow(this._viewRect,2*t,2*t),this._viewRect=this._ui.appendShadowBound(this,this._viewRect);if(this._element instanceof R.Link&&this._element.getStyle(\"link.label.rotatable\")){var e=this._viewRect.x+this._viewRect.width/2,i=this._viewRect.y+this._viewRect.height/2,n=Math.sqrt(this._viewRect.height*this._viewRect.height+this._viewRect.width*this._viewRect.width);this._viewRect={x:e-n,y:i-n,width:2*n,height:2*n}}},calculateMeasure:function(){var t=this.getContentWidth(),e=this.getContentHeight(),i=this.getCornerRadius(),n=this.getPointerLength(),s=this.getPointerWidth(),o=this.getPosition(),r=this.getXOffset(),a=this.getYOffset(),h=this._roundRect;h.width=t+i,h.height=e;var l;if(this._ui._element instanceof R.Link){var c,d=this._ui.getLinkPoints();c=this._ui.getLineLength?this._ui.getLineLength():this._ui._element.getLineLength(),Math.abs(r)>0&&Math.abs(r)<1?\"from\"===o?r*=c:\"to\"===o?r=c*(1-r):(r/=2,r+=.5,r*=c):\"from\"===o?r=r:\"to\"===o?r=c-r:r+=c/2;var u,_=W.calculatePointInfoAlongLine(d,!0,r,a),g=_.point;_.angle;u=\"from\"===o?this._ui.getFromPoint():\"to\"===o?this._ui.getToPoint():this._ui._hotSpot,r=g.x-u.x,a=g.y-u.y}if(n>0){var f=this.getDirection();l=this._network.getPosition(o,this._ui,null,r,a,!1);var v;if(\"aboveleft\"===f)h.y=l.y-n-h.height,h.x=l.x-(h.width-i),v=Math.max(l.x-s,l.x-(h.width-i)+i/2),this._pointers=[l,{x:l.x,y:l.y-n},{x:v,y:l.y-n}];else if(\"aboveright\"===f)h.y=l.y-n-h.height,h.x=l.x-i,v=Math.min(l.x+s,l.x-i+h.width-i/2),this._pointers=[l,{x:l.x,y:l.y-n},{x:v,y:l.y-n}];else if(\"belowleft\"===f)h.y=l.y+n,h.x=l.x-(h.width-i),v=Math.max(l.x-s,l.x-(h.width-i)+i/2),this._pointers=[l,{x:l.x,y:l.y+n},{x:v,y:l.y+n}];else if(\"belowright\"===f)h.y=l.y+n,h.x=l.x-i,v=Math.min(l.x+s,l.x-i+h.width-i/2),this._pointers=[l,{x:l.x,y:l.y+n},{x:v,y:l.y+n}];else if(\"leftabove\"===f)h.y=l.y+i-h.height,h.x=l.x-n-h.width,v=Math.max(l.y-s,l.y+i-h.height+i/2),this._pointers=[l,{x:l.x-n,y:l.y},{x:l.x-n,y:v}];else if(\"leftbelow\"===f)h.y=l.y-i,h.x=l.x-n-h.width,v=Math.min(l.y+s,l.y-i+h.height-i/2),this._pointers=[l,{x:l.x-n,y:l.y},{x:l.x-n,y:v}];else if(\"rightabove\"===f)h.y=l.y+i-h.height,h.x=l.x+n,v=Math.max(l.y-s,l.y+i-h.height+i/2),this._pointers=[l,{x:l.x+n,y:l.y},{x:l.x+n,y:v}];else if(\"rightbelow\"===f)h.y=l.y-i,h.x=l.x+n,v=Math.min(l.y+s,l.y-i+h.height-i/2),this._pointers=[l,{x:l.x+n,y:l.y},{x:l.x+n,y:v}];else if(\"above\"===f)h.y=l.y-n-h.height,h.x=l.x-h.width/2,v=Math.min(t/2,s/2),this._pointers=[l,{x:l.x-v,y:l.y-n},{x:l.x+v,y:l.y-n}];else if(\"below\"===f)h.y=l.y+n,h.x=l.x-h.width/2,v=Math.min(t/2,s/2),this._pointers=[l,{x:l.x-v,y:l.y+n},{x:l.x+v,y:l.y+n}];else if(\"left\"===f)h.y=l.y-h.height/2,h.x=l.x-n-h.width,v=Math.min(e/2,s/2),this._pointers=[l,{x:l.x-n,y:l.y+v},{x:l.x-n,y:l.y-v}];else{if(\"right\"!==f)throw\"Can not resolve '\"+f+\"' attachment direction\";h.y=l.y-h.height/2,h.x=l.x+n,v=Math.min(e/2,s/2),this._pointers=[l,{x:l.x+n,y:l.y+v},{x:l.x+n,y:l.y-v}]}}else l=this._network.getPosition(o,this._ui,{width:h.width,height:h.height},r,a,!1),h.x=l.x,h.y=l.y,this._pointers=null;this._contentRect.x=h.x+(h.width-t)/2,this._contentRect.y=h.y+(h.height-e)/2,this._contentRect.width=t,this._contentRect.height=e;var m=this.getPadding();0!=m&&W.grow(h,m,m),0!=(m=this.getPaddingLeft())&&(h.x-=m,h.width+=m),0!=(m=this.getPaddingRight())&&(h.width+=m),0!=(m=this.getPaddingTop())&&(h.y-=m,h.height+=m),0!=(m=this.getPaddingBottom())&&(h.height+=m),h.width<0&&(h.width=h.width,h.x-=h.width),h.height<0&&(h.height=-h.height,h.y-=h.height)},getContentWidth:function(){return R.Defaults.ATTACHMENT_CONTENT_WIDTH},getContentHeight:function(){return R.Defaults.ATTACHMENT_CONTENT_HEIGHT},getCornerRadius:function(){return R.Defaults.ATTACHMENT_CORNER_RADIUS},getPointerLength:function(){return R.Defaults.ATTACHMENT_POINTER_LENGTH},getPointerWidth:function(){return R.Defaults.ATTACHMENT_POINTER_WIDTH},getPosition:function(){return R.Defaults.ATTACHMENT_POSITION},getXOffset:function(){return R.Defaults.ATTACHMENT_XOFFSET},getYOffset:function(){return R.Defaults.ATTACHMENT_YOFFSET},getPadding:function(){return R.Defaults.ATTACHMENT_PADDING},getPaddingLeft:function(){return R.Defaults.ATTACHMENT_PADDING_LEFT},getPaddingRight:function(){return R.Defaults.ATTACHMENT_PADDING_RIGHT},getPaddingTop:function(){return R.Defaults.ATTACHMENT_PADDING_TOP},getPaddingBottom:function(){return R.Defaults.ATTACHMENT_PADDING_BOTTOM},getDirection:function(){return R.Defaults.ATTACHMENT_DIRECTION},isFill:function(){return R.Defaults.ATTACHMENT_FILL},getFillColor:function(){return R.Defaults.ATTACHMENT_FILL_COLOR},getGradient:function(){return R.Defaults.ATTACHMENT_GRADIENT},getGradientColor:function(){return R.Defaults.ATTACHMENT_GRADIENT_COLOR},getOutlineWidth:function(){return R.Defaults.ATTACHMENT_OUTLINE_WIDTH},getOutlineColor:function(){return R.Defaults.ATTACHMENT_OUTLINE_COLOR},getCap:function(){return R.Defaults.ATTACHMENT_CAP},getJoin:function(){return R.Defaults.ATTACHMENT_JOIN},isShadowable:function(){return R.Defaults.ATTACHMENT_SHADOWABLE},getRoundRect:function(){return D.clone(this._roundRect)},getContentRect:function(){return D.clone(this._contentRect)}}),R.vector.LabelAttachment=function(t,e){R.vector.LabelAttachment.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.LabelAttachment\",R.vector.BasicAttachment,{paint:function(t){var e=this._element instanceof R.Link&&this._element.getStyle(\"link.label.rotatable\");if(e){t.save();var i=this.getZoomViewRect(),n=i.x+i.width/2,s=i.y+i.height/2;t.translate(n,s),t.rotate(this._network.getElementUI(this._element).getAngle()),t.translate(-n,-s)}R.vector.LabelAttachment.superClass.paint.apply(this,arguments);var o=this._network.zoomManager,r=o._getAttachmentZoomRect(this,this._contentRect),a=this._element.getStyle(\"label.align\"),h=this._element&&this._element.getStyle(\"label.rotate.angle\");if(0!==h&&(t.save(),R.Util.rotateCanvas(t,this._contentRect,h)),o._drawText(this,t,this.text,r,this.font,this.getStyle(\"label.color\"),a,this.getStyle(\"label.linespacing\")),(e||0!==h)&&t.restore(),this._network._debug){var l=this._viewRect;Y.strokeRect(t,l,\"#AAABBB\")}},validate:function(){this.font=this.getFont(\"label.font\");var t=this.getLabel(),e=D.g.getTextSize(this.font,t,this.getStyle(\"label.linespacing\")),i=this.getMaxLength();0!==i&&e.width>i?(this.text=D.g.getCollapseTextInLength(this.font,t,i),this._textSize=D.g.getTextSize(this.font,this.text)):(this.text=t,this._textSize=e),R.vector.LabelAttachment.superClass.validate.call(this);var n=this._viewRect,s=this._element&&this._element.getStyle(\"label.rotate.angle\");if(0!==s){var o=new R.List;o.add({x:n.x,y:n.y}),o.add({x:n.x+n.width,y:n.y}),o.add({x:n.x+n.width,y:n.y+n.height}),o.add({x:n.x,y:n.y+n.height}),o=this._rotatePointList(o,s,n);var r=R.Util.getRect(o);this._viewRect=r}},getLabel:function(){return this._network.getLabel(this._element)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle(\"label.corner.radius\")},getPointerLength:function(){return this.getStyle(\"label.pointer.length\")},getPointerWidth:function(){return this.getStyle(\"label.pointer.width\")},getPosition:function(){return this.getStyle(\"label.position\")},getXOffset:function(){return this.getStyle(\"label.xoffset\")},getYOffset:function(){return this.getStyle(\"label.yoffset\")},getPadding:function(){return this.getStyle(\"label.padding\")},getPaddingLeft:function(){return this.getStyle(\"label.padding.left\")},getPaddingRight:function(){return this.getStyle(\"label.padding.right\")},getPaddingTop:function(){return this.getStyle(\"label.padding.top\")},getPaddingBottom:function(){return this.getStyle(\"label.padding.bottom\")},getDirection:function(){return this.getStyle(\"label.direction\")},isFill:function(){return this.getStyle(\"label.fill\")},getFillColor:function(){return this.getStyle(\"label.fill.color\")},getGradient:function(){return this.getStyle(\"label.gradient\")},getGradientColor:function(){return this.getStyle(\"label.gradient.color\")},getOutlineWidth:function(){return this.getStyle(\"label.outline.width\")},getOutlineColor:function(){return this.getStyle(\"label.outline.color\")},getCap:function(){return this.getStyle(\"label.cap\")},getJoin:function(){return this.getStyle(\"label.join\")},getAlpha:function(){return this.getStyle(\"label.alpha\")},getMaxLength:function(){return this.getStyle(\"label.maxlength\")},isShadowable:function(){return this.getStyle(\"label.shadowable\")}}),R.vector.Label2Attachment=function(t,e){R.vector.Label2Attachment.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.Label2Attachment\",R.vector.BasicAttachment,{paint:function(t){var e=this._element instanceof R.Link&&this._element.getStyle(\"link.label.rotatable\");if(e){t.save();var i=this.getZoomViewRect(),n=i.x+i.width/2,s=i.y+i.height/2;t.translate(n,s),t.rotate(this._network.getElementUI(this._element).getAngle()),t.translate(-n,-s)}R.vector.Label2Attachment.superClass.paint.apply(this,arguments);var o=this._network.zoomManager,r=o._getAttachmentZoomRect(this,this._contentRect),a=this._element.getStyle(\"label.align\"),h=this._element&&this._element.getStyle(\"label2.rotate.angle\");if(0!==h&&(t.save(),R.Util.rotateCanvas(t,this._contentRect,h)),o._drawText(this,t,this.text,r,this.font,this.getStyle(\"label2.color\"),a,this.getStyle(\"label2.linespacing\")),(e||0!==h)&&t.restore(),this._network._debug){var l=o.getAttachmentSizeZoom(this),c=r;c.width*=l,c.height*=l,Y.strokeRect(t,c,\"#AAABBB\")}},validate:function(){this.font=this.getFont(\"label2.font\");var t=this.getLabel(),e=D.g.getTextSize(this.font,t),i=this.getMaxLength();0!==i&&e.width>i?(this.text=D.g.getCollapseTextInLength(this.font,t,i),this._textSize=D.g.getTextSize(this.font,this.text)):(this.text=t,this._textSize=e),R.vector.LabelAttachment.superClass.validate.call(this);var n=this._viewRect,s=this._element&&this._element.getStyle(\"label2.rotate.angle\");if(0!==s){var o=new R.List;o.add({x:n.x,y:n.y}),o.add({x:n.x+n.width,y:n.y}),o.add({x:n.x+n.width,y:n.y+n.height}),o.add({x:n.x,y:n.y+n.height}),o=this._rotatePointList(o,s,n);var r=R.Util.getRect(o);this._viewRect=r}},getLabel:function(){return this._network.getLabel2(this._element)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle(\"label2.corner.radius\")},getPointerLength:function(){return this.getStyle(\"label2.pointer.length\")},getPointerWidth:function(){return this.getStyle(\"label2.pointer.width\")},getPosition:function(){return this.getStyle(\"label2.position\")},getXOffset:function(){return this.getStyle(\"label2.xoffset\")},getYOffset:function(){return this.getStyle(\"label2.yoffset\")},getPadding:function(){return this.getStyle(\"label2.padding\")},getPaddingLeft:function(){return this.getStyle(\"label2.padding.left\")},getPaddingRight:function(){return this.getStyle(\"label2.padding.right\")},getPaddingTop:function(){return this.getStyle(\"label2.padding.top\")},getPaddingBottom:function(){return this.getStyle(\"label2.padding.bottom\")},getDirection:function(){return this.getStyle(\"label2.direction\")},isFill:function(){return this.getStyle(\"label2.fill\")},getFillColor:function(){return this.getStyle(\"label2.fill.color\")},getGradient:function(){return this.getStyle(\"label2.gradient\")},getGradientColor:function(){return this.getStyle(\"label2.gradient.color\")},getOutlineWidth:function(){return this.getStyle(\"label2.outline.width\")},getOutlineColor:function(){return this.getStyle(\"label2.outline.color\")},getCap:function(){return this.getStyle(\"label2.cap\")},getJoin:function(){return this.getStyle(\"label2.join\")},getAlpha:function(){return this.getStyle(\"label2.alpha\")},getMaxLength:function(){return this.getStyle(\"label2.maxlength\")},isShadowable:function(){return this.getStyle(\"label2.shadowable\")}}),R.vector.AlarmAttachment=function(t,e){R.vector.AlarmAttachment.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.AlarmAttachment\",R.vector.BasicAttachment,{paint:function(t){R.vector.AlarmAttachment.superClass.paint.apply(this,arguments);var e=this._network.zoomManager,i=e._getAttachmentZoomRect(this,this._contentRect);e._drawText(this,t,this.text,i,this.font,this.getStyle(\"alarm.color\"))},validate:function(){this.font=this.getFont(\"alarm.font\"),this.text=this._network.getAlarmLabel(this._element),this._textSize=Y.getTextSize(this.font,this.text),this._fillColor=this._network.getAlarmFillColor(this._element),R.vector.AlarmAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle(\"alarm.corner.radius\")},getPointerLength:function(){return this.getStyle(\"alarm.pointer.length\")},getPointerWidth:function(){return this.getStyle(\"alarm.pointer.width\")},getPosition:function(){return this.getStyle(\"alarm.position\")},getXOffset:function(){return this.getStyle(\"alarm.xoffset\")},getYOffset:function(){return this.getStyle(\"alarm.yoffset\")},getPadding:function(){return this.getStyle(\"alarm.padding\")},getPaddingLeft:function(){return this.getStyle(\"alarm.padding.left\")},getPaddingRight:function(){return this.getStyle(\"alarm.padding.right\")},getPaddingTop:function(){return this.getStyle(\"alarm.padding.top\")},getPaddingBottom:function(){return this.getStyle(\"alarm.padding.bottom\")},getDirection:function(){return this.getStyle(\"alarm.direction\")},isFill:function(){return null!=this._fillColor},getFillColor:function(){return this._fillColor},getGradient:function(){return this.getStyle(\"alarm.gradient\")},getGradientColor:function(){return this.getStyle(\"alarm.gradient.color\")},getOutlineWidth:function(){return this.getStyle(\"alarm.outline.width\")},getOutlineColor:function(){return this.getStyle(\"alarm.outline.color\")},getCap:function(){return this.getStyle(\"alarm.cap\")},getJoin:function(){return this.getStyle(\"alarm.join\")},getAlpha:function(){return this.getStyle(\"alarm.alpha\")},isShadowable:function(){return this.getStyle(\"alarm.shadowable\")}}),R.vector.LinkHandlerAttachment=function(t,e){R.vector.LinkHandlerAttachment.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.LinkHandlerAttachment\",R.vector.BasicAttachment,{paint:function(t){var e=this._network.zoomManager;R.vector.LinkHandlerAttachment.superClass.paint.apply(this,arguments);var i=e._getAttachmentZoomRect(this,this._contentRect);e._drawText(this,t,this.linkHandlerLabel,i,this.linkHandlerFont,this.getStyle(\"link.handler.color\"))},validate:function(){this.linkHandlerFont=this.getFont(\"link.handler.font\"),this.linkHandlerLabel=this._network.getLinkHandlerLabel(this._element),this._textSize=Y.getTextSize(this.linkHandlerFont,this.linkHandlerLabel),R.vector.LinkHandlerAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle(\"link.handler.corner.radius\")},getPointerLength:function(){return this.getStyle(\"link.handler.pointer.length\")},getPointerWidth:function(){return this.getStyle(\"link.handler.pointer.width\")},getPosition:function(){return this.getStyle(\"link.handler.position\")},getXOffset:function(){return this.getStyle(\"link.handler.xoffset\")},getYOffset:function(){return this.getStyle(\"link.handler.yoffset\")},getPadding:function(){return this.getStyle(\"link.handler.padding\")},getPaddingLeft:function(){return this.getStyle(\"link.handler.padding.left\")},getPaddingRight:function(){return this.getStyle(\"link.handler.padding.right\")},getPaddingTop:function(){return this.getStyle(\"link.handler.padding.top\")},getPaddingBottom:function(){return this.getStyle(\"link.handler.padding.bottom\")},getDirection:function(){return this.getStyle(\"link.handler.direction\")},isFill:function(){return this.getStyle(\"link.handler.fill\")},getFillColor:function(){return this.getStyle(\"link.handler.fill.color\")},getGradient:function(){return this.getStyle(\"link.handler.gradient\")},getGradientColor:function(){return this.getStyle(\"link.handler.gradient.color\")},getOutlineWidth:function(){return this.getStyle(\"link.handler.outline.width\")},getOutlineColor:function(){return this.getStyle(\"link.handler.outline.color\")},getCap:function(){return this.getStyle(\"link.handler.cap\")},getJoin:function(){return this.getStyle(\"link.handler.join\")},getAlpha:function(){return this.getStyle(\"link.handler.alpha\")},isShadowable:function(){return this.getStyle(\"link.handler.shadowable\")}}),R.vector.IconsAttachment=function(t,e){R.vector.IconsAttachment.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.IconsAttachment\",R.vector.Attachment,{isShadowable:function(){return R.Defaults.ATTACHMENT_SHADOWABLE},validate:function(){if(R.vector.IconsAttachment.superClass.validate.call(this),this.iconsNames=this._network.getIconsNames(this._element),this.iconsNames&&0!=this.iconsNames.length){var t=this._makeGroup(this.iconsNames),e=this._makeGroup(this._network.getIconsColors(this._element)),n=this._network.zoomManager;len=t.length,this.iconsOrientation=this._makeArray(this._element.getStyle(\"icons.orientation\"),len,\"right\"),this.iconsPosition=this._makeArray(this._element.getStyle(\"icons.position\"),len,\"topleft.bottomright\"),this.iconsXoffset=this._makeArray(this._element.getStyle(\"icons.xoffset\"),len,0),this.iconsYoffset=this._makeArray(this._element.getStyle(\"icons.yoffset\"),len,0),this.iconsXgap=this._makeArray(this._element.getStyle(\"icons.xgap\"),len,1),this.iconsYgap=this._makeArray(this._element.getStyle(\"icons.ygap\"),len,1),this.locations=[],this.iconsSizes=[],this.iconsOrientations=[];var s,o;for(i=0;i<len;i++){var r=t[i],a=this.iconsOrientation[i]||\"right\",h=this.iconsPosition[i]||\"topleft.bottomright\",l=this.iconsXgap[i]||1,c=this.iconsYgap[i]||1,d=this.iconsXoffset[i]||0,u=this.iconsYoffset[i]||0;if(this._ui._element instanceof R.Link){var _,g=this._ui.getLinkPoints();_=this._ui.getLineLength?this._ui.getLineLength():this._ui._element.getLineLength(),Math.abs(d)>0&&Math.abs(d)<1?\"from\"===h?d*=_:\"to\"===h?d=_*(1-d):(d/=2,d+=.5,d*=_):\"from\"===h?d=d:\"to\"===h?d=_-d:d+=_/2;var f,v=W.calculatePointInfoAlongLine(g,!0,d,u),m=v.point;v.angle;f=\"from\"===h?this._ui.getFromPoint():\"to\"===h?this._ui.getToPoint():this._ui._hotSpot,d=m.x-f.x,u=m.y-f.y}o=null,(s=this._getIconsSize(r,a,l,c,n))&&(o=this._network.getPosition(h,this._ui,s,d,u),this._iconLocation=o,\"top\"===a?o.y+=s.height:\"left\"===a&&(o.x+=s.width)),this.locations.push(o),this.iconsSizes.push(s),this.iconsOrientations.push(a)}var p=null;for(i=0;i<this.locations.length;i++)o=this.locations[i],s=this.iconsSizes[i],a=this.iconsOrientations[i],null!=o&&(p=null==p?\"top\"===a?{x:o.x,y:o.y-s.height,width:s.width,height:s.height}:\"left\"===a?{x:o.x-s.width,y:o.y,width:s.width,height:s.height}:{x:o.x,y:o.y,width:s.width,height:s.height}:\"top\"===a?W.unionRect(p,{x:o.x,y:o.y-s.height,width:s.width,height:s.height}):\"left\"===a?W.unionRect(p,{x:o.x-s.width,y:o.y,width:s.width,height:s.height}):W.unionRect(p,{x:o.x,y:o.y,width:s.width,height:s.height}));this._viewRect=n?p||this.getElementUI().getViewRect():p||{x:this._element.getLocation().x,y:this._element.getLocation().y,width:0,height:0},this.iconsGroups=t,this.colorGroups=e;var w=this._element instanceof R.Link&&this._element.getStyle(\"link.icons.rotatable\");for(i=0;i<len;i++)if(w instanceof Array&&w[i]&&this._viewRect){var y=this._viewRect.x+this._viewRect.width/2,A=this._viewRect.y+this._viewRect.height/2,x=Math.sqrt(this._viewRect.height*this._viewRect.height+this._viewRect.width*this._viewRect.width);this._viewRect={x:y-x/2,y:A-x/2,width:x,height:x}}}},_makeGroup:function(t){if(!Array.isArray(t))return[[t]];var e,i,n,s=[],o=!1,r=t.length;for(e=0;e<r;e++)i=t[e],Array.isArray(i)?(o=!0,s.push(i)):(n=[i],s.push(n));return o||(s.length=0,s.push(t)),s},_makeArray:function(t,e,i){if(Array.isArray(t))return t;for(var n=[],s=0;s<e;s++)n.push(t||i);return n},paint:function(t){if(R.vector.IconsAttachment.superClass.paint.apply(this,arguments),this.iconsNames&&0!=this.iconsNames.length&&this.locations){var e,i,n,s,o,r,a,h,l=this._network.zoomManager;for(e=0;e<this.iconsGroups.length;e++)if(i=this.locations[e]){w=i.x,y=i.y,s=this.iconsGroups[e],o=this.colorGroups[e],r=this.iconsOrientation[e],a=this.iconsXgap[e]||1,h=this.iconsYgap[e]||1,n=0;for(var c in s){var d=null,u=null;o&&o.length>n&&(u=o[n++]);var _=D.getImageAsset(s[c]);if(null!=_){if(l&&this._ui instanceof R.vector.GroupUI&&this._ui._shapeRect){var g=l.getAttachmentSizeZoom(this),f=_.getWidth()*g,v=_.getHeight()*g;if(\"right\"===r)w+=(d={x:w,y:y,width:f,height:v}).width+a;else if(\"left\"===r)w-=(d={x:w-f,y:y,width:f,height:v}).width+a;else if(\"top\"===r)y-=(d={x:w,y:y-v,width:f,height:v}).height+h;else{if(\"bottom\"!==r)throw\"Can not resolve '\"+r+\"' orientation\";y+=(d={x:w,y:y,width:f,height:v}).height+h}}else{if(\"right\"===r)w+=(d={x:w,y:y,width:_.getWidth(),height:_.getHeight()}).width+a;else if(\"left\"===r)w-=(d={x:w-_.getWidth(),y:y,width:_.getWidth(),height:_.getHeight()}).width+a;else if(\"top\"===r)y-=(d={x:w,y:y-_.getHeight(),width:_.getWidth(),height:_.getHeight()}).height+h;else{if(\"bottom\"!==r)throw\"Can not resolve '\"+r+\"' orientation\";y+=(d={x:w,y:y,width:_.getWidth(),height:_.getHeight()}).height+h}d=l._getAttachmentZoomOutLineRect(this,d)}var m=this._element instanceof R.Link&&this._element.getStyle(\"link.icons.rotatable\");if(m instanceof Array&&m[e]){t.save();var p=d,w=p.x+p.width/2,y=p.y+p.height/2;t.translate(w,y),t.rotate(this._network.getElementUI(this._element).getAbsoluteAngle()),t.translate(-w,-y),Dt(t,_.getImage(u,d.width,d.height),u,d,this._element,this._network),t.restore()}else Dt(t,_.getImage(u,d.width,d.height),u,d,this._element,this._network);if(this._network._debug){d=this._viewRect;Y.strokeRect(t,d,\"#FCFC00\",1),Y.strokeRect(t,d,\"#FCFC00\",1)}}}}}},_getIconsSize:function(t,e,i,n,s){var o=0,r=0,a=null,h=null,l=null;for(var c in t)if(h=D.getImageAsset(t[c])){if(\"right\"===e)o+=(a={x:o,y:r,width:h.getWidth(),height:h.getHeight()}).width+i;else if(\"left\"===e)o-=(a={x:o-h.getWidth(),y:r,width:h.getWidth(),height:h.getHeight()}).width+i;else if(\"top\"===e)r-=(a={x:o,y:r-h.getHeight(),width:h.getWidth(),height:h.getHeight()}).height+n;else{if(\"bottom\"!==e)throw\"Can not resolve '\"+e+\"' orientation\";r+=(a={x:o,y:r,width:h.getWidth(),height:h.getHeight()}).height+n}l=null==l?D.clone(a):W.unionRect(l,a)}return l?s&&this._ui instanceof R.vector.GroupUI&&this._ui._shapeRect?{width:Math.abs(l.width)*s.getAttachmentSizeZoom(this),height:Math.abs(l.height)*s.getAttachmentSizeZoom(this)}:{width:Math.abs(l.width),height:Math.abs(l.height)}:null}}),R.vector.EditAttachment=function(t,e){R.vector.EditAttachment.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.EditAttachment\",R.vector.Attachment,{paint:function(t){R.vector.EditAttachment.superClass.paint.apply(this,arguments),this.paintResizingPoints(t),this.paintEditPoints(t),this.paintRotatePoints(t)},paintResizingPoints:function(t){var e=this.resizingPoints.size();if(!(e<=0)){var i=this._element.getStyle(\"edit.physicalZoom\")?1:this._network.getGraphicsZoom(),n=this.resizePointSize/i,s=2*n,o=2*n,r=this._network.getResizePointFillColor(),a=this._network.getResizePointOutlineWidth()/i,h=this._network.getResizePointOutlineColor(),l=this._element.getAngle(),c=this._network.zoomManager,d=c._getElementZoomRect(this.getElementUI(),this._element.getOriginalRect());t.lineWidth=a;for(var u=this.resizingPoints,_=0;_<e;_++){var g=u.get(_),f={x:g.x-n,y:g.y-n,width:2*n,height:2*n},v=this._getRotateRect(f,l,{x:d.x+d.width/2,y:d.y+d.height/2});t.save(),R.Util.rotateCanvas(t,v,l),Me.rect(t,v.x,v.y,s,o),t.restore()}if(t.fillStyle=r,t.strokeStyle=h,t.fill(),t.stroke(),this._network._debug){var m=this.getViewRect(\"resize\");Y.strokeRect(t,m,\"#CCDDCC\");m=c._getElementZoomRect(this.getElementUI(),this.getElementUI()._viewRect);Y.strokeRect(t,m,\"#FD7766\")}}},paintEditPoints:function(t){var e=this.editPoints.size();if(!(e<=0)){var i=this._element.getStyle(\"edit.physicalZoom\")?1:this._network.getGraphicsZoom(),n=this._network.getEditPointOutlineColor(),s=this._network.getEditPointFillColor(),o=this._network.getEditPointOutlineWidth()/i;t.beginPath(),t.lineWidth=o;for(var r=this.editPoints,a=0;a<e;a++){var h=r.get(a);t.beginPath(),Me.circle(t,h.x,h.y,this.editPointSize,s,n),t.closePath()}if(this._network._debug){var l=this.getViewRect(\"edit\");Y.strokeRect(t,l,\"#AAABBC\")}}},paintRotatePoints:function(t){var e=this.rotatePoints.size();if(!(e<=0)){var i=this._element.getStyle(\"edit.physicalZoom\")?1:this._network.getGraphicsZoom(),n=this._network.getRotatePointOutlineColor(),s=this._network.getRotatePointFillColor(),o=this._network.getRotatePointOutlineWidth()/i;t.beginPath(),t.lineWidth=o;for(var r=this.rotatePoints,a=0;a<e;a++){var h=r.get(a);t.beginPath(),Me.circle(t,h.x,h.y,this.rotatePointSize/i,s,n),t.closePath(),t.beginPath()}if(this._network._debug){var l=this.getViewRect(\"rotate\");Y.strokeRect(t,l,\"green\")}}},getViewRect:function(t){if(t){if(\"resize\"===t)return this._resizeRect;if(\"rotate\"===t)return this._rotateRect;if(\"edit\"===t)return this._editRect}return this._viewRect||{x:0,y:0,width:0,height:0}},validate:function(){R.vector.EditAttachment.superClass.validate.call(this);var t=this._network.getGraphicsZoom();this.editPointSize=this._network.getEditPointSize(),this.resizePointSize=this._network.getResizePointSize(),this.rotatePointSize=this._network.getRotatePointSize(),this.resizingPoints=new R.List,this.editPoints=new R.List,this.rotatePoints=new R.List,this._element instanceof R.Node&&this._addResizingPoint(this._element),!(this._network.isRotatable(this._element)&&this._element instanceof Pe)||this._element instanceof R.ShapeNode||this._element instanceof R.Grid||this._element instanceof R.Group||this._addRotatePoint(this._element),this._element instanceof R.ShapeNode&&(this._addResizingPoint(this._element),this._addShapeNodePoint(this._element)),this._ui instanceof R.vector.ShapeLinkUI&&this._addShapeLinkPoints(this._element),this._ui instanceof R.vector.LinkUI&&this._addLinkControlPoint(this._ui);var e=this._network.getResizePointOutlineWidth()/t,i=this.getElementUI().getZoomBodyRect(),n=2*Math.sqrt(2);if(this._resizeOffset=(this.resizePointSize+e+1)*n,W.grow(i,this._resizeOffset,this._resizeOffset),this._resizeRect=i,e=this._network.getEditPointOutlineWidth()/t,this.editPoints.size()>0){var s=W.getRect(this.editPoints);W.grow(s,2*this.editPointSize+2*e),i=W.unionRect(i,s)}this._editRect=s,e=this._network.getRotatePointOutlineWidth()/t;var o=this.rotatePointSize/t;if(this.rotatePoints.size()>0){var r=this.rotatePoints.get(0),a={x:r.x-o-e-1,y:r.y-o-e-1,width:2*o+2*e+2,height:2*o+2*e+2};i=W.unionRect(i,a),this._rotateRect=a}this._viewRect=i},_addResizingPoint:function(t){var e=this._network.zoomManager._getElementZoomRect(this.getElementUI(),t.getOriginalRect());if(e){if(!(this._network.getResizePointSize()<=0)){var i=new oe([{x:e.x,y:e.y},{x:e.x+e.width/2,y:e.y},{x:e.x+e.width,y:e.y},{x:e.x,y:e.y+e.height/2},{x:e.x+e.width,y:e.y+e.height/2},{x:e.x,y:e.y+e.height},{x:e.x+e.width/2,y:e.y+e.height},{x:e.x+e.width,y:e.y+e.height}]),n=this._network.getResizePointOutlineWidth(),s=this._network.getResizePointOutlineColor(),o=this._network.getResizePointFillColor();this._addPoints(t.getRect(),i,n,s,o,!0)}}},_addRotatePoint:function(t){var e=this._network.zoomManager._getElementZoomRect(this.getElementUI(),t.getOriginalRect());if(e){var i=this._network.getRotatePointSize()/this._network.getGraphicsZoom();if(!(i<=0)){var n=2*i,s=new R.List([{x:e.x+e.width/2,y:e.y-this._network.getRotatePointOffset()/this._network.getGraphicsZoom()-i}]),o=t.getAngle();0!=o&&(s=this._rotatePointList(s,o,e));var r=s.get(0),a={x:r.x-n/2,y:r.y-n/2,width:n,height:n},h=this._network.getRotatePointOutlineWidth(),l=this.rotatePointSize+h;W.grow(e,l,l);W.unionRect(t.getRect(),a);this.rotatePoints=s}}},_addShapeNodePoint:function(t){var e=this._network.zoomManager._getShapeNodeZoomPoints(this.getElementUI(),t.getPoints());this._addEditPoints(e)},_addShapeLinkPoints:function(t){var e=this._network.zoomManager._getShapeLinkZoomPoints(t.getPoints());this._addEditPoints(e)},_addLinkControlPoint:function(t){var e=new R.List;if(e.add({x:t.getFromPoint().x,y:t.getFromPoint().y}),e.add({x:t.getToPoint().x,y:t.getToPoint().y}),pt.isOrthogonalLink(t._element)&&t.getControlPoint()){var i=t.getControlPoint();i&&e.add(i)}var n=this.editPoints.size();if(n>0)for(var s=0;s<n;s++)e.add(this.editPoints.get(s));this._addEditPoints(e)},_addEditPoints:function(t){var e=W.getRect(t);if(e){if(!(this._network.getEditPointSize()<=0)){var i=this._network.getEditPointOutlineWidth();this._addPoints(e,t,i,!1)}}},_addPoints:function(t,e,i,n,s,o){var r=o?this._network.getResizePointSize():this._network.getEditPointSize();if(!(r<0)){var a=r+i;W.grow(t,a,a),1==o?this.resizingPoints=e:this.editPoints=e}},_rotatePoint:function(t,e,i){return W.createMatrix(e*Math.PI/180,i.x+i.width/2,i.y+i.height/2).transform(t)},_rotatePointList:function(t,e,i){var n=this,s=new R.List;return t.forEach(function(t){s.add(n._rotatePoint(t,e,i))}),s},_getRotateRect:function(t,e,i){var n=W.createMatrix(e*Math.PI/180,i.x,i.y),s={x:t.x+t.width/2,y:t.y+t.height/2},o=n.transform(s),r=new R.List([{x:o.x-t.width/2,y:o.y-t.height/2},{x:o.x+t.width/2,y:o.y-t.height/2},{x:o.x+t.width/2,y:o.y+t.height/2},{x:o.x-t.width/2,y:o.y+t.height/2}]);return W.getRect(r)}}),R.vector.HTMLLabelAttachment=function(t,e){R.vector.HTMLLabelAttachment.superClass.constructor.call(this,t,e),this._triangleDiv=R.Util.createDiv(),this._roundDiv=R.Util.createDiv(),this._contentDiv=R.Util.createDiv();this._network.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},D.ext(\"twaver.vector.HTMLLabelAttachment\",R.vector.LabelAttachment,{validate:function(){var t=this._element.getStyle(\"attachment.zIndex\");this.validateZIndex(t);var e=this._element.getStyle(\"attachment.pointer.events\");R.Util.setCSSStyle(this._triangleDiv,\"pointer-events\",e),R.Util.setCSSStyle(this._contentDiv,\"pointer-events\",e),R.Util.setCSSStyle(this._triangleDiv,\"border-style\",\"solid\"),R.Util.setCSSStyle(this._contentDiv,\"white-space\",\"nowrap\");this.getFont(\"label.font\");var i=this.getLabel();i!==this.text&&(this.text&&(\"object\"==typeof this.text?window.jquery?window.jquery(this.text).remove():this._contentDiv.removeChild(this.text):this._contentDiv.innerHTML=\"\"),i&&(\"object\"==typeof i?window.jquery?window.jquery(this._contentDiv).append(i):this._contentDiv.appendChild(i):this._contentDiv.innerHTML=i),this.text=i),this._contentDiv.style.visibility=\"hidden\",R.vector.HTMLLabelAttachment.superClass.validate.call(this)},validateZIndex:function(t){this._roundDiv.style.zIndex=t+this._network.getElementBox().getDatas().indexOf(this._element)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(R.Util.getCSSStyle(this._contentDiv.firstChild,\"width\"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(R.Util.getCSSStyle(this._contentDiv.firstChild,\"height\"))},paint:function(t){var e=this.isFill(),i=this.getOutlineWidth(),n=this._contentRect;if(this.getElementUI().setGlow(this,t),this.getElementUI().setShadow(this,t),i>0||e){if(Y.drawRoundRect(t,n.x,n.y,n.width,n.height,this.getCornerRadius()),this._pointers){var s=this._ui.getZoomPointers(this,this._pointers);t.moveTo(s[0].x,s[0].y),t.lineTo(s[1].x,s[1].y),t.lineTo(s[2].x,s[2].y)}if(t.closePath(),i>0&&(t.lineWidth=i,t.strokeStyle=this.getOutlineColor(),t.lineCap=this.getCap(),t.lineJoin=this.getJoin(),t.stroke()),e){var o=this.getFillColor(),r=this.getGradient();r?Y.fill(t,o,r,this.getGradientColor(),this._viewRect):t.fillStyle=o,t.fill()}}this.getFont(\"label.font\"),this.getLabel();var a=this._network.getViewRect().x,h=this._network.getViewRect().y,l=this._network.getZoom(),c=this._contentRect.x+this._contentRect.width/2,d=this._contentRect.y+this._contentRect.height/2,u=c*l-a-this._contentDiv.offsetWidth/2*l+\"px\",_=d*l-h-this._contentDiv.offsetHeight/2*l+\"px\";this._contentDiv.style.left=u,this._contentDiv.style.top=_,V.isFirefox?(R.Util.setCSSStyle(this._contentDiv,\"-moz-transform\",\"scale(\"+l+\")\"),R.Util.setCSSStyle(this._contentDiv,\"-moz-transform-origin\",\"0 0\")):V.isOpera?(R.Util.setCSSStyle(this._contentDiv,\"-o-transform\",\"scale(\"+l+\")\"),R.Util.setCSSStyle(this._contentDiv,\"-o-transform-origin\",\"0 0\")):V.isChrome||V.isSafari?(R.Util.setCSSStyle(this._contentDiv,\"-webkit-transform\",\"scale(\"+l+\")\"),R.Util.setCSSStyle(this._contentDiv,\"-webkit-transform-origin\",\"0 0\")):V.isIE?(R.Util.setCSSStyle(this._contentDiv,\"-ms-transform\",\"scale(\"+l+\")\"),R.Util.setCSSStyle(this._contentDiv,\"-ms-transform-origin\",\"0 0\")):(R.Util.setCSSStyle(this._contentDiv,\"transform\",\"scale(\"+l+\")\"),R.Util.setCSSStyle(this._contentDiv,\"transform-origin\",\"0 0\")),this._network._debug&&(Y.strokeRect(t,this._contentRect,\"blue\"),Y.strokeRect(t,this._roundRect,\"red\"),Y.strokeRect(t,this._viewRect,\"green\"));if(this._element instanceof R.Link&&this._element.getStyle(\"link.label.rotatable\")){var g=this.getZoomViewRect(),f=(g.x,g.width,g.y,g.height,180*this._network.getElementUI(this._element).getAbsoluteAngle()/Math.PI);this._contentDiv.offsetWidth,this._contentDiv.offsetHeight;V.isFirefox?R.Util.setCSSStyle(this._contentDiv,\"-moz-transform\",\"translate(0px,0px) rotate(\"+f+\"deg) scale(\"+l+\")\"):V.isOpera?R.Util.setCSSStyle(this._contentDiv,\"-o-transform\",\"translate(0px,0px) rotate(\"+f+\"deg) scale(\"+l+\")\"):V.isChrome||V.isSafari?R.Util.setCSSStyle(this._contentDiv,\"-webkit-transform\",\"translate(0px, 0px) rotate(\"+f+\"deg) scale(\"+l+\")\"):V.isIE?R.Util.setCSSStyle(this._contentDiv,\"-ms-transform\",\"translate(0px,0px) rotate(\"+f+\"deg) scale(\"+l+\")\"):R.Util.setCSSStyle(this._contentDiv,\"transform\",\"translate(0px,0px) rotate(\"+f+\"deg) scale(\"+l+\")\")}},setVisibility:function(t){this._contentDiv.style.visibility=t},dispose:function(){this._network.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv}}),R.vector.HTMLLabel2Attachment=function(t,e){R.vector.HTMLLabel2Attachment.superClass.constructor.call(this,t,e),this._triangleDiv=R.Util.createDiv(),this._roundDiv=R.Util.createDiv(),this._contentDiv=R.Util.createDiv();this._network.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},D.ext(\"twaver.vector.HTMLLabel2Attachment\",R.vector.LabelAttachment,{validate:function(){var t=this._element.getStyle(\"attachment.zIndex\");this.validateZIndex(t);var e=this._element.getStyle(\"attachment.pointer.events\");R.Util.setCSSStyle(this._triangleDiv,\"pointer-events\",e),R.Util.setCSSStyle(this._contentDiv,\"pointer-events\",e),R.Util.setCSSStyle(this._triangleDiv,\"border-style\",\"solid\"),R.Util.setCSSStyle(this._contentDiv,\"white-space\",\"nowrap\");this.getFont(\"label2.font\");var i=this.getLabel();i!==this.text&&(this.text&&(\"object\"==typeof this.text?window.jquery?window.jquery(this.text).remove():this._contentDiv.removeChild(this.text):this._contentDiv.innerHTML=\"\"),i&&(\"object\"==typeof i?window.jquery?window.jquery(this._contentDiv).append(i):this._contentDiv.appendChild(i):this._contentDiv.innerHTML=i),this.text=i),this._contentDiv.style.visibility=\"hidden\",R.vector.HTMLLabelAttachment.superClass.validate.call(this)},validateZIndex:function(t){this._roundDiv.style.zIndex=t+this._network.getElementBox().getDatas().indexOf(this._element)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(R.Util.getCSSStyle(this._contentDiv.firstChild,\"width\"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(R.Util.getCSSStyle(this._contentDiv.firstChild,\"height\"))},paint:function(t){var e=this.isFill(),i=this.getOutlineWidth(),n=this._contentRect;if(this.getElementUI().setGlow(this,t),this.getElementUI().setShadow(this,t),i>0||e){if(Y.drawRoundRect(t,n.x,n.y,n.width,n.height,this.getCornerRadius()),this._pointers){var s=this._ui.getZoomPointers(this,this._pointers);t.moveTo(s[0].x,s[0].y),t.lineTo(s[1].x,s[1].y),t.lineTo(s[2].x,s[2].y)}if(t.closePath(),i>0&&(t.lineWidth=i,t.strokeStyle=this.getOutlineColor(),t.lineCap=this.getCap(),t.lineJoin=this.getJoin(),t.stroke()),e){var o=this.getFillColor(),r=this.getGradient();r?Y.fill(t,o,r,this.getGradientColor(),this._viewRect):t.fillStyle=o,t.fill()}}this.getFont(\"label2.font\"),this.getLabel();var a=this._network.getViewRect().x,h=this._network.getViewRect().y,l=this._network.getZoom(),c=this._contentRect.x+this._contentRect.width/2,d=this._contentRect.y+this._contentRect.height/2,u=c*l-a-this._contentDiv.offsetWidth/2*l+\"px\",_=d*l-h-this._contentDiv.offsetHeight/2*l+\"px\";this._contentDiv.style.left=u,this._contentDiv.style.top=_,this._contentDiv.style.setProperty(\"-webkit-transform\",\"scale(\"+l+\")\",null),this._contentDiv.style.setProperty(\"-webkit-transform-origin\",\"0 0\",null),this._network._debug&&(Y.strokeRect(t,this._contentRect,\"blue\"),Y.strokeRect(t,this._roundRect,\"red\"),Y.strokeRect(t,this._viewRect,\"green\"));if(this._element instanceof R.Link&&this._element.getStyle(\"link.label2.rotatable\")){var g=this.getZoomViewRect(),f=(g.x,g.width,g.y,g.height,180*this._network.getElementUI(this._element).getAbsoluteAngle()/Math.PI);this._contentDiv.offsetWidth,this._contentDiv.offsetHeight;V.isFirefox?R.Util.setCSSStyle(this._contentDiv,\"-moz-transform\",\"translate(0px,0px) rotate(\"+f+\"deg) scale(\"+l+\")\"):V.isOpera?R.Util.setCSSStyle(this._contentDiv,\"-o-transform\",\"translate(0px,0px) rotate(\"+f+\"deg) scale(\"+l+\")\"):V.isChrome||V.isSafari?R.Util.setCSSStyle(this._contentDiv,\"-webkit-transform\",\"translate(0px, 0px) rotate(\"+f+\"deg) scale(\"+l+\")\"):V.isIE?R.Util.setCSSStyle(this._contentDiv,\"-ms-transform\",\"translate(0px,0px) rotate(\"+f+\"deg) scale(\"+l+\")\"):R.Util.setCSSStyle(this._contentDiv,\"transform\",\"translate(0px,0px) rotate(\"+f+\"deg) scale(\"+l+\")\")}},setVisibility:function(t){this._contentDiv.style.visibility=t},dispose:function(){this._network.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv},getLabel:function(){return this._network.getLabel2(this._element)},getCornerRadius:function(){return this.getStyle(\"label2.corner.radius\")},getPointerLength:function(){return this.getStyle(\"label2.pointer.length\")},getPointerWidth:function(){return this.getStyle(\"label2.pointer.width\")},getPosition:function(){return this.getStyle(\"label2.position\")},getXOffset:function(){return this.getStyle(\"label2.xoffset\")},getYOffset:function(){return this.getStyle(\"label2.yoffset\")},getPadding:function(){return this.getStyle(\"label2.padding\")},getPaddingLeft:function(){return this.getStyle(\"label2.padding.left\")},getPaddingRight:function(){return this.getStyle(\"label2.padding.right\")},getPaddingTop:function(){return this.getStyle(\"label2.padding.top\")},getPaddingBottom:function(){return this.getStyle(\"label2.padding.bottom\")},getDirection:function(){return this.getStyle(\"label2.direction\")},isFill:function(){return this.getStyle(\"label2.fill\")},getFillColor:function(){return this.getStyle(\"label2.fill.color\")},getGradient:function(){return this.getStyle(\"label2.gradient\")},getGradientColor:function(){return this.getStyle(\"label2.gradient.color\")},getOutlineWidth:function(){return this.getStyle(\"label2.outline.width\")},getOutlineColor:function(){return this.getStyle(\"label2.outline.color\")},getCap:function(){return this.getStyle(\"label2.cap\")},getJoin:function(){return this.getStyle(\"label2.join\")},getAlpha:function(){return this.getStyle(\"label2.alpha\")},isShadowable:function(){return this.getStyle(\"label2.shadowable\")}}),R.vector.HTMLAlarmAttachment=function(t,e){R.vector.HTMLAlarmAttachment.superClass.constructor.call(this,t,e),this._triangleDiv=R.Util.createDiv(),this._roundDiv=R.Util.createDiv(),this._contentDiv=R.Util.createDiv(),R.Util.setCSSStyle(this._triangleDiv,\"border-style\",\"solid\"),R.Util.setCSSStyle(this._triangleDiv,\"pointer-events\",\"none\"),R.Util.setCSSStyle(this._contentDiv,\"white-space\",\"nowrap\"),R.Util.setCSSStyle(this._contentDiv,\"pointer-events\",\"none\");this._network.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},D.ext(\"twaver.vector.HTMLAlarmAttachment\",R.vector.AlarmAttachment,{validate:function(){this.getFont(\"alarm.font\");var t=this._network.getAlarmLabel(this._element);this._contentDiv.innerHTML=t,this._contentDiv.style.visibility=\"hidden\",R.vector.HTMLAlarmAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(R.Util.getCSSStyle(this._contentDiv.firstChild,\"width\"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(R.Util.getCSSStyle(this._contentDiv.firstChild,\"height\"))},paint:function(t){var e=this.isFill(),i=this.getOutlineWidth(),n=this._contentRect;if(this.getElementUI().setShadow(this,t),i>0||e){if(Y.drawRoundRect(t,n.x,n.y,n.width,n.height,this.getCornerRadius()),this._pointers){var s=this._ui.getZoomPointers(this,this._pointers);t.moveTo(s[0].x,s[0].y),t.lineTo(s[1].x,s[1].y),t.lineTo(s[2].x,s[2].y)}if(t.closePath(),i>0&&(t.lineWidth=i,t.strokeStyle=this.getOutlineColor(),t.lineCap=this.getCap(),t.lineJoin=this.getJoin(),t.stroke()),e){var o=this.getFillColor(),r=this.getGradient();r?Y.fill(t,o,r,this.getGradientColor(),this._viewRect):t.fillStyle=o,t.fill()}}this.getFont(\"alarm.font\"),this._network.getAlarmLabel(this._element);var a=this._network.getViewRect().x,h=this._network.getViewRect().y,l=this._network.getZoom(),c=this._contentRect.x+this._contentRect.width/2,d=this._contentRect.y+this._contentRect.height/2,u=c*l-a-this._contentDiv.offsetWidth/2*l+\"px\",_=d*l-h-this._contentDiv.offsetHeight/2*l+\"px\";this._contentDiv.style.left=u,this._contentDiv.style.top=_,this._contentDiv.style.setProperty(\"-webkit-transform\",\"scale(\"+l+\")\",null),this._contentDiv.style.setProperty(\"-webkit-transform-origin\",\"0 0\",null),this._network._debug&&Y.strokeRect(t,this._contentRect,\"#DDDDDD\"),R.vector.AlarmAttachment.superClass.paint.apply(this,arguments)},setVisibility:function(t){this._contentDiv.style.visibility=t},dispose:function(){this._network.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv}}),R.vector.BaseZoomManager=function(t){this.network=t,this.visibilityThresholds=t.visibilityThresholds},D.ext(\"twaver.vector.BaseZoomManager\",Object,{getZoom:function(){return this.network.getZoom()},getGraphicsZoom:function(){return 1},getSizeZoom:function(t){return 1},getAttachmentSizeZoom:function(t){var e=t.getElementUI();return this.getSizeZoom(e)},getLocationZoom:function(t){return 1},_getZoomVisibilityThresholds:function(){return this.network.getZoomVisibilityThresholds()},_convertPointFromView:function(t){return{x:t.x*this.getGraphicsZoom()-this.network.getViewRect().x,y:t.y*this.getGraphicsZoom()-this.network.getViewRect().y}},_getElementViewRect:function(t,e){var i=this.getLocationZoom(t),n=this.getSizeZoom(t);if(1==i&&1==n)return e;var s=this._getZoomPoint(t),o=s.x,r=s.y;return null==e&&console.log(\"View rect is null\"),{x:o*i+(e.x-o)*n,y:r*i+(e.y-r)*n,width:e.width*n,height:e.height*n}},_invalidateZoom:function(){this.network.invalidateElementUIs()},_getGroupChildrenRects:function(t){var e=new oe;return t.getChildren().forEach(function(t){if(t instanceof Pe){var i=this.network.getElementUI(t);if(i){var n=i.getZoomViewRect(this);n&&e.add(n)}}},this),e},_zoomGraphicsBegin:function(t){var e=this.network,i=this.getGraphicsZoom();t.scale(i,i),t.translate(-e.viewRect.x/i,-e.viewRect.y/i)},_getEditZoomPoints:function(t,e){var i=this.getLocationZoom(t),n=this.getSizeZoom(t);if(1==i&&1==n||t instanceof R.vector.LinkUI&&!(t instanceof R.vector.ShapeLinkUI))return e;var s,o=(s=t instanceof R.vector.ShapeLinkUI?W.getCenterPoint(W.getRect(e)):this._getZoomPoint(t)).x,r=s.y;if(e.forEach){var a,h=new oe;return e.forEach(function(t){t instanceof oe?(a=new oe,t.forEach(function(t){a.add({x:o*i+(t.x-o)*n,y:r*i+(t.y-r)*n})}),h.add(a)):h.add({x:o*i+(t.x-o)*n,y:r*i+(t.y-r)*n})}),h}return e.x?{x:o*i+(e.x-o)*n,y:r*i+(e.y-r)*n}:void 0},_getShapeNodeZoomPoints:function(t,e,i){var n=this.getLocationZoom(t),s=this.getSizeZoom(t);if(1==n&&1==s)return e;i&&(n=1/n,s=1/s);var o,r=W.getRect(e),a=r.x+r.width/2,h=r.y+r.height/2,l=new oe;return e.forEach(function(t){t instanceof oe?(o=new oe,t.forEach(function(t){o.add({x:a*n+(t.x-a)*s,y:h*n+(t.y-h)*s})}),l.add(o)):l.add({x:a*n+(t.x-a)*s,y:h*n+(t.y-h)*s})}),l},_getShapeLinkZoomPoints:function(t,e){var i=this.getLocationZoom(),n=i;if(1==i&&1==n)return t;e&&(i=1/i,n=1/n);var s,o=W.getRect(t),r=o.x+o.width/2,a=o.y+o.height/2,h=new oe;return t.forEach(function(t){t instanceof oe?(s=new oe,t.forEach(function(t){s.add({x:r*i+(t.x-r)*n,y:a*i+(t.y-a)*n})}),h.add(s)):h.add({x:r*i+(t.x-r)*n,y:a*i+(t.y-a)*n})}),h},_getLogicalPoint:function(t,e){var i=e?this.getZoom():this.getGraphicsZoom(),n=this.network;if(V.isTouchable&&t.changedTouches&&t.changedTouches.length>0){var s=n._view.getBoundingClientRect(),o=t.changedTouches[0],r=V.isAndroid?0:yt.scrollLeft(),a=V.isAndroid?0:yt.scrollTop();return{x:(o.clientX+n.viewRect.x-s.left-r)/i,y:(o.clientY+n.viewRect.y-s.top-a)/i}}return V.isFirefox?{x:(t.layerX+n.viewRect.x)/i,y:(t.layerY+n.viewRect.y)/i}:{x:(t.offsetX+n.viewRect.x)/i,y:(t.offsetY+n.viewRect.y)/i}},_getVisibleRect:function(t){return t},_getElementZoomRect:function(t,e){var i=this.getLocationZoom(t),n=this.getSizeZoom(t);if(1==i&&1==n)return D.cloneRect(e);var s=null!=t?this._getZoomPoint(t):{x:e.x+e.width/2,y:e.y+e.height/2},o=s.x,r=s.y;return{x:o*i+(e.x-o)*n,y:r*i+(e.y-r)*n,width:e.width*n,height:e.height*n}},_reverseElementZoomRect:function(t,e){var i=this.getLocationZoom(t),n=this.getSizeZoom(t);if(1==i&&1==n)return D.cloneRect(e);var s=null!=t?this._getZoomPoint(t):{x:e.x+e.width/2,y:e.y+e.height/2},o=s.x,r=s.y;return{x:o+(e.x-o*i)/n,y:r+(e.y-r*i)/n,width:e.width/n,height:e.height/n}},_getZoomContentRect:function(t,e,i,n,s,o){var r=this.getSizeZoom(t.getElementUI()),a=this.getAttachmentSizeZoom(t),h=t.getElementUI();return void 0==o?h instanceof R.vector.GroupUI&&h._shapeRect?{x:n.x*s+1*(e.x-n.x)+(i.x-e.x)*a,y:n.y*s+1*(e.y-n.y)+(i.y-e.y)*a,width:i.width,height:i.height}:{x:n.x*s+(e.x-n.x)*r+(i.x-e.x)*a,y:n.y*s+(e.y-n.y)*r+(i.y-e.y)*a,width:i.width,height:i.height}:{x:n.x*s+(e.x-n.x)*r+(i.x-e.x)*a,y:n.y*s+(e.y-n.y)*r+(i.y-e.y)*a+o*(t.textHeight-4)*a,width:i.width,height:t.textHeight}},_getAttachmentZoomRect:function(t,e,i){var n=this.getLocationZoom(t.getElementUI()),s=t.getElementUI(),o=this.getSizeZoom(t.getElementUI()),r=this.getAttachmentSizeZoom(t),a=t._pointers;if(1==n&&1==r&&1==o)return void 0==i?e:{x:e.x,y:e.y+i*(t.textHeight-4),width:e.width,height:t.textHeight};s=t.getElementUI();var h=this._getZoomPoint(s,t),l=(h.x,h.y,t.getPosition?t.getPosition():\"center\"),c=a?a[0]:Ne.get(l,e);return void 0==i?s instanceof R.vector.LinkUI||s instanceof R.vector.GroupUI&&s._shapeRect?this._getZoomContentRect(t,c,e,h,1):this._getZoomContentRect(t,c,e,h,n):this._getZoomContentRect(t,c,e,h,n,i)},_getZoomPoint:function(t,e){var i,n,s=t._element;if(s instanceof R.Follower&&s.getHost()&&s.getHost()instanceof R.Grid)return i=s.getHost(),n=i.getRect(),{x:n.x+n.width/2,y:n.y+n.height/2};if(n=t.getBodyRect(),t instanceof R.vector.LinkUI&&e&&e.getPosition){e.getXOffset(),e.getYOffset();if(\"from\"===e.getPosition())return t._fromPoint;if(\"to\"===e.getPosition())return t._toPoint}return{x:n.x+n.width/2,y:n.y+n.height/2}},_getZoomPointers:function(t,e,i){if(i){var n=this._getZoomPoint(e),s=this.getLocationZoom(e),o=this.getSizeZoom(e),r=this.getAttachmentSizeZoom(t),a=i[0];return e instanceof R.vector.LinkUI?[{x:n.x+(a.x-n.x)*o,y:n.y+(a.y-n.y)*o},{x:n.x+(a.x-n.x)*o+(i[1].x-a.x)*r,y:n.y+(a.y-n.y)*o+(i[1].y-a.y)*r},{x:n.x+(a.x-n.x)*o+(i[2].x-a.x)*r,y:n.y+(a.y-n.y)*o+(i[2].y-a.y)*r}]:e instanceof R.vector.GroupUI&&e._shapeRect?[{x:n.x+1*(a.x-n.x),y:n.y+1*(a.y-n.y)},{x:n.x+1*(a.x-n.x)+(i[1].x-a.x)*r,y:n.y+1*(a.y-n.y)+(i[1].y-a.y)*r},{x:n.x+1*(a.x-n.x)+(i[2].x-a.x)*r,y:n.y+1*(a.y-n.y)+(i[2].y-a.y)*r}]:[{x:n.x*s+(a.x-n.x)*o,y:n.y*s+(a.y-n.y)*o},{x:n.x*s+(a.x-n.x)*o+(i[1].x-a.x)*r,y:n.y*s+(a.y-n.y)*o+(i[1].y-a.y)*r},{x:n.x*s+(a.x-n.x)*o+(i[2].x-a.x)*r,y:n.y*s+(a.y-n.y)*o+(i[2].y-a.y)*r}]}},_getZoomHotSpot:function(t,e){if(e){var i=this._getZoomPoint(t),n=this.getLocationZoom(t),s=this.getSizeZoom(t);return{x:i.x*n+(e.x-i.x)*s,y:i.y*n+(e.y-i.y)*s}}return null},limitZoom:function(t){return t},_isVisible:function(t){var e=this._getZoomVisibilityThresholds(),i=e[t];if(null!=i){var n=e.zoomName;if((\"sizeZoom\"==n?this.getSizeZoom():\"locationZoom\"==n?this.getLocationZoom():\"graphicsZoom\"==n?this.getGraphicsZoom():this.getZoom())<i)return!1}return!0},isElementVisible:function(t){var e=this.getZoom(),i=this._isVisible(\"element\",e);return i&&t instanceof R.Link?this.isLinkVisible(t):i},isLinkVisible:function(t){var e=this.getZoom();return this._isVisible(\"link\",e)},isLabelVisible:function(t){var e=this.getZoom();return this._isVisible(\"label\",e)},isAttachmentVisible:function(t){var e=this.getZoom();return this._isVisible(\"attachment\",e)},isAlarmBalloonVisible:function(t){var e=this.getZoom();return this._isVisible(\"alarmBallon\",e)},_getAttachmentOutLineWidth:function(t){return t.getOutlineWidth()},_getAttachmentZoomOutLineRect:function(t,e){var i=this.getLocationZoom(t.getElementUI()),n=this.getAttachmentSizeZoom(t);if(1==i&&1==n)return e;var s=this._getAttachmentZoomRect(t,e,null),o=t.getElement();return this.isAttachmentVisible(o)?(t instanceof R.vector.LabelAttachment||t instanceof R.vector.Label2Attachment)&&!this.isLabelVisible(o)?{x:s.x,y:s.x,width:0,height:0}:t instanceof R.vector.AlarmAttachment&&!this.isAlarmBalloonVisible(o)?{x:s.x,y:s.x,width:0,height:0}:{x:s.x,y:s.y,width:s.width*n,height:s.height*n}:{x:s.x,y:s.x,width:0,height:0}},_drawText:function(t,e,i,n,s,o,r,a){var h=this.getLocationZoom(t.getElementUI()),l=this.getAttachmentSizeZoom(t);1!=h&&1!=l?(e.translate(n.x,n.y),e.scale(l,l),Y.drawText(e,i,{x:0,y:0,width:n.width,height:n.height},s,o,r),e.scale(1/l,1/l),e.translate(-n.x,-n.y)):Y.drawText(e,i,n,s,o,r,a)},_getOffset:function(t,e){var i=this.getLocationZoom();return{x:(t.x-e.x)/i,y:(t.y-e.y)/i}}});var Ne={\"topleft.topleft\":function(t){return{x:t.x+t.width,y:t.y+t.height}},\"topleft.topright\":function(t){return{x:t.x,y:t.y+t.height}},\"top.top\":function(t){return{x:t.x+t.width/2,y:t.y+t.height}},\"topright.topleft\":function(t){return{x:t.x+t.width,y:t.y+t.height}},\"topright.topright\":function(t){return{x:t.x,y:t.y+t.height}},topleft:function(t){return{x:t.x+t.width/2,y:t.y+t.height/2}},top:function(t){return{x:t.x+t.width/2,y:t.y+t.height/2}},topright:function(t){return{x:t.x+t.width/2,y:t.y+t.height/2}},\"topleft.bottomleft\":function(t){return{x:t.x+t.width,y:t.y}},\"topleft.bottomright\":function(t){return{x:t.x,y:t.y}},\"top.bottom\":function(t){return{x:t.x+t.width/2,y:t.y}},\"topright.bottomleft\":function(t){return{x:t.x+t.width,y:t.y}},\"topright.bottomright\":function(t){return{x:t.x,y:t.y}},\"left.left\":function(t){return{x:t.x+t.width,y:t.y+t.height/2}},left:function(t){return{x:t.x+t.width/2,y:t.y+t.height/2}},\"left.right\":function(t){return{x:t.x,y:t.y+t.height/2}},center:function(t){return{x:t.x+t.width/2,y:t.y+t.height/2}},\"right.left\":function(t){return{x:t.x+t.width,y:t.y+t.height/2}},right:function(t){return{x:t.x+t.width/2,y:t.y+t.height/2}},\"right.right\":function(t){return{x:t.x,y:t.y+t.height/2}},\"bottomleft.topleft\":function(t){return{x:t.x+t.width,y:t.y+t.height}},\"bottomleft.topright\":function(t){return{x:t.x,y:t.y+t.height}},\"bottom.top\":function(t){return{x:t.x+t.width/2,y:t.y+t.height}},\"bottomright.topleft\":function(t){return{x:t.x+t.width,y:t.y+t.height}},\"bottomright.topright\":function(t){return{x:t.x,y:t.y+t.height}},bottomleft:function(t){return{x:t.x+t.width/2,y:t.y+t.height/2}},bottom:function(t){return{x:t.x+t.width/2,y:t.y+t.height/2}},bottomright:function(t){return{x:t.x+t.width/2,y:t.y+t.height/2}},\"bottomleft.bottomleft\":function(t){return{x:t.x+t.width,y:t.y}},\"bottomleft.bottomright\":function(t){return{x:t.x,y:t.y}},\"bottom.bottom\":function(t){return{x:t.x+t.width/2,y:t.y}},\"bottomright.bottomleft\":function(t){return{x:t.x+t.width,y:t.y}},\"bottomright.bottomright\":function(t){return{x:t.x,y:t.y}},from:function(t){return{x:t.x+t.width/2,y:t.y+t.height/2}},to:function(t){return{x:t.x+t.width/2,y:t.y+t.height/2}},get:function(t,e){if(!e)throw\"rect can not be null\";var i=Ne[t];if(i)return i(e);throw\"Can not resolve '\"+t+\"' position\"}};R.vector.PhysicalZoomManager=function(t){R.vector.PhysicalZoomManager.superClass.constructor.apply(this,arguments)},D.ext(\"twaver.vector.PhysicalZoomManager\",R.vector.BaseZoomManager,{getGraphicsZoom:function(){return this.getZoom()},_invalidateZoom:function(){}}),R.vector.LogicalZoomManager=function(t,e){R.vector.LogicalZoomManager.superClass.constructor.apply(this,arguments),this.sizeChange=e},D.ext(\"twaver.vector.LogicalZoomManager\",R.vector.BaseZoomManager,{getLocationZoom:function(t){return this.getZoom()},getSizeZoom:function(t){return this.sizeChange?this.getZoom():1}}),R.vector.MixedZoomManager=function(t,e){R.vector.MixedZoomManager.superClass.constructor.call(this,t,e)},D.ext(\"twaver.vector.MixedZoomManager\",R.vector.LogicalZoomManager,{}),function(){var t=R.vector.LogicalZoomManager.prototype,e=R.vector.PhysicalZoomManager.prototype,i=R.vector.MixedZoomManager.prototype;for(var n in e)\"function\"==typeof e[n]&&\"constructor\"!=n&&(t.hasOwnProperty(n)||e.hasOwnProperty(n))&&function(n){i[n]=function(){return this.getZoom()>1?t[n].apply(this,arguments):e[n].apply(this,arguments)}}(n);i._invalidateZoom=function(){this.network.invalidateElementUIs()}}(),R.vector.interaction.BaseInteraction=function(t){this.network=t},D.ext(\"twaver.vector.interaction.BaseInteraction\",Object,{setUp:function(){},tearDown:function(){},repaint:function(){this.network.repaintTopCanvas()},getOffset:function(t,e){return this.network.getOffset(t,e)},convertPointFromView:function(t){return this.network.convertPointFromView(t)},convertFromUIToMarkerRect:function(t,e,i,n){var s=this.network.zoomManager,o=s.getLocationZoom(),r=s.getGraphicsZoom(),a=s.getSizeZoom(this.network.getElementUI(n));return{x:t.x*o*r-this.network.getViewRect().x+e*o*r,y:t.y*o*r-this.network.getViewRect().y+i*o*r,width:t.width*a*r,height:t.height*a*r}},getMarkerPoint:function(t){if(V.isTouchable&&t.changedTouches&&t.changedTouches.length>0){var e=t.changedTouches[0];return{x:e.clientX,y:e.clientY}}return V.isFirefox?{x:t.layerX,y:t.layerY}:{x:t.offsetX,y:t.offsetY}},paint:function(t){},addListener:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t];X.addEventListener(e,\"handle_\"+e,this.network.getView(),this)}},removeListener:function(){for(var t=0;t<arguments.length;t++)X.removeEventListener(arguments[t],this.network.getView(),this)},_handle_mousedown:function(t){0===t.button&&(this._startLogical=this.network.getLogicalPoint2(t),this._startClient=X.getClientPoint(t),this._startLogical&&X.handle_mousedown(this,t))},_handle_mousemove:function(t){this._endLogical={x:this._startLogical.x+(t.clientX-this._startClient.x)/this.network.getGraphicsZoom(),y:this._startLogical.y+(t.clientY-this._startClient.y)/this.network.getGraphicsZoom()}},_handle_mouseup:function(t){delete this._startClient,delete this._startLogical,delete this._endLogical}}),R.vector.interaction.DefaultInteraction=function(t,e){R.vector.interaction.DefaultInteraction.superClass.constructor.call(this,t),this.lazyMode=e},D.ext(\"twaver.vector.interaction.DefaultInteraction\",R.vector.interaction.BaseInteraction,{setUp:function(){this.addListener(\"mousedown\",\"mouseover\",\"mouseout\",\"keydown\"),V.isFirefox?X.addEventListener(\"DOMMouseScroll\",\"handleMouseWheel\",this.network.getView(),this):X.addEventListener(\"mousewheel\",\"handleMouseWheel\",this.network.getView(),this),X.addEventListener(\"mouseup\",\"handle_mouseup\",window,this),X.addEventListener(\"dblclick\",\"handleDoubleClicked\",this.network.getView(),this),X.addEventListener(\"blur\",\"handle_blur\",this.network.getView(),this),this._oldCursor=this.network.getView().style.cursor,this.network.addPropertyChangeListener(this.handleViewRectChange,this),this.validateScrollBar(),this.network.addMarker(this),this.network.getView().oncontextmenu=function(t){t.preventDefault()},this._createZoomDiv()},tearDown:function(){this.removeListener(\"mousedown\",\"mouseover\",\"mouseout\",\"keydown\"),V.isFirefox?X.removeEventListener(\"DOMMouseScroll\",this.network.getView(),this):X.removeEventListener(\"mousewheel\",this.network.getView(),this),X.removeEventListener(\"mouseup\",window,this),X.removeEventListener(\"dblclick\",this.network.getView(),this),X.removeEventListener(\"blur\",this.network.getView(),this),this.network.removePropertyChangeListener(this.handleViewRectChange,this),this.end(),this.network.removeMarker(this),this._zoomDiv=null},_createZoomDiv:function(){if(null==this._zoomDiv){this._zoomDiv=z.createElement(\"div\"),this._zoomLabel=z.createElement(\"span\"),this._zoomLabel.style.display=\"block\",this._zoomLabel.style.textAlign=\"center\";var t=z.createElement(\"button\");t.innerHTML=\"Reset to default\",this._zoomDiv.appendChild(this._zoomLabel),this._zoomDiv.appendChild(t);var e=xe,i=this._zoomDiv.style;i.position=\"absolute\",i.color=e.TOOLTIP_COLOR,i.background=e.TOOLTIP_BACKGROUND,i.fontSize=e.TOOLTIP_FONT_SIZE,i.padding=e.TOOLTIP_PADDING,i.border=e.TOOLTIP_BORDER,i.borderRadius=e.TOOLTIP_BORDER_RADIUS,i.boxShadow=e.TOOLTIP_BOX_SHADOW,i.zIndex=e.TOOLTIP_ZINDEX,i.setProperty&&i.setProperty(\"-webkit-box-shadow\",e.TOOLTIP_BOX_SHADOW,null);var n=this;t.onclick=function(t){n.network.setZoom(1),n._setZoomDivVisible(!1)};var s=this._zoomDiv;s._clearFunc=function(){if(s.style.opacity=parseFloat(s.style.opacity)-.05,parseFloat(s.style.opacity)<=.05)return n._setZoomDivVisible(!1),void(s._clearTimeout=null);s._clearTimeout=setTimeout(s._clearFunc,100)},s.onmouseover=function(t){t||(t=window.event);for(var e=t.relatedTarget?t.relatedTarget:t.fromElement;e&&e!=s;)e=e.parentNode;e!=s&&(s._clearTimeout&&(clearTimeout(s._clearTimeout),s._clearTimeout=null),s.style.opacity=1)},s.onmouseout=function(t){t||(t=window.event);for(var e=t.relatedTarget?t.relatedTarget:t.toElement;e&&e!=s;)e=e.parentNode;e!=s&&(s._clearTimeout=setTimeout(s._clearFunc,10))}}},_isZoomDivVisible:function(){return null!=this._zoomDiv&&null!=this._zoomDiv.parentNode},_getZoomDiv:function(){return this._zoomDiv||this._createZoomDiv(),this._zoomDiv},_setZoomDivVisible:function(t,e,i){var n=this._getZoomDiv();if(t){this._zoomLabel.innerHTML=i,n.style.opacity=1,this._isZoomDivVisible()||this.network.getView().appendChild(n),n.style.left=xe.TOOLTIP_XOFFSET+\"px\",n.style.top=xe.TOOLTIP_YOFFSET+\"px\";n._clearTimeout&&(clearTimeout(n._clearTimeout),n._clearTimeout=null),n._clearTimeout=setTimeout(n._clearFunc,250)}else n.parentNode&&n.parentNode.removeChild(n)},handleViewRectChange:function(t){\"viewRect\"!=t.property&&\"canvasSizeChange\"!=t.property||this.validateScrollBar()},getScrollBarWidth:function(){return this.network.getScrollBarWidth()},getScrollBarColor:function(){return\"#cccccc\"},validateScrollBar:function(){if(this.hThumbRect=null,this.vThumbRect=null,0!=this.network.isScrollBarVisible()){var t=this.network.getViewRect().height,e=this.network.getViewRect().width,i=this.network.getViewRect().x,n=this.network.getViewRect().y,s=this.network.getCanvasSize(),o=this.network._unionBounds,r=o.x,a=o.y,h=o.width,l=o.height,c=s.width,d=s.height,u=e,_=t,g=!1,f=!1;(i>r||e+i<c)&&(f=!0),(n>a||n+t<d)&&(g=!0);var v,m,p=0,w=0,y=0,A=0,x=u,C=_,E=this.getScrollBarWidth();f&&(g&&(x-=E),A=E,w=_-E,i>r&&i+e>c?(p=v=(v=i-r)*x/(v+u),y=x-v):i<r&&i+e<c?(p=0,y=x-(v=x*(v=c-(i+e))/(v+u))):(p=m=x*(m=i-r)/h,y=u-m-x*(c-(i+e))/h),this.hThumbRect={x:p,y:w,width:y,height:A}),p=0,w=0,y=0,A=0,x=u,C=_,g&&(f&&(C-=E),y=E,p=u-E,n>a&&n+t>d?(w=v=C*(v=n-a)/(v+_),A=C-v):n<a&&n+t<d?(w=0,A=C-(v=C*(v=d-(n+t))/(v+_))):(w=m=C*(m=n-a)/l,A=C-m-C*(d-(n+t))/l),this.vThumbRect={x:p,y:w,width:y,height:A}),this.network.setHScrollBarVisible(null!=this.hThumbRect),this.network.setVScrollBarVisible(null!=this.vThumbRect),this.repaint()}else this.repaint()},scrollXOffset:function(t){var e=this.network.getViewRect().height,i=this.network.getViewRect().width,n=this.network.getViewRect().x,s=this.network.getViewRect().y,o=30;t&&(o=-30),this.network.setViewRect(n+o,s,i,e)},scrollYOffset:function(t){var e=this.network.getViewRect().height,i=this.network.getViewRect().width,n=this.network.getViewRect().x,s=this.network.getViewRect().y,o=30;t&&(o=-30),this.network.setViewRect(n,s+o,i,e)},handle_mouseover:function(t){1!=this.scrollBarVisible&&(this.scrollBarVisible=!0,this.repaint())},handle_mouseout:function(t){0!=this.scrollBarVisible&&null==this.vBarDownPoint&&null==this.hBarDownPoint&&(this.scrollBarVisible=!1,this.repaint(),this.end(t))},handle_keydown:function(t){this.currentKeyEvent=t,this.addListener(\"keyup\"),Ct.handleKeyDown(this.network,t)},handle_keyup:function(t){this.currentKeyEvent=null,this.removeListener(\"keyup\")},start:function(t){this.end(t,!0),this.lastPoint=this.network.getLogicalPoint2(t),this.startPoint=this.network.getLogicalPoint2(t),this.lastPanPoint=this.getMarkerPoint(t),this.lazyMode&&(this.pressPoint=this.lastPoint),X.addEventListener(\"mousemove\",\"handle_mousemove\",window,this)},end:function(t,e){if(this.vBarDownPoint=null,this.hBarDownPoint=null,this.network.state.panning&&(this.network.state.panning=!1,this.network.invalidateElementUIs(!0)),e||(this.network.getView().style.cursor=this._oldCursor),this.isMoving){if(this.lazyMode){if(null!=this.dragPoint&&null!=this.pressPoint){var i=this,n=this.getOffset(this.dragPoint,this.pressPoint),s=n.x,o=n.y;this.network.moveSelectedElements(s,o,this.network.isLazyMoveAnimate(),function(){i.network.fireInteractionEvent({kind:\"lazyMoveEnd\",event:t}),i.network.setMovingElement(!1)})}}else this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:\"liveMoveEnd\",event:t}));if(this.isParenting()){null==this.parent&&(this.parent=this.network.getCurrentSubNetwork());i=this;this.network.getMovableSelectedElements().forEach(function(t){t.setParent(i.parent)},this.network)}this.parentProcess(t,!0),this.isParenting()&&this.repaint(),this.network.invalidateCanvasSize(),this.lastPoint=null,this.dragPoint=null,this.pressPoint=null,this.repaint()}if(this.isSelecting&&this.startPoint){if(this.endPoint&&this.startPoint.x!==this.endPoint.x&&this.startPoint.y!==this.endPoint.y){var r=W.getRect([this.startPoint,this.endPoint]),a=this.network.getElementsAtRect(r,this.getIntersectMode(),this.network.getRectSelectFilter());if(a&&a.size()>0){var h=this.network.getSelectionModel(),l=h.toSelection();a.forEach(function(t){h.contains(t)?l.remove(t):l.add(t)},this),h.setSelection(l)}this.network.fireInteractionEvent({kind:\"selectEnd\",event:t})}this.network.setSelectingElement(!1),this.startPoint=null,this.endPoint=null,this.repaint()}this.isMouseDown=!1,X.removeEventListener(\"mousemove\",window,this)},_isDragToSelect:function(t){return!this.network._dragToPan},handle_mousedown:function(t){if(V.isTouchable||0===t.button||!this.network.isSelectingElement()){var e=this.network;if(t.target==e.getView()||t.target==e._topCanvas||t.target==e._rootCanvas){if(this.isMoving=!1,this.isSelecting=!1,this.hBarDownPoint=null,this.vBarDownPoint=null,this._setZoomDivVisible(!1),!this.network.isValidEvent(t)){var i=this.getMarkerPoint(t);return this.start(t),null!=this.vThumbRect&&W.containsPoint(this.vThumbRect,i.x,i.y)&&(this.vBarDownPoint={x:t.screenX,y:t.screenY},this.vBarDownOffset=this.vBarDownPoint.y-this.vThumbRect.y),void(null!=this.hThumbRect&&W.containsPoint(this.hThumbRect,i.x,i.y)&&(this.hBarDownPoint={x:t.screenX,y:t.screenY},this.hBarDownOffset=this.hBarDownPoint.x-this.hThumbRect.x))}this.network.isFocusOnClick()&&R.Util.setFocus(this.network.getView());var n=this.network.getElementAt(t),s=this.network.getElementsAt(t);if(s&&s instanceof oe)for(var o=0;o<s.size();o++){var r=s.get(o);if(this.network.getElementBox().getSelectionModel().isSelectable(r)){n=r;break}}if(this.network.isSelectingElement()||this.network.isEditingElement()||null==n||(this.network.isMovable(n)&&this.network.getElementBox().getSelectionModel().isSelectable(n)?this.isMoving=!0:this.network.getView().style.cursor=\"pointer\",this.start(t)),!this.network.isSelectingElement()&&!this.network.isEditingElement()){var a=this.network.getSelectionModel();null==n||n&&!this.network.getElementBox().getSelectionModel().isSelectable(n)?(D.isCtrlDown(t)?this.isSelecting=!0:this._isDragToSelect(t)?(this.isSelecting=!0,a.clearSelection()):this.network.isRectSelectEnabled()&&(a.clearSelection(),this.network.getView().style.cursor=\"pointer\"),e._rectSelectEnabled&&this.start(t)):D.isCtrlDown(t)?a.contains(n)?a.removeSelection(n):a.appendSelection(n):a.contains(n)||a.setSelection(n)}this.handleClicked(t,n),this.isMouseDown=!0}}else this.end(t)},handle_mousemove:function(t){this._setZoomDivVisible(!1);if(f=this.network.getLogicalPoint2(t)){var e,i,n={x:t.screenX,y:t.screenY},s=this.network.getElementBox().getDatas(),o=s.size();if(o>0){for(var r=0;r<o;r++){var a=s.get(r);if(this.network._visibleMap[a._id]){var h=this.network._elementUIMap[a._id];h&&(i=i?W.unionRect(i,h.getZoomViewRect(!0)):D.cloneRect(h.getZoomViewRect(!0)))}}null==i&&(i={x:0,y:0,width:0,height:0});var l=this.network.getGraphicsZoom();e={width:(Math.abs(i.x)+i.width)*l,height:(Math.abs(i.y)+i.height)*l}}else e=this.network.getCanvasSize();var c=this.network.getViewRect().height,d=this.network.getViewRect().width,u=this.getScrollBarWidth();if(null!=this.hBarDownPoint){var _=n.x-this.hBarDownPoint.x;return this.hBarDownPoint=n,void this.network.setViewOffSet(_*e.width/(d-u),0)}if(null!=this.vBarDownPoint){var g=n.y-this.vBarDownPoint.y;return this.vBarDownPoint=n,void this.network.setViewOffSet(0,g*e.height/(c-u))}if(this.network.isSelectingElement()||this.network.isEditingElement()||!this.isMoving||!this.isMouseDown||D.isCtrlDown(t))if(this.isSelecting&&(D.isCtrlDown(t)||this._isDragToSelect()))this.network.setSelectingElement(!0),null==this.endPoint?this.network.fireInteractionEvent({kind:\"selectStart\",event:t}):this.network.fireInteractionEvent({kind:\"selectBetween\",event:t}),this.endPoint=f,this.repaint();else if(this.isMoving||this.isSelecting||!this.isMouseDown)this.end(t);else{if(!this.lastPanPoint||!this.network._dragToPan)return;var f;if(!(f=this.getMarkerPoint(t)))return;var v=f.x-this.lastPanPoint.x,m=f.y-this.lastPanPoint.y;this.network.panByOffset(-v,-m),this.network.fireInteractionEvent({kind:\"panning\",event:t}),this.network.state.panning=!0,this.lastPanPoint=f}else{var p=this.getOffset(f,this.lastPoint);if(this.xoffset=p.x,this.yoffset=p.y,Math.abs(this.xoffset)<1&&Math.abs(this.yoffset)<1)return;this.lazyMode?null==this.dragPoint?(this.network.fireInteractionEvent({kind:\"lazyMoveStart\",event:t}),this.network.setMovingElement(!0)):this.network.fireInteractionEvent({kind:\"lazyMoveBetween\",event:t}):(this.lastPoint=f,this.network.isMovingElement()?this.network.fireInteractionEvent({kind:\"liveMoveBetween\",event:t}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:\"liveMoveStart\",event:t})),this.network.moveSelectedElements(this.xoffset,this.yoffset)),this.parentProcess(t,!1),this.lazyMode&&(this.dragPoint=f),(this.lazyMode||this.isParenting())&&this.repaint()}}},handleMouseWheel:function(t){if(z.activeElement===this.network.getView())if(this.network._wheelToZoom){X.preventDefault(t);var e={x:t.offsetX||t.layerX,y:t.offsetY||t.layerY},i=this.network.getZoom();t.wheelDelta&&t.wheelDelta>0||t.detail&&t.detail<0?this.network.setZoom(1.1*i,e):this.network.setZoom(i/1.1,e),this._setZoomDivVisible(this.network.isZoomDivVisible(),t,\"Zoom : \"+parseFloat(this.network.getZoom().toFixed(4)))}else this._handleMouseWheelScroll(t)},_handleMouseWheelScroll:function(t){X.preventDefault(t);var e=!1,i=this._getVisibleScrollBar();null!=i&&(e=t.wheelDelta?t.wheelDelta>0:t.detail<0,\"v\"==i?this.scrollYOffset(e):this.scrollXOffset(e))},handle_mouseup:function(t){this.end(t)},isParenting:function(){return this.pressPoint&&null!=this.currentKeyEvent&&80===this.currentKeyEvent.keyCode},parentProcess:function(t,e){var i=null;this.parent=null;if(!e&&this.isParenting()){var n={},s=this.network.getLogicalPoint2(t);n.x=s.x-1,n.y=s.y-1,n.width=2,n.height=2;var o=this.network.getElementsAtRect(n,!0);if(o&&o.size()>0)for(var r=o.size(),a=0;a<r;a++){var h=o.get(a);if(!this.network.getElementBox().getSelectionModel().contains(h)){this.parent=h;break}}}else this.parent=null;null!=this.parent&&(i=this.network.getElementUI(this.parent).getViewRect()),this.parentRect=null==i||e?null:i},getIntersectMode:function(){return\"intersect\"===this.network.getSelectMode()||\"contain\"!==this.network.getSelectMode()&&(this.startPoint.x>this.endPoint.x&&this.startPoint.y>this.endPoint.y)},_getVisibleScrollBar:function(){return 0==this.network.isScrollBarVisible()?null:null!=this.vThumbRect?\"v\":null!=this.hThumbRect?\"h\":null},paintScroll:function(t){if(0!=this.network.isScrollBarVisible()&&(0!=this.scrollBarVisible||null!=this.hBarDownPoint||null!=this.vBarDownPoint)){var e=this.getScrollBarWidth(),i=this.network.getViewRect().height,n=this.network.getViewRect().width;t.save();var s,o=this.getScrollBarColor();null!=this.hThumbRect&&((s=t.createLinearGradient(this.hThumbRect.x,this.hThumbRect.y,this.hThumbRect.x,this.hThumbRect.y+this.hThumbRect.height)).addColorStop(0,o),s.addColorStop(1,\"#666666\"),this.paintRoundRect(t,this.getScrollBarColor(),.5,0,i-e,n-e,e,e/2),this.paintRoundRect(t,s,.9,this.hThumbRect.x,this.hThumbRect.y+1,this.hThumbRect.width,this.hThumbRect.height-2,e/2)),null!=this.vThumbRect&&((s=t.createLinearGradient(this.vThumbRect.x,this.vThumbRect.y,this.vThumbRect.x+this.vThumbRect.width,this.vThumbRect.y)).addColorStop(0,o),s.addColorStop(1,\"#666666\"),this.paintRoundRect(t,this.getScrollBarColor(),.5,n-e,0,e,i-e,e/2),this.paintRoundRect(t,s,.9,this.vThumbRect.x+1,this.vThumbRect.y,this.vThumbRect.width-2,this.vThumbRect.height,e/2)),t.restore()}},paintRoundRect:function(t,e,i,n,s,o,r,a){t.beginPath(),t.globalAlpha=i,t.fillStyle=e,Y.drawRoundRect(t,n,s,o,r,a),t.fill()},paint:function(t){if(this.paintScroll(t),this.network.isSelectingElement()){if(null==this.startPoint||null==this.endPoint)return;var e=this.convertPointFromView(this.startPoint),i=this.convertPointFromView(this.endPoint),n=e.x,s=e.y,o=i.x,r=i.y,a=W.getRect([{x:n,y:s},{x:o,y:r}]);if(null!=a){t.beginPath();var h=this.network.getSelectOutlineWidth(),l=this.getIntersectMode()?this.network.getSelectFillColor():null;t.strokeStyle=this.network.getSelectOutlineColor(),t.lineWidth=h,Me.rect(t,a.x,a.y,a.width,a.height,l,this.network.getSelectOutlineColor()),t.closePath()}}else{if(this.lazyMode){if(null==this.pressPoint||null==this.dragPoint)return;t.beginPath();var c=this.getOffset(this.dragPoint,this.pressPoint),d=c.x,u=c.y,_=this.network.getMovableSelectedElements(),g=_.size(),f=this.network.isLazyMoveFill()?this.network.getLazyMoveFillColor():null,v=(h=this.network.getLazyMoveOutlineWidth(),this.network.getLazyMoveOutlineColor());t.strokeStyle=v,t.lineWidth=h,t.fillStyle=f;for(var m=0;m<g;m++){var p=_.get(m),w=this.network.getElementUI(p);if(w){var y=this.convertFromUIToMarkerRect(w.getViewRect(),d,u);Me.rect(t,y.x,y.y,y.width,y.height)}}t.fill(),t.stroke()}if(this.parentRect){t.beginPath();f=this.network.isLazyMoveFill()?this.network.getLazyMoveFillColor():null,h=this.network.getLazyMoveOutlineWidth(),v=this.network.getLazyMoveOutlineColor();t.strokeStyle=v,t.lineWidth=h,t.fillStyle=f;y=this.parentRect;Me.rect(t,y.x,y.y,y.width,y.height),t.fill(),t.stroke()}}},handleClicked:function(t,e){Ct.handleClicked(this.network,t,e)},handleDoubleClicked:function(t){var e=this.network.getElementAt(t);Ct.handleDoubleClicked(this.network,t,e)},handle_blur:function(t){this.end()}}),R.vector.interaction.CreateElementInteraction=function(t,e){e||(e=R.Node),R.Util.isTypeOf(e,R.Node)?this.elementFunction=function(t){var i=new e;return i instanceof R.Node&&i.setCenterLocation(t),i}:this.elementFunction=e,R.vector.interaction.CreateElementInteraction.superClass.constructor.call(this,t)},D.ext(\"twaver.vector.interaction.CreateElementInteraction\",R.vector.interaction.BaseInteraction,{setUp:function(){this.addListener(\"mousedown\")},tearDown:function(){this.removeListener(\"mousedown\")},handle_mousedown:function(t){var e=this.network.getLogicalPoint2(t);if(e){var i=this.elementFunction(e);i&&this.network.addElementByInteraction(i)}}}),R.vector.interaction.EditInteraction=function(t,e){this.lazyMode=e,this.pointIndex=-1,this.linkPointsType=null,R.vector.interaction.EditInteraction.superClass.constructor.call(this,t)},D.ext(\"twaver.vector.interaction.EditInteraction\",R.vector.interaction.BaseInteraction,{setUp:function(){this.addListener(\"mousedown\",\"mouseup\",\"mousemove\"),this.oldCursor=this.network.getView().style.cursor,this.network.setHasEditInteraction(!0),this.network.addMarker(this)},tearDown:function(){this.removeListener(\"mousedown\",\"mouseup\",\"mousemove\"),this.network.getView().style.cursor=this.oldCursor,this.network.setHasEditInteraction(!1),this.clear(),this.network.removeMarker(this)},paint:function(t){if(1==this.lazyMode&&null!=this.resizingRect){t.lineWidth=this.network.getResizeLineWidth();var e=this.convertFromUIToMarkerRect(this.resizingRect,0,0,this.node);t.save(),R.Util.rotateCanvas(t,e,this.node.getAngle()),t.beginPath(),Me.rect(t,e.x,e.y,e.width,e.height,null,this.network.getResizeLineColor()),t.restore()}this.isStartRotate&&this.showRotateScale(t)},clear:function(){this.network.setEditingElement(!1),this.network.setRotatingElement(!1),this.isStart=!1,this.isStartRotate=!1,this.node=null,this.shapeNode=null,this.shapeLink=null,this.linkUI=null,this.resizingRect=null,this.resizeDirection=null,this.pointIndex=-1,this._removeCursor(),this.oldCursor=null,this.network.repaintTopCanvas()},_removeCursor:function(){this.cursorID&&(this.network.getView().style.cursor=this.oldCursor||\"default\",this.cursorID=null),this.resizeDirection=null,this.isCrossCursor=!1},_setCrossCursor:function(){this.isCrossCursor||(this._removeCursor(),this._setCursor(\"crosshair\"),this.isCrossCursor=!0)},_setCursor:function(t){this.cursorID=t,this.network.getView().style.cursor!==this.cursorID&&(this.network.getView().style.cursor=this.cursorID)},isKeyDown:function(t){return D.isAltDown(t)},handle_mousedown:function(t){if(0===t.button)if(!this.isKeyDown(t)||this.network.isEditingElement())!this.network.isEditingElement()||this.isStart||this.isStartRotate||(this.node&&this.resizeDirection?(this.isStart=!0,this._handle_mousedown(t),this.network.fireInteractionEvent({kind:this.lazyMode?\"lazyResizeStart\":\"liveResizeStart\",event:t,element:this.node,resizeDirection:this.resizeDirection})):this.shapeNode&&this.pointIndex>=0?this.isKeyDown(t)?(this.shapeNode.removeAt(this.pointIndex),this.network.fireInteractionEvent({kind:\"removePoint\",event:t,element:this.shapeNode})):(this.isStart=!0,this._handle_mousedown(t),this.network.fireInteractionEvent({kind:\"liveMovePointStart\",event:t,element:this.shapeNode,pointIndex:this.pointIndex})):this.shapeLink?this.isKeyDown(t)?this.pointIndex>=0&&(this.shapeLink.removeAt(this.pointIndex),this.network.fireInteractionEvent({kind:\"removePoint\",event:t,element:this.shapeLink})):(this.isStart=!0,this._handle_mousedown(t),this.network.fireInteractionEvent({kind:\"liveMovePointStart\",event:t,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI?(this.isStart=!0,this.network.fireInteractionEvent({kind:\"liveMovePointStart\",event:t,element:this.linkUI._element})):this.node&&(this.isStartRotate=!0,this._handle_mousedown(t)));else{var e=this.network.getElementAt(t),i=this.network.getLogicalPoint2(t);if(e instanceof R.ShapeNode){(o=this.getPointIndex(this.network.getShapeNodeZoomPoints(e),i,!0))>0&&(this._handle_mousedown(t),this.pointIndex=o,this.shapeNode=e,e.addPoint(i,o),this._setCrossCursor(),this.network.setEditingElement(!0),this.isStart=!0,this.network.fireInteractionEvent({kind:\"addPoint\",event:t,element:e,pointIndex:o}),this.network.fireInteractionEvent({kind:\"liveMovePointStart\",event:t,element:e,pointIndex:o}))}if(e instanceof R.ShapeLink){var n=new R.List(e.getPoints()),s=this.network.getElementUI(e);n.add(s.getFromPoint(),0),n.add(s.getToPoint());var o;(o=this.getPointIndex(n,i)-1)>0&&(this._handle_mousedown(t),this.pointIndex=o,this.shapeLink=e,e.addPoint(i,o),this._setCrossCursor(),this.network.setEditingElement(!0),this.isStart=!0,this.network.fireInteractionEvent({kind:\"addPoint\",event:t,element:e,pointIndex:o}),this.network.fireInteractionEvent({kind:\"liveMovePointStart\",event:t,element:e,pointIndex:o}))}}},handle_mouseup:function(t){if(this.isStart){var e=this.network.getLogicalPoint2(t);if(this.resizingRect)if(this.lazyMode)if(this.network.isResizeAnimate()){var i=this,n=new R.animate.AnimateBounds(this.node,this.resizingRect,function(){i.network.fireInteractionEvent({kind:\"lazyResizeEnd\",event:t,element:i.node,resizeDirection:i.resizeDirection}),i.clear()});R.animate.AnimateManager.start(n)}else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:\"lazyResizeEnd\",event:t,element:this.node,resizeDirection:this.resizeDirection});else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:\"liveResizeEnd\",event:t,element:this.node,resizeDirection:this.resizeDirection});else this.shapeNode&&this.pointIndex>=0&&e?(this._resetShapeNodePoints(e),this.network.fireInteractionEvent({kind:\"liveMovePointEnd\",event:t,element:this.shapeNode,pointIndex:this.pointIndex})):e&&(this.shapeLink||this.linkUI)&&(\"from\"===this.linkPointsType?this._setFromPoint(e):\"to\"===this.linkPointsType?this._setToPoint(e):\"shapeControl\"===this.linkPointsType?(this._resetShapeLinkPoints(e),this.network.fireInteractionEvent({kind:\"liveMovePointEnd\",event:t,element:this.shapeLink,pointIndex:this.pointIndex})):\"control\"===this.linkPointsType&&pt.isOrthogonalLink(this.linkUI._element)&&this.linkUI.getControlPoint()&&(this._setLinkControlPoint(e),this.network.fireInteractionEvent({kind:\"liveMovePointEnd\",event:t,element:this.linkUI._element})))}this._handle_mouseup(t),this.clear()},handle_mousemove:function(t){var e=this.network.getEditPointSize();if(this.network.isValidEvent(t)){if(this.isStartRotate&&this.node)return this._handleRotateElement(t,this.node),void(this.network.isShowRotateScale()&&this.repaint());if(this.isStart){if(this.shapeNode&&this.pointIndex>=0)return void this._handleMovingShapeNodePoint(t);if(this.node&&this.resizeDirection)return void this._handleResizing(t);if((this.shapeLink||this.linkUI)&&this.linkPointsType){if(\"from\"===this.linkPointsType)return void this._handleMovingFromPoint(t);if(\"to\"===this.linkPointsType)return void this._handleMovingToPoint(t);if(\"shapeControl\"===this.linkPointsType)return void this._handleMovingShapeLinkPoint(t);if(\"control\"===this.linkPointsType&&pt.isOrthogonalLink(this.linkUI._element)&&this.linkUI.getControlPoint())return void this._handleMovingLinkControlPoint(t)}}if(this.network.isSelectingElement()||this.network.isMovingElement()||0===this.network.getSelectionModel().size())this.clear();else{var i=this.network.getElementAt(t),n=this.network.getElementUI(i);if(n&&n.getEditAttachment()){var s=this.network.getLogicalPoint2(t);if(i instanceof R.Node){if(this.node=i,this._isEditingShapeNode(s)||this._isResizingNode(s))return void this.network.setEditingElement(!0);if(this._isRotatingElement(s))return this.network.setRotatingElement(!0),void this.network.setEditingElement(!0)}else if(i instanceof R.Link){i instanceof R.ShapeLink?this.shapeLink=i:n instanceof R.vector.LinkUI&&(this.linkUI=n);var o=n.getFromPoint(),r=n.getToPoint();if(o&&this._contains(s,o,e))return this.linkPointsType=\"from\",this._setCrossCursor(),this._fromPoint=o,this._fromOffset={x:i.getStyle(\"link.from.xoffset\"),y:i.getStyle(\"link.from.yoffset\")},void this.network.setEditingElement(!0);if(r&&this._contains(s,r,e))return this.linkPointsType=\"to\",this._setCrossCursor(),this._toPoint=r,this._toOffset={x:i.getStyle(\"link.to.xoffset\"),y:i.getStyle(\"link.to.yoffset\")},void this.network.setEditingElement(!0);if(i instanceof R.ShapeLink){if(this._isEditingShapeLink(s))return this.linkPointsType=\"shapeControl\",void this.network.setEditingElement(!0)}else if(n instanceof R.vector.LinkUI){if(pt.isOrthogonalLink(n._element)){var a=this.linkUI.getControlPoint();if(a&&this._contains(s,a,e))return this.linkPointsType=\"control\",this._setCrossCursor(),void this.network.setEditingElement(!0)}return void(this.linkPointsType=null)}this.linkPointsType=null}this.clear()}else this.clear()}}},_isRotatingElement:function(t){if(this.network.getRotatePointSize()<=0)return!1;var e=this.network.zoomManager,i=this.network.getElementUI(this.node),n=e.getSizeZoom(i),s=e._getElementZoomRect(i,this.node.getOriginalRect()),o=this.node.getAngle();return this._isRotating(t,\"crosshair\",s,o,n)},_isRotating:function(t,e,i,n,s){var o=this.network.getRotatePointSize()/this.network.getGraphicsZoom(),r={x:i.x+i.width/2,y:i.y-this.network.getRotatePointOffset()/this.network.getGraphicsZoom()-o},a=this._rotatePoint(r,n,i),h={x:a.x-o,y:a.y-o,width:2*o,height:2*o};return!!W.containsPoint(h,t)&&(this._removeCursor(),this._setCursor(e),!0)},_handleRotateElement:function(t,e){this._handle_mousemove(t);var i=this._calculateAngle(this.network.getLogicalPoint2(t),e);e.setAngle(i)},_calculateAngle:function(t,e){var i=this.network.getZoomBodyRect(e),n=W.getCenterPoint(i);return Math.round(180*Math.atan2(n.x-t.x,t.y-n.y)/Math.PI+180)},_resetShapeNodePoints:function(t){var e=this.network.getShapeNodeZoomPoints(this.shapeNode);e.set(this.pointIndex,t);var i=this.network.getElementUI(this.shapeNode),n=this.network.zoomManager._getShapeNodeZoomPoints(i,e,!0);this.shapeNode.setPoints(n)},_handleMovingShapeNodePoint:function(t){var e=this.network.getLogicalPoint2(t);this._resetShapeNodePoints(e),this.network.fireInteractionEvent({kind:\"liveMovePointBetween\",e:t,element:this.shapeNode,pointIndex:this.pointIndex})},_resetShapeLinkPoints:function(t){var e=this.network.zoomManager._getShapeLinkZoomPoints(this.shapeLink._points);e.set(this.pointIndex,t);var i=this.network.zoomManager._getShapeLinkZoomPoints(e,!0);this.shapeLink.setPoints(i)},_handleMovingShapeLinkPoint:function(t){var e=this.network.getLogicalPoint2(t);this._resetShapeLinkPoints(e),this.network.fireInteractionEvent({kind:\"liveMovePointBetween\",e:t,element:this.shapeLink,pointIndex:this.pointIndex})},_setLinkControlPoint:function(t){var e=this.linkUI.getControlPoint(),i=this.linkUI.getControlPoint(),n=(this.network.zoomManager,t.x-i.x),s=t.y-i.y;e.x+=n,e.y+=s,this.linkUI.setControlPoint(e)},_handleMovingLinkControlPoint:function(t){var e=this.network.getLogicalPoint2(t);this._setLinkControlPoint(e),this.network.fireInteractionEvent({kind:\"liveMovePointBetween\",e:t,element:this.linkUI._element})},_setFromPoint:function(t){var e;if(this.linkUI)e=this.linkUI._element;else{if(!this.shapeLink)return;e=this.shapeLink}var i=t.x-this._fromPoint.x,n=t.y-this._fromPoint.y;e.setStyle(\"link.from.xoffset\",this._fromOffset.x+i),e.setStyle(\"link.from.yoffset\",this._fromOffset.y+n)},_handleMovingFromPoint:function(t){var e=this.network.getLogicalPoint2(t);this._setFromPoint(e)},_setToPoint:function(t){var e;if(this.linkUI)e=this.linkUI._element;else{if(!this.shapeLink)return;e=this.shapeLink}var i=t.x-this._toPoint.x,n=t.y-this._toPoint.y;e.setStyle(\"link.to.xoffset\",this._toOffset.x+i),e.setStyle(\"link.to.yoffset\",this._toOffset.y+n)},_handleMovingToPoint:function(t){var e=this.network.getLogicalPoint2(t);this._setToPoint(e)},convertFromUIToMarkerRect:function(t,e,i,n){var s=this.network.zoomManager,o=s.getLocationZoom(),r=s.getGraphicsZoom(),a=this.network.getElementUI(n),h=s.getSizeZoom(a),l=t.x+t.width/2,c=t.y+t.height/2,d=l-t.x,u=c-t.y;return{x:l*o*r-this.network.getViewRect().x+e*o*r-d*h*r,y:c*o*r-this.network.getViewRect().y+i*o*r-u*h*r,width:t.width*h*r,height:t.height*h*r}},_getReverseZoomPoint:function(t,e,i){var n=this.network.zoomManager,s=n.getLocationZoom(),o=n.getSizeZoom(this.network.getElementUI(t));return e.x*=s,e.y*=s,{x:e.x/s+(i.x-e.x)/o,y:e.y/s+(i.y-e.y)/o}},_getReverseZoomRect:function(t,e){var i=this.network.zoomManager,n=i.getLocationZoom(),s=i.getSizeZoom(o);if(n==s)return t;var o=this.network.getElementUI(e),r=o.getBodyRect(),a=r.x+r.width/2,h=r.y+r.height/2,l=a*n+(t.x-a)*s,c=h*n+(t.y-h)*s;return a=l+t.width*s/2,h=c+t.height*s/2,{x:a/n+(l-a)*s,y:h/n+(c-h)*s,width:t.width,height:t.height}},_handleResizing:function(t){this._handle_mousemove(t);var e=this.node.getAngle(),i=this.node.getLocation(),n=this.node.getWidth()/2,s=this.node.getHeight()/2,o={x:i.x+n,y:i.y+s},r={x:-n,y:-s},a={x:-n,y:s},h={x:n,y:s},l={x:n,y:-s},c={x:0,y:-s},d={x:n,y:0},u={x:0,y:s},_={x:-n,y:0},g=this._getReverseZoomPoint(this.node,D.clone(o),this._endLogical);if(\"northwest\"===this.resizeDirection&&(this._transformPoint(h,o,e),r.x=g.x,r.y=g.y,o.x=(r.x+h.x)/2,o.y=(r.y+h.y)/2,this._reversPoint(r,o,e),this._reversPoint(h,o,e),this.resizingRect={x:r.x,y:r.y,width:h.x-r.x,height:h.y-r.y},D.isShiftDown(t)&&this._revertResizeRect(this.node,this.resizingRect,1)),\"north\"===this.resizeDirection){var f={x:g.x,y:g.y};this._reversPoint(f,o,e),c.y=f.y-o.y,this._transformPoint(c,o,e),this._transformPoint(u,o,e),o.x=(c.x+u.x)/2,o.y=(c.y+u.y)/2,this._reversPoint(c,o,e),this._reversPoint(u,o,e),this.resizingRect={x:o.x-this.node.getWidth()/2,y:o.y-(u.y-c.y)/2,width:this.node.getWidth(),height:u.y-c.y}}if(\"northeast\"===this.resizeDirection&&(this._transformPoint(a,o,e),l.x=g.x,l.y=g.y,o.x=(a.x+l.x)/2,o.y=(a.y+l.y)/2,this._reversPoint(a,o,e),this._reversPoint(l,o,e),this.resizingRect={x:a.x,y:l.y,width:l.x-a.x,height:a.y-l.y},D.isShiftDown(t)&&this._revertResizeRect(this.node,this.resizingRect,2)),\"west\"===this.resizeDirection){f={x:g.x,y:g.y};this._reversPoint(f,o,e),_.x=f.x-o.x,this._transformPoint(d,o,e),this._transformPoint(_,o,e),o.x=(d.x+_.x)/2,o.y=(d.y+_.y)/2,this._reversPoint(d,o,e),this._reversPoint(_,o,e),this.resizingRect={x:o.x-(d.x-_.x)/2,y:o.y-this.node.getHeight()/2,width:d.x-_.x,height:this.node.getHeight()}}if(\"east\"===this.resizeDirection){f={x:g.x,y:g.y};this._reversPoint(f,o,e),d.x=f.x-o.x,this._transformPoint(d,o,e),this._transformPoint(_,o,e),o.x=(d.x+_.x)/2,o.y=(d.y+_.y)/2,this._reversPoint(d,o,e),this._reversPoint(_,o,e),this.resizingRect={x:o.x-(d.x-_.x)/2,y:o.y-this.node.getHeight()/2,width:d.x-_.x,height:this.node.getHeight()}}if(\"southwest\"===this.resizeDirection&&(this._transformPoint(l,o,e),a.x=g.x,a.y=g.y,o.x=(a.x+l.x)/2,o.y=(a.y+l.y)/2,this._reversPoint(a,o,e),this._reversPoint(l,o,e),this.resizingRect={x:a.x,y:l.y,width:l.x-a.x,height:a.y-l.y},D.isShiftDown(t)&&this._revertResizeRect(this.node,this.resizingRect,4)),\"south\"===this.resizeDirection){f={x:g.x,y:g.y};this._reversPoint(f,o,e),u.y=f.y-o.y,this._transformPoint(c,o,e),this._transformPoint(u,o,e),o.x=(c.x+u.x)/2,o.y=(c.y+u.y)/2,this._reversPoint(c,o,e),this._reversPoint(u,o,e),this.resizingRect={x:o.x-this.node.getWidth()/2,y:o.y-(u.y-c.y)/2,width:this.node.getWidth(),height:u.y-c.y}}\"southeast\"===this.resizeDirection&&(this._transformPoint(r,o,e),h.x=g.x,h.y=g.y,o.x=(r.x+h.x)/2,o.y=(r.y+h.y)/2,this._reversPoint(r,o,e),this._reversPoint(h,o,e),this.resizingRect={x:r.x,y:r.y,width:h.x-r.x,height:h.y-r.y},D.isShiftDown(t)&&this._revertResizeRect(this.node,this.resizingRect,3)),this.resizingRect=this._getReverseZoomRect(this.resizingRect,this.node),this.lazyMode?(this.repaint(),this.network.fireInteractionEvent({kind:\"lazyResizeBetween\",event:t,element:this.node,resizeDirection:this.resizeDirection})):(this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.network.fireInteractionEvent({kind:\"liveResizeBetween\",event:t,element:this.node,resizeDirection:this.resizeDirection}))},_revertResizeRect:function(t,e,i){var n=t.getOriginalRect(),s=Math.max(e.width/n.width,e.height/n.height),o=n.width*s,r=n.height*s,a=e.x,h=e.y;1==i?(a+=e.width-o,h+=e.height-r):2==i?h+=e.height-r:3==i||4==i&&(a+=e.width-o),e.x=a,e.y=h,e.width=o,e.height=r},_isEditingShapeNode:function(t){var e=this.network.getEditPointSize();if(this.node instanceof R.ShapeNode){this.shapeNode=this.node;for(var i=this.network.getShapeNodeZoomPoints(this.node),n=0,s=i.size();n<s;n++){var o=i.get(n);if(this._contains(t,o,e))return this._setCrossCursor(),this.pointIndex=n,!0}}return this.pointIndex=-1,!1},_isEditingShapeLink:function(t){for(var e=this.network.getEditPointSize(),i=this.network.zoomManager._getShapeLinkZoomPoints(this.shapeLink.getPoints()),n=0,s=i.size();n<s;n++){var o=i.get(n);if(this._contains(t,o,e))return this._setCrossCursor(),this.pointIndex=n,!0}return this.pointIndex=-1,!1},_isResizingNode:function(t){if(this.network.getResizePointSize()<=0)return!1;var e=this.network.zoomManager,i=this.network.getElementUI(this.node),n=e._getElementZoomRect(i,this.node.getOriginalRect()),s=this.node.getAngle(),o={x:n.x,y:n.y},r=this._rotatePoint(o,s,n);return!!this._isResizing(t,r.x,r.y,\"northwest\",\"nwse-resize\")||(o={x:n.x+n.width/2,y:n.y},r=this._rotatePoint(o,s,n),!!this._isResizing(t,r.x,r.y,\"north\",\"ns-resize\")||(o={x:n.x+n.width,y:n.y},r=this._rotatePoint(o,s,n),!!this._isResizing(t,r.x,r.y,\"northeast\",\"nesw-resize\")||(o={x:n.x,y:n.y+n.height/2},r=this._rotatePoint(o,s,n),!!this._isResizing(t,r.x,r.y,\"west\",\"ew-resize\")||(o={x:n.x+n.width,y:n.y+n.height/2},r=this._rotatePoint(o,s,n),!!this._isResizing(t,r.x,r.y,\"east\",\"ew-resize\")||(o={x:n.x,y:n.y+n.height},r=this._rotatePoint(o,s,n),!!this._isResizing(t,r.x,r.y,\"southwest\",\"nesw-resize\")||(o={x:n.x+n.width/2,y:n.y+n.height},r=this._rotatePoint(o,s,n),!!this._isResizing(t,r.x,r.y,\"south\",\"ns-resize\")||(o={x:n.x+n.width,y:n.y+n.height},r=this._rotatePoint(o,s,n),!!this._isResizing(t,r.x,r.y,\"southeast\",\"nwse-resize\"))))))))},_rotatePoint:function(t,e,i){return W.createMatrix(e*Math.PI/180,i.x+i.width/2,i.y+i.height/2).transform(t)},_isResizing:function(t,e,i,n,s){var o=this.network.getGraphicsZoom(),r=this.network.getResizePointSize()/o;return!!this._contains(t,{x:e,y:i},r)&&(this.resizeDirection!==n&&(this._removeCursor(),s=this._changeCursorWithAngle(n,this.node.getAngle()),this._setCursor(s),this.resizeDirection=n),!0)},_getRect:function(t,e,i,n){return{x:t<i?t:i,y:e<n?e:n,width:Math.abs(t-i),height:Math.abs(e-n)}},_contains:function(t,e,i){var n={x:e.x-i,y:e.y-i,width:2*i,height:2*i};return W.containsPoint(n,t)},getPointIndex:function(t,e,i){if(t.size()<2)return 0;for(var n,s=t.get(0),o=1;o<t.size();o++){if(n=t.get(o),this.isPointOnLine(e,s,n,6))return o;s=n}return s=t.get(0),i&&this.isPointOnLine(e,s,n,6)?t.size():0},showRotateScale:function(t){new R.List;var e,i,n,s,o=this.network.getRotateScaleWidth(),r=this.network.getRotateScaleHeight(),a=this.network.getRotatePointSize(),h=this.node.getAngle(),l=this.network.zoomManager,c=this.network.getElementUI(this.node),d=l._getElementZoomRect(c,this.node.getOriginalRect()),u={x:d.x+d.width/2,y:d.y-this.network.getRotatePointOffset()-a},_=this._rotatePoint(u,h,d),g=h+\"\",f=this.network.getViewRect();1===l.getLocationZoom()&&(t.translate(-f.x,-f.y),t.scale(this.network.getZoom(),this.network.getZoom())),this.node.getAngle()>=0&&this.node.getAngle()<=180?(n={x:(i={x:(e={x:_.x+a,y:_.y}).x+o,y:e.y}).x,y:i.y-r},s={x:e.x,y:n.y}):this.node.getAngle()>180&&this.node.getAngle()<=360&&(n={x:(i={x:(e={x:_.x-a,y:_.y}).x-o,y:e.y}).x,y:i.y-r},s={x:e.x,y:n.y});var v=new R.List([e,i,n,s]),m=D.math.getRect(v);1!==l.getLocationZoom()&&(m.x-=f.x,m.y-=f.y),t.fillStyle=this.network.getRotateScaleFillColor(),t.fillRect(m.x,m.y,m.width,m.height),t.fillStyle=this.network.getRotateScaleFontColor(),t.textBaseline=\"middle\",t.textAlign=\"center\",t.font=\"13px Arial\",t.fillText(g,m.x+m.width/2,m.y+m.height/2),1===l.getLocationZoom()&&(t.scale(1/this.network.getZoom(),1/this.network.getZoom()),t.translate(f.x,f.y))},isPointOnLine:function(t,e,i,n){n<0&&(n=0);return this.getDistanceFromPointToLine(t,e,i)<=n&&t.x>=Math.min(e.x,i.x)-n&&t.x<=Math.max(e.x,i.x)+n&&t.y>=Math.min(e.y,i.y)-n&&t.y<=Math.max(e.y,i.y)+n},getDistanceFromPointToLine:function(t,e,i){if(e.x===i.x)return Math.abs(t.x-e.x);var n=(i.y-e.y)/(i.x-e.x),s=(i.x*e.y-e.x*i.y)/(i.x-e.x);return Math.abs(n*t.x-t.y+s)/Math.sqrt(n*n+1)},_transformPoint:function(t,e,i){var n=Math.cos(i*Math.PI/180),s=Math.sin(i*Math.PI/180),o=t.x,r=t.y,a=o*n-r*s,h=o*s+r*n;t.x=a+e.x,t.y=h+e.y},_reversPoint:function(t,e,i){i*=-1;var n=Math.cos(i*Math.PI/180),s=Math.sin(i*Math.PI/180),o=t.x-e.x,r=t.y-e.y,a=o*n-r*s,h=o*s+r*n;t.x=a+e.x,t.y=h+e.y},_changeCursorWithAngle:function(t,e){var i;switch(t){case\"northwest\":i=1;break;case\"north\":i=2;break;case\"northeast\":i=3;break;case\"east\":i=4;break;case\"southeast\":i=5;break;case\"south\":i=6;break;case\"southwest\":i=7;break;case\"west\":i=8;break;default:i=0}return(e>=360||e<=-360)&&(e%=360),e>22.5&&e<=67.5&&(i+=1),e<-22.5&&e>=-67.5&&(i-=1),e>67.5&&e<=112.5&&(i+=2),e<-67.5&&e>=-112.5&&(i-=2),e>112.5&&e<=157.5&&(i+=3),e<-112.5&&e>=-157.5&&(i-=3),e>157.5&&e<=202.5&&(i+=4),e<-157.5&&e>=-202.5&&(i-=4),e>202.5&&e<=247.5&&(i+=5),e<-202.5&&e>=-247.5&&(i-=5),e>247.5&&e<=292.5&&(i+=6),e<-247.5&&e>=-292.5&&(i-=6),e>292.5&&e<=337.5&&(i+=7),e<-292.5&&e>=-337.5&&(i-=7),i>8&&(i-=8),i<=0&&(i+=8),[\"auto\",\"nwse-resize\",\"ns-resize\",\"nesw-resize\",\"ew-resize\",\"nwse-resize\",\"ns-resize\",\"nesw-resize\",\"ew-resize\"][i]}}),R.vector.interaction.MoveLinkInteraction=function(t,e){R.vector.interaction.MoveLinkInteraction.superClass.constructor.call(this,t),this.xoffset=0,this.yoffset=0},D.ext(\"twaver.vector.interaction.MoveLinkInteraction\",R.vector.interaction.BaseInteraction,{setUp:function(){this.addListener(\"mousedown\"),this.oldCursor=this.network.getView().style.cursor},tearDown:function(){this.removeListener(\"mousedown\"),this.network.getView().style.cursor=this.oldCursor,this.end()},handle_mousedown:function(t){if(0===t.button&&!this.network.isSelectingElement()&&!this.network.isEditingElement()){var e=this.network.getElementAt(t);e instanceof R.Link&&(this.element=e,this.end(t),this._handle_mousedown(t))}},handle_mouseup:function(t){this.end(t)},handle_mousemove:function(t){if(!this._startLogical||this.network.isSelectingElement()||this.network.isEditingElement())this.end(t);else if(this._handle_mousemove(t),this.xoffset=this._endLogical.x-this._startLogical.x,this.yoffset=this._endLogical.y-this._startLogical.y,this.lazyMode){if(this.mark)this.network.fireInteractionEvent({kind:\"lazyMoveBetween\",event:t,element:this.element});else{this.mark=X.createCanvas();var e;this.network.getMovableSelectedElements().forEach(function(t){var i=this.getElementUI(t);i&&(e=W.unionRect(e,i.getViewRect()))},this.network),this.network.getTopDiv().appendChild(this.mark),this.network.setMovingElement(!0),X.setDiv(this.mark,e,this.network.isLazyMoveFill()?this.network.getLazyMoveFillColor():null,this.network.getLazyMoveOutlineWidth(),this.network.getLazyMoveOutlineColor()),this.network.fireInteractionEvent({kind:\"lazyMoveStart\",event:t,element:this.element})}this.mark.style.left=this.xoffset+this.mark._viewRect.x+\"px\",this.mark.style.top=this.yoffset+this.mark._viewRect.y+\"px\"}else{var i=new R.List([this.element.getFromNode(),this.element.getToNode()]);R.Util.moveElements(i,this.xoffset,this.yoffset),this._startLogical=this._endLogical,this._startClient=X.getClientPoint(t),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:\"liveMoveBetween\",event:t,element:this.element}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:\"liveMoveStart\",event:t,element:this.element}))}},end:function(t){if(this._startLogical){if(this.lazyMode){if(this.mark){var e=this,i=new R.List([this.element.getFromNode(),this.element.getToNode()]);R.Util.moveElements(i,this.xoffset,this.yoffset,this.network.isLazyMoveAnimate(),function(){e.network.fireInteractionEvent({kind:\"lazyMoveEnd\",event:t,element:this.element}),e.mark&&(e.network.getTopDiv().removeChild(e.mark),e.mark=null,e.network.setMovingElement(!1))})}}else this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:\"liveMoveEnd\",event:t,element:this.element}));this._handle_mouseup(t),delete this.element}}}),R.vector.interaction.CreateLinkInteraction=function(t,e){e||(e=R.Link),R.Util.isTypeOf(e,R.Link)?this.linkFunction=function(t,i){var n=new e;return n instanceof R.Link&&(n.setFromNode(t),n.setToNode(i)),n}:this.linkFunction=e,R.vector.interaction.CreateLinkInteraction.superClass.constructor.call(this,t)},D.ext(\"twaver.vector.interaction.CreateLinkInteraction\",R.vector.interaction.BaseInteraction,{setUp:function(){this.addListener(\"mousedown\",\"mousemove\"),this.network.addMarker(this)},tearDown:function(){this.removeListener(\"mousedown\",\"mousemove\"),this.clear(),this.network.removeMarker(this)},paint:function(t){t.beginPath();var e,i;t.lineWidth=this.network.getEditLineWidth();var n=this.network.getEditLineColor();this.currentNode&&this.currentNode!==this.fromNode&&(e=this.network.getElementUI(this.currentNode).getZoomViewRect(!0),i=this.convertFromUIToMarkerRect(e,0,0),Me.rect(t,i.x,i.y,i.width,i.height,null,n)),this.fromNode&&(e=this.network.getElementUI(this.fromNode).getZoomViewRect(!0),i=this.convertFromUIToMarkerRect(e,0,0),Me.rect(t,i.x,i.y,i.width,i.height,null,n)),this.currentPoint&&this.paintLine(t),t.closePath()},convertFromUIToMarkerRect:function(t,e,i){var n=this.network.zoomManager.getGraphicsZoom();return{x:t.x*n-this.network.getViewRect().x+e*n,y:t.y*n-this.network.getViewRect().y+i*n,width:t.width*n,height:t.height*n}},getZoomNodeRectOrPoint:function(t,e){var i=this.network.getElementUI(t).getZoomBodyRect();return e?{x:i.x+i.width/2,y:i.y+i.height/2}:i},paintLine:function(t){var e=this.network.getEditLineColor(),i=this.network.getElementUI(this.fromNode).getZoomBodyRect(),n=this.convertPointFromView({x:i.x+i.width/2,y:i.y+i.height/2}),s=n.x,o=n.y,r=this.currentPoint.x,a=this.currentPoint.y;t.strokeStyle=e,t.beginPath(),t.moveTo(s,o),t.lineTo(r,a),t.stroke()},clear:function(){this.currentPoint=null,this.currentNode=null,this.fromNode=null,this.toNode=null},createLink:function(){return this.linkFunction(this.fromNode,this.toNode)},handle_mousedown:function(t){if(this.network.isValidEvent(t))if(this.fromNode){if(this.toNode=this.currentNode,this.toNode){var e=this.createLink();e&&this.network.addElementByInteraction(e)}this.clear()}else this.fromNode=this.currentNode,this.currentNode=null,this.currentPoint=null,this.repaint()},handle_mousemove:function(t){var e=this.getMarkerPoint(t);if(e)if(this.network.isMovingElement()||this.network.isEditingElement())this.clear();else{var i=null;this.fromNode?(this.currentNode=this.getToNode(t,this.fromNode),this.currentPoint=e,this.repaint()):(i=this.getFromNode(t),this.currentNode!==i&&(this.currentNode=i,this.repaint()))}},getFromNode:function(t){return this.getNode(t)},getToNode:function(t,e){return this.getNode(t,e)},getNode:function(t,e){var i=this.network.getElementAt(t);return i instanceof Pe&&this.network.isLinkable(i,e)&&this.network.getElementBox().getSelectionModel().isSelectable(i)?i:null}}),R.vector.interaction.CreateShapeLinkInteraction=function(t,e){R.vector.interaction.CreateShapeLinkInteraction.superClass.constructor.call(this,t),e||(e=R.ShapeLink),R.Util.isTypeOf(e,R.ShapeLink)?this.linkFunction=function(t,i,n){var s=new e;if(s instanceof R.ShapeLink&&(s.setFromNode(t),s.setToNode(i),n)){var o=this.network.zoomManager;s.setPoints(o._getShapeLinkZoomPoints(n,!0))}return s}:this.linkFunction=e},D.ext(\"twaver.vector.interaction.CreateShapeLinkInteraction\",R.vector.interaction.CreateLinkInteraction,{clear:function(){this.points=null,R.vector.interaction.CreateShapeLinkInteraction.superClass.clear.call(this)},createLink:function(){return this.linkFunction(this.fromNode,this.toNode,this.points)},handle_mousedown:function(t){if(0===t.button){var e=this.network.getLogicalPoint2(t);if(e){if(this.fromNode)if(this.toNode=this.currentNode,this.toNode){var i=this.createLink();i&&this.network.addElementByInteraction(i),this.clear()}else{if(this.points||(this.points=new R.List),this.points.size()>0){var n=this.points.get(this.points.size()-1);if(n.x===e.x&&n.y===e.y)return}this.points.add(e)}else this.fromNode=this.currentNode,this.points=null,this.currentNode=null,this.currentPoint=null;this.repaint()}}},paintLine:function(t){if(this.currentPoint){var e,i=new R.List;if(e=this.convertPointFromView(this.getZoomNodeRectOrPoint(this.fromNode,!0)),i.add(e,0),this.points&&this.points.size()>0)for(var n=this.points.size(),s=0;s<n;s++)e=this.convertPointFromView(this.points.get(s)),i.add(e);e=this.currentPoint,i.add(e),t.lineWidth=this.network.getEditLineWidth(),t.strokeStyle=this.network.getEditLineColor(),t.beginPath(),Y.drawLinePoints(t,i),t.stroke()}}}),R.vector.interaction.CreateShapeNodeInteraction=function(t,e){e||(e=R.ShapeNode),R.Util.isTypeOf(e,R.ShapeNode)?this.shapeNodeFunction=function(t){var i=new e;if(i instanceof R.ShapeNode){var n=this.network.zoomManager,s=this.network.createElementUI(i);if(t){var o=n._getShapeNodeZoomPoints(s,t,!0);s.invalidateZoom(),i.setPoints(o)}}return i}:this.shapeNodeFunction=e,R.vector.interaction.CreateShapeNodeInteraction.superClass.constructor.call(this,t),this.timeStamp=-1},D.ext(\"twaver.vector.interaction.CreateShapeNodeInteraction\",R.vector.interaction.BaseInteraction,{setUp:function(){this.addListener(\"mousedown\",\"mousemove\"),this.network.addMarker(this)},tearDown:function(){this.removeListener(\"mousedown\",\"mousemove\"),this.clear(),this.network.removeMarker(this),this.network.setEditingElement(!1)},clear:function(){this.points=null,this.currentPoint=null},paint:function(t){if(this.points&&this.points.size()>0&&this.currentPoint){for(var e,i=new R.List,n=this.points.size(),s=0;s<n;s++)e=this.convertPointFromView(this.points.get(s)),i.add(e);e=this.convertPointFromView(this.currentPoint),i.add(e),t.lineWidth=this.network.getEditLineWidth(),t.strokeStyle=this.network.getEditLineColor(),t.beginPath(),Y.drawLinePoints(t,i),t.stroke()}},handle_mousedown:function(t){if(0===t.button){var e=this.network.getLogicalPoint2(t);if(e){if(2===t.detail||t.timeStamp-this.timeStamp<300){if(this.points){var i=this.shapeNodeFunction(this.points);this.network.addElementByInteraction(i),this.clear();var n=this;setTimeout(function(){n.network.setEditingElement(!1)},0)}}else{if(this.network.isEditingElement()||this.network.setEditingElement(!0),this.points||(this.points=new R.List),this.points.size()>0){var s=this.points.get(this.points.size()-1);if(s.x===e.x&&s.y===e.y)return}this.points.add(e)}this.timeStamp=t.timeStamp,this.repaint()}}},handle_mousemove:function(t){this.points&&(this.currentPoint=this.network.getLogicalPoint2(t),this.repaint())}}),R.vector.interaction.MagnifyInteraction=function(t,e,i,n,s){R.vector.interaction.MagnifyInteraction.superClass.constructor.call(this,t),this.scale=e||2,this.xRadius=i||100,this.yRadius=n||100,this.shape=s||\"circle\",this.borderColor=\"black\",this.borderWidth=1,this.backgroundColor=\"white\",this.markCanvas=X.createCanvas()},D.ext(\"twaver.vector.interaction.MagnifyInteraction\",R.vector.interaction.BaseInteraction,{setUp:function(){this.addListener(\"mousemove\"),this.addListener(\"mousewheel\"),this.network.addMarker(this)},tearDown:function(){this.removeListener(\"mousemove\"),this.removeListener(\"mousewheel\"),this.network.removeMarker(this)},paint:function(t){if(this.point){var e=this.network.zoomManager,i=e.getLocationZoom(),n=e.getGraphicsZoom(),s=(e.getSizeZoom(),this.network.getZoom(),this.xRadius/this.scale/n),o=this.yRadius/this.scale/n;if(\"mousewheel\"===this.mouseFlag){var r={x:this.zoomPoint.x-s,y:this.zoomPoint.y-o,width:2*s,height:2*o};this.network.toCanvasByRegion(r,this.scale*n,this.markCanvas,\"white\");var a={x:this.zoomPoint.x-this.xRadius-this.network.viewRect.x,y:this.zoomPoint.y-this.yRadius-this.network.viewRect.y,width:this.markCanvas.width,height:this.markCanvas.height}}else{r={x:this.point.x*i-s,y:this.point.y*i-o,width:2*s,height:2*o};this.network.toCanvasByRegion(r,this.scale*n,this.markCanvas,\"white\");a={x:this.point.x*i*n-this.xRadius-this.network.viewRect.x,y:this.point.y*i*n-this.yRadius-this.network.viewRect.y,width:this.markCanvas.width,height:this.markCanvas.height}}t.save(),t.beginPath(),Y.drawVector(t,this.shape,null,a.x,a.y,2*r.width*n,2*r.height*n),t.clip(),t.fillStyle=this.backgroundColor,t.beginPath(),t.rect(a.x,a.y,a.width,a.height),t.fill(),t.drawImage(this.markCanvas,a.x,a.y),t.restore(),t.beginPath(),t.lineWidth=this.borderWidth,Y.drawVector(t,this.shape,null,a.x+this.borderWidth/2,a.y+this.borderWidth/2,2*r.width*n-this.borderWidth,2*r.height*n-this.borderWidth),t.strokeStyle=this.borderColor,t.stroke(),this.mouseFlag=null}},handle_mousemove:function(t){this.point=this.network.getLogicalPoint(t),this.point&&(this.mouseFlag=\"mousemove\",this.repaint())},handle_mousewheel:function(t){1!==this.network.zoomManager.getLocationZoom()&&(this.zoomPoint=this.network.getLogicalPoint2(t)),this.zoomPoint&&(this.mouseFlag=\"mousewheel\",this.repaint())},getScale:function(){return this.scale},setScale:function(t){this.scale=t,this.network.repaintTopCanvas()},getShape:function(){return this.shape},setShape:function(t){this.shape=t,this.network.repaintTopCanvas()},getXRadius:function(){return this.xRadius},setXRadius:function(t){this.xRadius=t,this.network.repaintTopCanvas()},getYRadius:function(){return this.yRadius},setYRadius:function(t){this.yRadius=t,this.network.repaintTopCanvas()},getBorderColor:function(){return this.borderColor},setBorderColor:function(t){this.borderColor=t,this.network.repaintTopCanvas()},getBorderWidth:function(){return this.borderWidth},setBorderWidth:function(t){this.borderWidth=t,this.network.repaintTopCanvas()},getBackgroundColor:function(){return this.backgroundColor},setBackgroundColor:function(t){this.backgroundColor=t,this.network.repaintTopCanvas()}}),R.vector.interaction.TouchInteraction=function(t){R.vector.interaction.TouchInteraction.superClass.constructor.call(this,t)},D.ext(\"twaver.vector.interaction.TouchInteraction\",R.vector.interaction.BaseInteraction,{setUp:function(){var t=this.network.getView();X.addEventListener(\"touchstart\",\"handleTouchstart\",t,this),X.addEventListener(\"touchmove\",\"handleTouchmove\",t,this),X.addEventListener(\"touchend\",\"handleTouchend\",t,this),X.addEventListener(\"touchcancel\",\"handleTouchend\",t,this)},tearDown:function(){var t=this.network.getView();X.removeEventListener(\"touchstart\",t,this),X.removeEventListener(\"touchmove\",t,this),X.removeEventListener(\"touchend\",t,this),X.removeEventListener(\"touchcancel\",t,this)},_isDragToSelect:function(t){return!this.network._dragToPan},handleTouchstart:function(t){if(X.preventDefault(t),this.isMoving=!1,this.isSelecting=!1,1==t.touches.length){var e=this.network.getLogicalPoint2(t),i=this._element=this.network.getElementAt(e);if(this._startTouchTime=new Date,this._currentTouchPoint=e,this._startTouchClient=this._currentTouchClient=this.getMarkerPoint(t),i)if(this.network.getSelectionModel().contains(i))this.isSelecting=!0;else{this.network.getSelectionModel().setSelection(i);this.network.getSelectionModel().contains(i)&&(this.isSelecting=!0)}else this.isSelecting=!1,this.network.getSelectionModel().clearSelection();Ct.handleClicked(this.network,t,i),this._endTouchTime&&this._startTouchTime.getTime()-this._endTouchTime.getTime()<=500&&W.getDistance(this._endTouchClient,this._startTouchClient)<=20?(delete this._endTouchTime,delete this._endTouchClient,Ct.handleDoubleClicked(this.network,t,i)):(this._endTouchTime=this._startTouchTime,this._endTouchClient=this._startTouchClient)}else this._distance=yt.getDistance(t),this._zoom=this.network.getZoom()},handleTouchmove:function(t){if(X.preventDefault(t),t.touches.length>1){var e=yt.getDistance(t);if(Math.abs(e-this._distance)<20)return;var i=e/this._distance;this.network.setZoom(this._zoom*i,!1)}else if(null==this._zoom){var n=this.getMarkerPoint(t);if(W.getDistance(this._startTouchClient,n)<20)return;if(this._element)if(this.isSelecting||this._isDragToSelect(t)){var s=this.network.getLogicalPoint2(t),o=this.getOffset(s,this._currentTouchPoint);r=o.x,a=o.y;this._currentTouchPoint=s,this.network.moveSelectedElements(r,a),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:\"liveMoveBetween\",event:t}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:\"liveMoveStart\",event:t}))}else{var r=this._currentTouchClient.x-n.x,a=this._currentTouchClient.y-n.y;this.network.panByOffset(r,a),this._currentTouchClient=n}else{if(this._isDragToSelect(t))return;r=this._currentTouchClient.x-n.x,a=this._currentTouchClient.y-n.y;this.network.panByOffset(r,a),this._currentTouchClient=n}}},handleTouchend:function(t){X.preventDefault(t),this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:\"liveMoveEnd\",event:t})),0===t.touches.length&&(this._distance=null,this._zoom=null,this._element=null,this._startTouchTime=null,this._currentTouchPoint=null,this._startTouchClient=this._currentTouchClient=null)}}),R.vector.interaction.MSTouchInteraction=function(t){R.vector.interaction.MSTouchInteraction.superClass.constructor.call(this,t),this._pointerMap={},this._pointerIdArray=[]},D.ext(\"twaver.vector.interaction.MSTouchInteraction\",R.vector.interaction.BaseInteraction,{setUp:function(){var t=this.network.getView();X.addEventListener(\"MSPointerDown\",\"handleTouchstart\",t,this),X.addEventListener(\"MSPointerMove\",\"handleTouchmove\",t,this),X.addEventListener(\"MSPointerUp\",\"handleTouchend\",t,this),X.addEventListener(\"MSPointerCancel\",\"handleTouchend\",t,this),this.network.addMarker(this)},tearDown:function(){var t=this.network.getView();X.removeEventListener(\"MSPointerDown\",t,this),X.removeEventListener(\"MSPointerMove\",t,this),X.removeEventListener(\"MSPointerUp\",t,this),X.removeEventListener(\"MSPointerCancel\",t,this),this.network.removeMarker(this)},handleTouchstart:function(t){if(this.network.isFocusOnClick()&&R.Util.setFocus(this.network._view),!this.network.isSelectingElement()||t.pointerType!=t.MSPOINTER_TYPE_MOUSE){var e=this.network.getLogicalPoint2(t),i=new Date;if(t.isPrimary&&this._pointerIdArray.length>0&&this.handle_mouseup(t),this._pointerMap[t.pointerId]||(this._pointerIdArray.push(t.pointerId),this._pointerMap[t.pointerId]=t),1==this._pointerIdArray.length){var n=this.network.getElementAt(e);this._startTouchElement=n,this._startClientPoint={x:t.clientX,y:t.clientY};var s=this.network.getSelectionModel();n?D.isCtrlDown(t)?s.contains(n)?s.removeSelection(n):s.appendSelection(n):s.contains(n)||s.setSelection(n):D.isCtrlDown(t)||s.clearSelection(),Ct.handleClicked(this.network,t,n),this._startTouchTime&&this._startTouchPoint&&i.getTime()-this._startTouchTime.getTime()<=500&&W.getDistance(this._startTouchPoint,e)<=20?(Ct.handleDoubleClicked(this.network,t,n),this._doubleClick=!0):(X.handle_mousedown(this,t),this._startTouchPoint=e,this._startTouchTime=i)}else 2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.network.getZoom())}},handleTouchmove:function(t){if(null!=this._startTouchPoint&&0!=this._pointerIdArray.length&&this._pointerMap[t.pointerId]&&!(W.getDistance({x:this._pointerMap[t.pointerId].pageX,y:this._pointerMap[t.pointerId].pageY},{x:t.pageX,y:t.pageY})<=10)&&(this._pointerMap[t.pointerId]=t,2==this._pointerIdArray.length)){var e=this._getDistance()/this._distance;this.network.setZoom(this._zoom*e,!1)}},handleTouchend:function(t){if(this.network.isMovingElement()&&(this.network.setMovingElement(!1),this.network.fireInteractionEvent({kind:\"liveMoveEnd\",event:t})),this.network.isSelectingElement()){var e=W.getRect([this._startTouchPoint,this._moveTouchPoint]),i=this.network.getElementsAtRect(e,this.getIntersectMode(),this.network.getRectSelectFilter());if(i&&i.size()>0){var n=this.network.getSelectionModel(),s=n.toSelection();i.forEach(function(t){n.contains(t)?s.remove(t):s.add(t)},this),n.setSelection(s)}this.network.fireInteractionEvent({kind:\"selectEnd\",event:t}),this._moveTouchPoint=null,this.network.setSelectingElement(!1),this.repaint()}this._doubleClick&&(delete this._doubleClick,delete this._startTouchPoint,delete this._startTouchTime);for(var o=-1,r=0;r<this._pointerIdArray.length;r++)if(this._pointerIdArray[r]==t.pointerId){o=r;break}o>=0&&this._pointerIdArray.splice(o,1),delete this._pointerMap[t.pointerId],this._moveTouchPoint=null},_getDistance:function(){return W.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})},getIntersectMode:function(){return\"intersect\"===this.network.getSelectMode()||\"contain\"!==this.network.getSelectMode()&&(this._startTouchPoint.x>this._moveTouchPoint.x&&this._startTouchPoint.y>this._moveTouchPoint.y)},handle_mousemove:function(t){var e={x:t.clientX,y:t.clientY};if(!(W.getDistance(this._startClientPoint,e)<3)&&this._startTouchPoint&&1==this._pointerIdArray.length)if(this._moveTouchPoint={x:this._startTouchPoint.x+(e.x-this._startClientPoint.x)/this.network.getZoom(),y:this._startTouchPoint.y+(e.y-this._startClientPoint.y)/this.network.getZoom()},null==this._startTouchElement&&this.network.isRectSelectEnabled()){if(!this.network.getLogicalPoint2(t))return;this.network.setSelectingElement(!0),this._moveTouchPoint?this.network.fireInteractionEvent({kind:\"selectBetween\",event:t}):this.network.fireInteractionEvent({kind:\"selectStart\",event:t}),this.repaint()}else{var i=this.network.getElementAt(this._moveTouchPoint);if(null!=this._startTouchElement||this.network.isRectSelectEnabled()){if(this.network.isMovingElement()||null!=this._startTouchElement&&i==this._startTouchElement&&this.network.getMovableSelectedElements().contains(i)){n=this._moveTouchPoint.x-this._startTouchPoint.x,s=this._moveTouchPoint.y-this._startTouchPoint.y;this.network.moveSelectedElements(n,s),this.network.isMovingElement()?this.network.fireInteractionEvent({kind:\"liveMoveBetween\",event:t}):(this.network.setMovingElement(!0),this.network.fireInteractionEvent({kind:\"liveMoveStart\",event:t}))}}else{var n=this._startClientPoint.x-e.x,s=this._startClientPoint.y-e.y;this.network.panByOffset(n,s)}this._startClientPoint=e}},handle_mouseup:function(t){this.handleTouchend(t),this._pointerIdArray=[],this._pointerMap={}},paint:function(t){if(this._startTouchPoint&&this._moveTouchPoint&&!this._startTouchElement&&this.network.isRectSelectEnabled()){var e=this.convertPointFromView(this._startTouchPoint),i=this.convertPointFromView(this._moveTouchPoint),n=e.x,s=e.y,o=i.x,r=i.y,a=W.getRect([{x:n,y:s},{x:o,y:r}]);if(null!=a){t.beginPath();var h=this.network.getSelectOutlineWidth(),l=this.getIntersectMode()?this.network.getSelectFillColor():null;t.strokeStyle=this.network.getSelectOutlineColor(),t.lineWidth=h,Me.rect(t,a.x,a.y,a.width,a.height,l,this.network.getSelectOutlineColor()),t.closePath()}}}}),R.XmlSerializer=function(t,e,i){this.dataBox=t,this.settings=e||new R.SerializationSettings,this.filterFunction=i,this.ref=0,this.refMap={},this.idMap={},this.xmlString=\"\"},D.ext(\"twaver.XmlSerializer\",Object,{serialize:function(){return this.xmlString=\"<twaver version='\"+R.Util.getVersion()+\"' platform='html5'>\\n\",this.serializeBody(),this.xmlString+=\"</twaver>\\n\",this.xmlString},serializeBody:function(){this.ref=0,this.dataBox.getRoots().forEach(this.initRefs,this),this.settings.isDataBoxSerializable&&(this.xmlString+=\"<dataBox class='\"+this.dataBox.getClassName()+\"'>\\n\",this.dataBox.serializeXml(this,this.dataBox.newInstance()),this.xmlString+=\"</dataBox>\\n\"),this.dataBox.getRoots().forEach(this.serializeData,this)},initRefs:function(t){this.refMap[t.getId()]=this.ref++,t.getChildren().forEach(this.initRefs,this)},isSerializable:function(t){return!!this.dataBox.contains(t)&&!(this.filterFunction&&!this.filterFunction(t))},serializeData:function(t){if(this.isSerializable(t)){var e=t.newInstance(),i=this.refMap[t.getId()];this.xmlString+=\"<data class='\"+t.getClassName()+\"' ref='\"+i+\"'\",null!=this.settings.getPropertyType(\"id\")&&(this.xmlString+=\" id='\"+t.getId()+\"'\"),this.xmlString+=\">\\n\",t.serializeXml(this,e),this.xmlString+=\"</data>\\n\"}t.getChildren().forEach(this.serializeData,this)},serializePropertyXml:function(t,e,i){var n=this.settings.getPropertyType(e);if(n){var s=D.getValue(t,e,n),o=D.getValue(i,e,n);s!==o&&this.serializeValue(\"p\",e,s,o,n)}},serializeStyleXml:function(t,e,i){var n=this.settings.getStyleType(e);if(n){var s=t.getStyle(e),o=i.getStyle(e);s!=o&&this.serializeValue(\"s\",e,s,o,n)}},serializeClientXml:function(t,e,i){var n=this.settings.getClientType(e);if(null!=n){var s=t.getClient(e),o=i.getClient(e);s!=o&&this.serializeValue(\"c\",e,s,o,n)}},serializeValue:function(t,e,i,n,s){if(null==i)this.xmlString+=\"\\t<\"+t+\" n='\"+e+\"' none=''/>\\n\";else if(\"cdata\"===s)this.xmlString+=\"\\t<\"+t+\" n='\"+e+\"'><![CDATA[\"+i+\"]]></\"+t+\">\\n\";else if(\"data\"===s){var o=this.refMap[i.getId()];null!=o&&(this.xmlString+=\"\\t<\"+t+\" n='\"+e+\"' ref='\"+o+\"'/>\\n\")}else\"point\"===s?n&&i.x===n.x&&i.y===n.y||(this.xmlString+=\"\\t<\"+t+\" n='\"+e+\"' x='\"+i.x+\"' y='\"+i.y+\"'/>\\n\"):\"list.point\"===s?(this.xmlString+=\"\\t<\"+t+\" n='\"+e+\"'>\\n\",i.forEach(function(t){this.xmlString+=\"\\t\\t<p x='\"+t.x+\"' y='\"+t.y+\"'/>\\n\"},this),this.xmlString+=\"\\t</\"+t+\">\\n\"):\"list.string\"===s||\"list.number\"===s?(this.xmlString+=\"\\t<\"+t+\" n='\"+e+\"'>\\n\",i.forEach(function(t){this.xmlString+=\"\\t\\t<s>\"+t+\"</s>\\n\"},this),this.xmlString+=\"\\t</\"+t+\">\\n\"):this.xmlString+=\"rectangle\"===s?\"\\t<\"+t+\" n='\"+e+\"' x='\"+i.x+\"' y='\"+i.y+\"' w='\"+i.width+\"' h='\"+i.height+\"'/>\\n\":\"\\t<\"+t+\" n='\"+e+\"'>\"+i+\"</\"+t+\">\\n\"},deserialize:function(t,e){D.isDeserializing=!0,this.xmlString=t;var i=D.xml(t).documentElement;this.refMap={},this.idMap={};var n,s,o,r=new oe,a=new oe,h=i.getElementsByTagName(\"data\"),l=h.length;for(o=0;o<l;o++){var c=(s=h[o]).getAttribute(\"class\"),d=this.settings.getPropertyType(\"id\");if(d&&s.hasAttribute(\"id\")){var u=null;if(\"string\"===d)u=s.getAttribute(\"id\");else if(\"int\"===d)u=parseInt(s.getAttribute(\"id\"));else{if(\"number\"!==d)throw\"Unsupported id type '\"+d+\"'\";u=parseFloat(s.getAttribute(\"id\"))}if(\"remove\"===s.getAttribute(\"action\")){this.dataBox.removeById(u);continue}(n=this.dataBox.getDataById(u))||(n=D.newInstance(c,u))}else n=D.newInstance(c);if(s.hasAttribute(\"ref\")){var _=s.getAttribute(\"ref\");this.refMap[_]=n}r.add(n),a.add(s),this.idMap[n.getId()]=n}for(this.dataBox.forEach(function(t){this.idMap[t.getId()]=t},this),l=r.size(),o=0;o<l;o++)n=r.get(o),s=a.get(o),n.deserializeXml(this,s);for(o=0;o<l;o++)n=r.get(o),this.dataBox.containsById(n.getId())||(e&&!n.getParent()&&n.setParent(e),this.dataBox.add(n));this.settings.isDataBoxSerializable&&1===i.getElementsByTagName(\"dataBox\").length&&this.dataBox.deserializeXml(this,i.getElementsByTagName(\"dataBox\")[0]),D.isDeserializing=!1},deserializePropertyXml:function(t,e,i){var n=this.settings.getPropertyType(i);n&&D.setValue(t,i,this.deserializeValue(e,n))},deserializeStyleXml:function(t,e,i){var n=this.settings.getStyleType(i);n&&t.setStyle(i,this.deserializeValue(e,n))},deserializeClientXml:function(t,e,i){var n=this.settings.getClientType(i);n&&t.setClient(i,this.deserializeValue(e,n))},deserializeValue:function(t,e){if(t.hasAttribute(\"@none\"))return null;if(\"string\"===e)return t.textContent;if(\"number\"===e)return parseFloat(t.textContent);if(\"boolean\"===e)return\"true\"===t.textContent;if(\"int\"===e)return parseInt(t.textContent);if(\"point\"===e)return{x:parseFloat(t.getAttribute(\"x\")),y:parseFloat(t.getAttribute(\"y\"))};if(\"data\"===e){var i=t.getAttribute(\"ref\"),n=this.refMap[i];return n||this.idMap[i]}var s,o,r,a;if(\"list.point\"===e){var h=new oe,l=t.getElementsByTagName(\"p\");for(s=l.length,a=0;a<s;a++){var c=l[a];h.add({x:parseFloat(c.getAttribute(\"x\")),y:parseFloat(c.getAttribute(\"y\"))})}return h}if(\"list.string\"===e){var d=new oe;for(s=(r=t.getElementsByTagName(\"s\")).length,a=0;a<s;a++)d.add(r[a].textContent);return d}if(\"list.number\"===e){for(o=new oe,s=(r=t.getElementsByTagName(\"s\")).length,a=0;a<s;a++)o.add(parseFloat(r[a].textContent));return o}if(\"array.string\"===e)return t.textContent.split(\",\");if(\"array.number\"===e){for(s=(o=t.textContent.split(\",\")).length,a=0;a<s;a++)o[a]=parseFloat(o[a]);return o}return\"rectangle\"===e?{x:parseFloat(t.getAttribute(\"x\")),y:parseFloat(t.getAttribute(\"y\")),width:parseFloat(t.getAttribute(\"w\")),height:parseFloat(t.getAttribute(\"h\"))}:t.textContent}}),D.addMethod(R.Data,{serializeXml:function(t,e){if(t.settings.isClientSerializable&&this._clientMap)for(var i in this._clientMap)this.serializeClientXml(t,i,e);this.serializePropertyXml(t,\"name2\",e),this.serializePropertyXml(t,\"name\",e),this.serializePropertyXml(t,\"icon\",e),this.serializePropertyXml(t,\"toolTip\",e),this.serializePropertyXml(t,\"parent\",e)},serializePropertyXml:function(t,e,i){t.serializePropertyXml(this,e,i)},serializeClientXml:function(t,e,i){t.serializeClientXml(this,e,i)},deserializeXml:function(t,e){var i,n,s,o,r=e.getElementsByTagName(\"p\"),a=r.length;for(i=0;i<a;i++)(n=r[i]).hasAttribute(\"n\")&&this.deserializePropertyXml(t,n,n.getAttribute(\"n\"));if(t.settings.isClientSerializable)for(a=(s=e.getElementsByTagName(\"c\")).length,i=0;i<a;i++)(o=s[i]).hasAttribute(\"n\")&&this.deserializeClientXml(t,o,o.getAttribute(\"n\"))},deserializePropertyXml:function(t,e,i){t.deserializePropertyXml(this,e,i)},deserializeClientXml:function(t,e,i){t.deserializeClientXml(this,e,i)}}),D.addMethod(R.Element,{serializeXml:function(t,e){if(t.settings.isStyleSerializable&&this._styleMap)for(var i in this._styleMap)this.serializeStyleXml(t,i,e);R.Element.superClass.serializeXml.call(this,t,e),this.serializePropertyXml(t,\"layerId\",e),this._alarmState.getHighestNativeAlarmSeverity()&&\"alarmstate\"===t.settings.getPropertyType(\"alarmState\")&&(t.xmlString+=\"\\t<p n='alarmState'>\\n\",R.AlarmSeverity.forEach(function(e){var i=this.getNewAlarmCount(e);i>0&&(t.xmlString+=\"\\t\\t<n n='\"+e.name+\"' c='\"+i+\"'/>\\n\")},this._alarmState),R.AlarmSeverity.forEach(function(e){var i=this.getAcknowledgedAlarmCount(e);i>0&&(t.xmlString+=\"\\t\\t<a n='\"+e.name+\"' c='\"+i+\"'/>\\n\")},this._alarmState),t.xmlString+=\"\\t</p>\\n\")},serializeStyleXml:function(t,e,i){t.serializeStyleXml(this,e,i)},deserializeXml:function(t,e){if(R.Element.superClass.deserializeXml.call(this,t,e),t.settings.isStyleSerializable){var i,n,s=e.getElementsByTagName(\"s\"),o=s.length;for(i=0;i<o;i++)(n=s[i]).hasAttribute(\"n\")&&this.deserializeStyleXml(t,n,n.getAttribute(\"n\"))}},deserializeStyleXml:function(t,e,i){t.deserializeStyleXml(this,e,i)},deserializePropertyXml:function(t,e,i){if(\"alarmState\"===i){if(\"alarmstate\"===t.settings.getPropertyType(\"alarmState\")){var n,s,o,r=e.getElementsByTagName(\"n\");for(s=0;s<r.length;s++)o=r[s],n=R.AlarmSeverity.getByName(o.getAttribute(\"n\")),this._alarmState.setNewAlarmCount(n,parseInt(o.getAttribute(\"c\")));for(r=e.getElementsByTagName(\"a\"),s=0;s<r.length;s++)o=r[s],n=R.AlarmSeverity.getByName(o.getAttribute(\"n\")),this._alarmState.setAcknowledgedAlarmCount(n,parseInt(o.getAttribute(\"c\")))}}else R.Element.superClass.deserializePropertyXml.call(this,t,e,i)}}),D.addMethod(Pe,{serializeXml:function(t,e){Pe.superClass.serializeXml.call(this,t,e),this.serializePropertyXml(t,\"image\",e),this.serializePropertyXml(t,\"location\",e),D.num(this._width)&&this._width>=0&&this.serializePropertyXml(t,\"width\",e),D.num(this._height)&&this._height>=0&&this.serializePropertyXml(t,\"height\",e)}}),D.addMethod(R.Link,{serializeXml:function(t,e){R.Link.superClass.serializeXml.call(this,t,e),this.serializePropertyXml(t,\"fromNode\",e),this.serializePropertyXml(t,\"toNode\",e)}}),D.addMethod(R.Follower,{serializeXml:function(t,e){R.Follower.superClass.serializeXml.call(this,t,e),this.serializePropertyXml(t,\"host\",e)}}),D.addMethod(De,{serializeXml:function(t,e){De.superClass.serializeXml.call(this,t,e),this.serializePropertyXml(t,\"expanded\",e)}}),D.addMethod(R.ShapeNode,{serializeXml:function(t,e){R.ShapeNode.superClass.serializeXml.call(this,t,e),this.serializePropertyXml(t,\"points\",e),this.serializePropertyXml(t,\"segments\",e)}}),D.addMethod(R.ShapeLink,{serializeXml:function(t,e){R.ShapeLink.superClass.serializeXml.call(this,t,e),this.serializePropertyXml(t,\"points\",e)}}),D.addMethod(R.RotatableNode,{serializeXml:function(t,e){R.RotatableNode.superClass.serializeXml.call(this,t,e),this.serializePropertyXml(t,\"angle\",e)}}),D.addMethod(R.DataBox,{serializeXml:function(t,e){if(t.settings.isClientSerializable&&this._clientMap)for(var i in this._clientMap)this.serializeClientXml(t,i,e);this.serializePropertyXml(t,\"name\",e),this.serializePropertyXml(t,\"icon\",e),this.serializePropertyXml(t,\"toolTip\",e)},serializePropertyXml:function(t,e,i){t.serializePropertyXml(this,e,i)},serializeClientXml:function(t,e,i){t.serializeClientXml(this,e,i)},deserializeXml:function(t,e){var i,n,s,o,r=e.getElementsByTagName(\"p\"),a=r.length;for(i=0;i<a;i++)(n=r[i]).hasAttribute(\"n\")&&this.deserializePropertyXml(t,n,n.getAttribute(\"n\"));if(t.settings.isClientSerializable)for(a=(s=e.getElementsByTagName(\"c\")).length,i=0;i<a;i++)(o=s[i]).hasAttribute(\"n\")&&this.deserializeClientXml(t,o,o.getAttribute(\"n\"))},deserializePropertyXml:function(t,e,i){t.deserializePropertyXml(this,e,i)},deserializeClientXml:function(t,e,i){t.deserializeClientXml(this,e,i)}}),D.addMethod(R.ElementBox,{serializeXml:function(t,e){if(t.settings.isLayerBoxSerializable&&(t.xmlString+=\"\\t<layerBox>\\n\",this._layerBox.forEachByDepthFirst(function(e){this._layerBox.getDefaultLayer()===e?t.xmlString+=\"\\t\\t<layer \":t.xmlString+=\"\\t\\t<layer id='\"+e.getId()+\"' \",e.getName()&&(t.xmlString+=\"name='\"+e.getName()+\"' \"),t.xmlString+=\"visible='\"+e.isVisible()+\"' editable='\"+e.isEditable()+\"' movable='\"+e.isMovable()+\"'/>\\n\"},null,this),t.xmlString+=\"\\t</layerBox>\\n\"),t.settings.isStyleSerializable&&this._styleMap)for(var i in this._styleMap)this.serializeStyleXml(t,i,e);R.ElementBox.superClass.serializeXml.call(this,t,e)},serializeStyleXml:function(t,e,i){t.serializeStyleXml(this,e,i)},deserializeStyleXml:function(t,e,i){t.deserializeStyleXml(this,e,i)},deserializeXml:function(t,e){if(R.ElementBox.superClass.deserializeXml.call(this,t,e),t.settings.isLayerBoxSerializable&&1==e.getElementsByTagName(\"layerBox\").length)for(var i=e.getElementsByTagName(\"layerBox\")[0].getElementsByTagName(\"layer\"),n=0;n<i.length;n++){var s,o=i[n];if(o.hasAttribute(\"id\")){var r=t.settings.getPropertyType(\"layerId\");if(\"string\"===r)s=new R.Layer(o.getAttribute(\"id\"));else if(\"int\"===r)s=new R.Layer(parseInt(o.getAttribute(\"id\")));else{if(\"number\"!==r)throw\"Unsupported layer id type '\"+r+\"'\";s=new R.Layer(parseFloat(o.getAttribute(\"id\")))}this._layerBox.getDataById(s.getId())?s=this._layerBox.getDataById(s.getId()):this._layerBox.add(s)}else s=this._layerBox.getDefaultLayer(),this._layerBox.moveToBottom(s);o.hasAttribute(\"name\")&&s.setName(o.getAttribute(\"name\")),o.hasAttribute(\"visible\")&&s.setVisible(\"true\"===o.getAttribute(\"visible\")),o.hasAttribute(\"editable\")&&s.setEditable(\"true\"===o.getAttribute(\"editable\")),o.hasAttribute(\"movable\")&&s.setMovable(\"true\"===o.getAttribute(\"movable\"))}if(t.settings.isStyleSerializable){var a=e.getElementsByTagName(\"s\"),h=a.length;for(n=0;n<h;n++){var l=a[n];l.hasAttribute(\"n\")&&this.deserializeStyleXml(t,l,l.getAttribute(\"n\"))}}}}),R.JsonSerializer=function(t,e,i){this.dataBox=t,this.settings=e||new R.SerializationSettings,this.filterFunction=i,this.ref=0,this.refMap={},this.idMap={},this.jsonObject={}},D.ext(\"twaver.JsonSerializer\",Object,{serialize:function(){return this.jsonObject={version:R.Util.getVersion(),platform:\"html5\"},this.settings.isImageSerializable&&(this.jsonObject.images={}),this.serializeBody(),JSON.stringify(this.jsonObject)},serializeBody:function(){if(this.ref=0,this.dataBox.getRoots().forEach(this.initRefs,this),this.settings.isDataBoxSerializable){var t={class:this.dataBox.getClassName(),p:{},s:{},c:{}};this.jsonObject.dataBox=t,this.dataBox.serializeJson(this,this.dataBox.newInstance(),t),D.isEmptyObject(t.p)&&delete t.p,D.isEmptyObject(t.s)&&delete t.s,D.isEmptyObject(t.c)&&delete t.c}this.jsonObject.datas=[],this.dataBox.getRoots().forEach(this.serializeData,this)},initRefs:function(t){this.refMap[t.getId()]=this.ref++,t.getChildren().forEach(this.initRefs,this)},isSerializable:function(t){return!!this.dataBox.contains(t)&&!(this.filterFunction&&!this.filterFunction(t))},serializeData:function(t){if(this.isSerializable(t)){var e=t.newInstance(),i=this.refMap[t.getId()],n={class:t.getClassName(),ref:i,p:{},s:{},c:{}};if(this.settings.getPropertyType(\"id\")&&(n.id=t.getId()),this.jsonObject.datas.push(n),t.serializeJson(this,e,n),D.isEmptyObject(n.p)&&delete n.p,D.isEmptyObject(n.s)&&delete n.s,D.isEmptyObject(n.c)&&delete n.c,this.settings.isImageSerializable&&t.getImage){var s=t.getImage();if(\"string\"==typeof s&&!Be[s]&&!this.jsonObject.images[s]){var o=D.getImageAsset(s),r=o&&o.getImage();r&&!jt(r)&&(this.jsonObject.images[s]=r)}}}t.getChildren().forEach(this.serializeData,this)},serializePropertyJson:function(t,e,i,n){var s=this.settings.getPropertyType(e);if(s){var o=D.getValue(t,e,s),r=D.getValue(i,e,s);o!==r&&this.serializeValue(e,o,r,s,n.p)}},serializeStyleJson:function(t,e,i,n){var s=this.settings.getStyleType(e);if(s){var o=t.getStyle(e),r=i.getStyle(e);o!=r&&this.serializeValue(e,o,r,s,n.s)}},serializeClientJson:function(t,e,i,n){var s=this.settings.getClientType(e);if(null!=s){var o=t.getClient(e),r=i.getClient(e);o!=r&&this.serializeValue(e,o,r,s,n.c)}},serializeValue:function(t,e,i,n,s){if(null==e)s[t]=null;else if(e instanceof oe)s[t]=e._as;else if(\"data\"===n){var o=this.refMap[e.getId()];null!=o&&(s[t]=o)}else s[t]=e},deserialize:function(t,e){D.isDeserializing=!0,this.jsonObject=JSON.parse(t);var i=this.jsonObject.images;this.settings.isImageSerializable&&i&&Object.keys(i).forEach(function(t){D.registerImage(t,i[t])}),this.refMap={},this.idMap={};for(var n,s=new oe,o=new oe,r=this.jsonObject.datas.length,a=0;a<r;a++){var h=this.jsonObject.datas[a],l=h.class;if(this.settings.getPropertyType(\"id\")&&null!=h.id){if(\"remove\"===h.action){this.dataBox.removeById(h.id);continue}(n=this.dataBox.getDataById(h.id))||(n=D.newInstance(l,h.id))}else n=D.newInstance(l);null!=h.ref&&(this.refMap[h.ref]=n),s.add(n),o.add(h),this.idMap[n.getId()]=n}for(this.dataBox.forEach(function(t){this.idMap[t.getId()]=t},this),r=s.size(),a=0;a<r;a++)(n=s.get(a)).deserializeJson(this,o.get(a));for(a=0;a<r;a++)n=s.get(a),this.dataBox.containsById(n.getId())||(e&&!n.getParent()&&n.setParent(e),this.dataBox.add(n));this.settings.isDataBoxSerializable&&this.jsonObject.dataBox&&this.dataBox.deserializeJson(this,this.jsonObject.dataBox),D.isDeserializing=!1},deserializePropertyJson:function(t,e,i){var n=this.settings.getPropertyType(i);n&&D.setValue(t,i,this.deserializeValue(e,n))},deserializeStyleJson:function(t,e,i){var n=this.settings.getStyleType(i);n&&t.setStyle(i,this.deserializeValue(e,n))},deserializeClientJson:function(t,e,i){var n=this.settings.getClientType(i);n&&t.setClient(i,this.deserializeValue(e,n))},deserializeValue:function(t,e){if(\"data\"===e){var i=this.refMap[t];return i||this.idMap[t]}return\"array.number\"===e?t:t instanceof Array?new oe(t):t}}),D.addMethod(R.Data,{serializeJson:function(t,e,i){if(t.settings.isClientSerializable&&this._clientMap)for(var n in this._clientMap)this.serializeClientJson(t,n,e,i);this.serializePropertyJson(t,\"name2\",e,i),this.serializePropertyJson(t,\"name\",e,i),this.serializePropertyJson(t,\"icon\",e,i),this.serializePropertyJson(t,\"toolTip\",e,i),this.serializePropertyJson(t,\"parent\",e,i)},serializePropertyJson:function(t,e,i,n){t.serializePropertyJson(this,e,i,n)},serializeClientJson:function(t,e,i,n){t.serializeClientJson(this,e,i,n)},deserializeJson:function(t,e){var i;for(i in e.p)this.deserializePropertyJson(t,e.p[i],i);if(t.settings.isClientSerializable)for(i in e.c)this.deserializeClientJson(t,e.c[i],i)},deserializePropertyJson:function(t,e,i){t.deserializePropertyJson(this,e,i)},deserializeClientJson:function(t,e,i){t.deserializeClientJson(this,e,i)}}),D.addMethod(R.Element,{serializeJson:function(t,e,i){if(t.settings.isStyleSerializable&&this._styleMap)for(var n in this._styleMap)this.serializeStyleJson(t,n,e,i);if(R.Element.superClass.serializeJson.call(this,t,e,i),this.serializePropertyJson(t,\"layerId\",e,i),this._alarmState.getHighestNativeAlarmSeverity()&&\"alarmstate\"===t.settings.getPropertyType(\"alarmState\")){var s={n:{},a:{}};i.p.alarmState=s,R.AlarmSeverity.forEach(function(t){var e=this.getNewAlarmCount(t);e>0&&(s.n[t.name]=e)},this._alarmState),R.AlarmSeverity.forEach(function(t){var e=this.getAcknowledgedAlarmCount(t);e>0&&(s.a[t.name]=e)},this._alarmState),D.isEmptyObject(s.n)&&delete s.n,D.isEmptyObject(s.a)&&delete s.a,D.isEmptyObject(s)&&delete i.p.alarmState}},serializeStyleJson:function(t,e,i,n){t.serializeStyleJson(this,e,i,n)},deserializeJson:function(t,e){if(R.Element.superClass.deserializeJson.call(this,t,e),t.settings.isStyleSerializable)for(var i in e.s)this.deserializeStyleJson(t,e.s[i],i)},deserializeStyleJson:function(t,e,i){t.deserializeStyleJson(this,e,i)},deserializePropertyJson:function(t,e,i){if(\"alarmState\"===i){if(\"alarmstate\"===t.settings.getPropertyType(\"alarmState\")){var n;for(n in e.n)this._alarmState.setNewAlarmCount(R.AlarmSeverity.getByName(n),e.n[n]);for(n in e.a)this._alarmState.setAcknowledgedAlarmCount(R.AlarmSeverity.getByName(n),e.a[n])}}else R.Element.superClass.deserializePropertyJson.call(this,t,e,i)}}),D.addMethod(Pe,{serializeJson:function(t,e,i){Pe.superClass.serializeJson.call(this,t,e,i),this.serializePropertyJson(t,\"image\",e,i),this.serializePropertyJson(t,\"location\",e,i),D.num(this._width)&&this._width>=0&&this.serializePropertyJson(t,\"width\",e,i),D.num(this._height)&&this._height>=0&&this.serializePropertyJson(t,\"height\",e,i)}}),D.addMethod(R.Link,{serializeJson:function(t,e,i){R.Link.superClass.serializeJson.call(this,t,e,i),this.serializePropertyJson(t,\"fromNode\",e,i),this.serializePropertyJson(t,\"toNode\",e,i)}}),D.addMethod(R.Follower,{serializeJson:function(t,e,i){R.Follower.superClass.serializeJson.call(this,t,e,i),this.serializePropertyJson(t,\"host\",e,i)}}),D.addMethod(De,{serializeJson:function(t,e,i){De.superClass.serializeJson.call(this,t,e,i),this.serializePropertyJson(t,\"expanded\",e,i)}}),D.addMethod(R.ShapeNode,{serializeJson:function(t,e,i){R.ShapeNode.superClass.serializeJson.call(this,t,e,i),this.serializePropertyJson(t,\"points\",e,i),this.serializePropertyJson(t,\"segments\",e,i)}}),D.addMethod(R.ShapeLink,{serializeJson:function(t,e,i){R.ShapeLink.superClass.serializeJson.call(this,t,e,i),this.serializePropertyJson(t,\"points\",e,i)}}),D.addMethod(R.RotatableNode,{serializeJson:function(t,e,i){R.RotatableNode.superClass.serializeJson.call(this,t,e,i),this.serializePropertyJson(t,\"angle\",e,i)}}),D.addMethod(R.DataBox,{serializeJson:function(t,e,i){if(t.settings.isClientSerializable&&this._clientMap)for(var n in this._clientMap)this.serializeClientJson(t,n,e,i);this.serializePropertyJson(t,\"name\",e,i),this.serializePropertyJson(t,\"icon\",e,i),this.serializePropertyJson(t,\"toolTip\",e,i)},serializePropertyJson:function(t,e,i,n){t.serializePropertyJson(this,e,i,n)},serializeClientJson:function(t,e,i,n){t.serializeClientJson(this,e,i,n)},deserializeJson:function(t,e){var i;for(i in e.p)this.deserializePropertyJson(t,e.p[i],i);if(t.settings.isClientSerializable)for(i in e.c)this.deserializeClientJson(t,e.c[i],i)},deserializePropertyJson:function(t,e,i){t.deserializePropertyJson(this,e,i)},deserializeClientJson:function(t,e,i){t.deserializeClientJson(this,e,i)}}),D.addMethod(R.ElementBox,{serializeJson:function(t,e,i){if(t.settings.isLayerBoxSerializable&&(i.layers=[],this._layerBox.forEachByDepthFirst(function(t){var e={};i.layers.push(e),this._layerBox.getDefaultLayer()!==t&&(e.id=t.getId()),t.getName()&&(e.name=t.getName()),e.visible=t.isVisible(),e.editable=t.isEditable(),e.movable=t.isMovable()},null,this)),t.settings.isStyleSerializable&&this._styleMap)for(var n in this._styleMap)this.serializeStyleJson(t,n,e,i);R.ElementBox.superClass.serializeJson.call(this,t,e,i)},serializeStyleJson:function(t,e,i,n){t.serializeStyleJson(this,e,i,n)},deserializeStyleJson:function(t,e,i){t.deserializeStyleJson(this,e,i)},deserializeJson:function(t,e){if(R.ElementBox.superClass.deserializeJson.call(this,t,e),t.settings.isLayerBoxSerializable&&e.layers&&e.layers)for(var i=e.layers.length,n=0;n<i;n++){var s,o=e.layers[n];null!=o.id?(s=new R.Layer(o.id),this._layerBox.getDataById(s.getId())?s=this._layerBox.getDataById(s.getId()):this._layerBox.add(s)):(s=this._layerBox.getDefaultLayer(),this._layerBox.moveToBottom(s)),o.name&&s.setName(o.name),null!=o.visible&&s.setVisible(o.visible),null!=o.editable&&s.setEditable(o.editable),null!=o.movable&&s.setMovable(o.movable)}if(t.settings.isStyleSerializable)for(var r in e.s)this.deserializeStyleJson(t,e.s[r],r)}}),R.layout.SpringLayouter=function(t){this._network=t,this._damper=1,this._maxMotion=0,this._motionRatio=0,this._isAdjusting=!1,this._timer=null,this._snodeMap={},this._snodes=new oe,this._slinks=new oe,this._network.getElementBox().addDataBoxChangeListener(this._handleDataBoxChange,this),this._network.getElementBox().addDataPropertyChangeListener(this._handleDataPropertyChange,this),this._network.addPropertyChangeListener(this._handleNetworkPropertyChange,this)},D.ext(\"twaver.layout.SpringLayouter\",Object,{_nodeRepulsionFactor:.6,_linkRepulsionFactor:.6,_limitBounds:null,_interval:50,_stepCount:10,_motionLimit:.01,start:function(){if(!this._timer){var t=this;this._timer=window.setInterval(function(){t.relax.call(t)},this._interval),this._damper=1}},stop:function(){this._timer&&(window.clearInterval(this._timer),this._timer=null)},relax:function(){if(!(this._damper<.1&&this._maxMotion<this._motionLimit)){this._rebuild();for(var t=this._snodes.size(),e=0;e<this._stepCount;e++){this._slinks.forEach(this._relaxLink,this);for(var i=0;i<t;i++)for(var n=0;n<t;n++){var s=this._snodes.get(i),o=this._snodes.get(n);s!=o&&this._relaxNodePair(s,o)}this._moveNodes()}this._isAdjusting=!0;for(e=0;e<t;e++){var r=this._snodes.get(e);r.fix||r.element.setLocation(r.x,r.y)}this._isAdjusting=!1}},isRunning:function(){return!!this._timer},getNetwork:function(){return this._network},isVisible:function(t){return this._network.isVisible(t)},isMovable:function(t){return!!this._network.isMovable(t)&&(!this._network.getSelectionModel().contains(t)&&!(t instanceof De))},getNodeRepulsionFactor:function(){return this._nodeRepulsionFactor},setNodeRepulsionFactor:function(t){t<.02&&(t=.02),this._nodeRepulsionFactor=t,this._damper=1},getLinkRepulsionFactor:function(){return this._linkRepulsionFactor},setLinkRepulsionFactor:function(t){t<.02&&(t=.02),this._linkRepulsionFactor=t,this._damper=1},getStepCount:function(){return this._stepCount},setStepCount:function(t){this._stepCount=t,this._damper=1},getInterval:function(){return this._interval},setInterval:function(t){if(this._interval!==t&&(this._interval=t,this._timer)){window.clearInterval(this._timer);var e=this;this._timer=window.setInterval(function(){e.relax.call(e)},this._interval)}},getLimitBounds:function(){return this._limitBounds},setLimitBounds:function(t){this._limitBounds=t,this._damper=1},_handleDataPropertyChange:function(t){this._isAdjusting||(this._damper=1)},_handleDataBoxChange:function(t){0===this._network.getElementBox().size()?this._damper=0:this._damper=1},_handleNetworkPropertyChange:function(t){if(\"elementBox\"===t.property){var e=t.oldValue;null!=e&&(e.removeDataBoxChangeListener(this._handleDataBoxChange,this),e.removeDataPropertyChangeListener(this._handleDataPropertyChange,this)),this._network.getElementBox().addDataBoxChangeListener(this._handleDataBoxChange,this),this._network.getElementBox().addDataPropertyChangeListener(this._handleDataPropertyChange,this)}},_relaxLink:function(t){var e=t.toNode.x-t.fromNode.x,i=t.toNode.y-t.fromNode.y,n=Math.sqrt(e*e+i*i),s=.25*e,o=.25*i;s/=100*t.length;o/=100*t.length,t.length,t.toNode.dx=t.toNode.dx-s*n,t.toNode.dy=t.toNode.dy-o*n,t.fromNode.dx=t.fromNode.dx+s*n,t.fromNode.dy=t.fromNode.dy+o*n},_relaxNodePair:function(t,e){var i=0,n=0,s=t.x-e.x,o=t.y-e.y,r=s*s+o*o;0===r?(i=R.Util.random(),n=R.Util.random()):r<36e4&&(i=s/r,n=o/r);var a=.25*(t.repulsion*e.repulsion/100);t.dx+=i*a,t.dy+=n*a,e.dx-=i*a,e.dy-=n*a},_moveNodes:function(){for(var t=this._maxMotion,e=0,i=0,n=this._snodes.size();i<n;i++){var s=this._snodes.get(i),o=s.dx,r=s.dy;o*=this._damper,r*=this._damper,s.dx=o/2,s.dy=r/2;var a=Math.sqrt(o*o+r*r);if(!s.fix)if(s.x=s.x+Math.max(-30,Math.min(30,o)),s.y=s.y+Math.max(-30,Math.min(30,r)),this._limitBounds){s.x<this._limitBounds.x&&(s.x=this._limitBounds.x,this._adjustLocation(1,0)),s.y<this._limitBounds.y&&(s.y=this._limitBounds.y,this._adjustLocation(0,1));var h,l=this._network.getElementUI(s.element);(h=l?l._viewRect:s.element.getRect())&&(s.x+h.width>this._limitBounds.x+this._limitBounds.width&&(s.x=this._limitBounds.x+this._limitBounds.width-h.width,this._adjustLocation(-1,0)),s.y+h.height>this._limitBounds.y+this._limitBounds.height&&(s.y=this._limitBounds.y+this._limitBounds.height-h.height,this._adjustLocation(0,-1)))}else s.x<1&&this._adjustLocation(1,0),s.y<1&&this._adjustLocation(0,1);e=Math.max(a,e)}this._maxMotion=e,this._maxMotion>0?this._motionRatio=t/this._maxMotion-1:this._motionRatio=0,this._damp()},_damp:function(){this._motionRatio<=.001&&((this._maxMotion<.2||this._maxMotion>1&&this._damper<.9)&&this._damper>.01?this._damper-=.01:this._maxMotion<.4&&this._damper>.003?this._damper-=.003:this._damper>1e-4&&(this._damper-=1e-4)),this._maxMotion<this._motionLimit&&(this._damper=0)},_rebuild:function(){this._snodeMap={},this._snodes.clear(),this._slinks.clear(),this._network.getElementBox().forEach(function(t){this.isVisible(t)&&(t instanceof R.Link?this._addLink(t):t instanceof Pe&&this._addNode(t))},this)},_addNode:function(t){var e=this._snodeMap[t.getId()];return e||(e={},e.element=t,e.repulsion=this._getRepulsion(t),e.x=t.getX(),e.y=t.getY(),e.dx=0,e.dy=0,e.fix=!this.isMovable(t),this._snodeMap[t.getId()]=e,this._snodes.add(e),e)},_addLink:function(t){var e={};e.fromNode=this._addNode(t.getFromNode()),e.toNode=this._addNode(t.getToNode()),e.element=t;var i,n,s=this._network.getElementUI(t.getToNode()),o=this._network.getElementUI(t.getFromNode());s&&s._viewRect&&o&&o._viewRect?(i=s._viewRect.width+o._viewRect.width,n=s._viewRect.height+o._viewRect.height):(i=t.getToNode().getWidth()+t.getFromNode().getWidth(),n=t.getToNode().getHeight()+t.getFromNode().getHeight()),e.length=Math.floor(Math.sqrt(i*i+n*n)*this._linkRepulsionFactor),e.length<=0&&(e.length=100),this._slinks.add(e)},_getRepulsion:function(t){var e,i=this._network.getElementUI(t);if(i&&i._viewRect){var n=i._viewRect;e=Math.floor(Math.sqrt(n.width*n.width+n.height*n.height)*this._nodeRepulsionFactor)}else e=100;return e<=0&&(e=100),e},_adjustLocation:function(t,e){for(var i=0,n=this._snodes.size();i<n;i++){var s,o=this._snodes.get(i),r=this._network.getElementUI(o.element);if(!(s=r?r._viewRect:o.element.getRect()))return;t>0?(!this._limitBounds||o.x+s.width+t<this._limitBounds.x+this._limitBounds.width)&&(o.x+=t):(!this._limitBounds||o.x+t>this._limitBounds.x)&&(o.x+=t),e>0?(!this._limitBounds||o.y+s.height+e<this._limitBounds.y+this._limitBounds.height)&&(o.y+=e):(!this._limitBounds||o.y+e>this._limitBounds.y)&&(o.y+=e)}}}),R.layout.CloudLayouter=function(t){R.layout.CloudLayouter.superClass.constructor.apply(this,arguments),this._network=t,this._centerX=0,this._centerY=0,this._radius=1,this._rect=null,this._localPoint=null,this._lastWidth=-1e3,this._lastHeight=-1e3,this._nodes=new oe,this._sa=0,this._ca=0,this._sb=0,this._cb=0,this._sc=0,this._cc=0,this._lasta=0,this._lastb=0,this._active=!1,this._horizontalElliptical=1,this._verticalElliptical=1,this._timer=null,this._centering=!1,this._centeringNode=null,this._freeze=!1,\"twaver.network.Network\"===this._network.getClassName()?this._network.setInteractions([new R.network.interaction.SelectInteraction(this._network)]):this._network.setInteractions([new R.canvas.interaction.SelectInteraction(this._network)])},D.ext(\"twaver.layout.CloudLayouter\",R.PropertyChangeDispatcher,{__accessor:[\"updateNodeFunction\",\"mouseMoveFunction\",\"mouseOverFunction\",\"percentPadding\",\"ceaseRate\",\"ceaseLimit\"],__bool:[\"elliptical\",\"active\",\"updateLayoutRectOnResized\",\"reloadOnDataBoxChanged\"],_moveSpeed:2,_ceaseRate:.9,_ceaseLimit:.01,_percentPadding:.2,_elliptical:!0,_interval:50,_reloadOnDataBoxChanged:!0,_updateLayoutRectOnResized:!0,getNetwork:function(){return this._network},isLayoutable:function(t){return this._network.isVisible(t)&&this._network.isMovable(t)},start:function(t){if(0===arguments.length&&(t=!0),!this._timer){this._installListeners(),t&&this.updateLayoutRect(!0);var e=this;this._timer=window.setInterval(function(){e._update.call(e)},this._interval),this._update()}},stop:function(){this._timer&&(window.clearInterval(this._timer),this._timer=null)},isRunning:function(){return!!this._timer},getInterval:function(){return this._interval},setInterval:function(t){if(this._interval!==t){var e=this._interval;if(this._interval=t,this._timer){window.clearInterval(this._timer);var i=this;this._timer=window.setInterval(function(){i._update.call(i)},this._interval)}this.firePropertyChange(\"interval\",e,t)}},getMoveSpeed:function(){return this._moveSpeed},setMoveSpeed:function(t){var e=this._moveSpeed;this._moveSpeed=t,this.firePropertyChange(\"moveSpeed\",e,t)},getLayoutRect:function(){var t=this._network.getView().offsetWidth/this._network.getZoom(),e=this._network.getView().offsetHeight/this._network.getZoom(),i=t*this._percentPadding,n=e*this._percentPadding;return{x:i,y:n,width:t-2*i,height:e-2*n}},getCount:function(){return this._nodes.size()},updateLayoutRect:function(t){var e=this._radius;if(this._rect=this.getLayoutRect(),this._rect.width<=2&&(this._rect.width=2),this._rect.height<=2&&(this._rect.height=2),this._radius=Math.min(this._rect.width/2,this._rect.height/2),this.isElliptical()?(this._horizontalElliptical=this._rect.width/2/this._radius,this._verticalElliptical=this._rect.height/2/this._radius):(this._horizontalElliptical=1,this._verticalElliptical=1),this._centerX=this._rect.x+this._rect.width/2,this._centerY=this._rect.y+this._rect.height/2,t)this.reload();else{this._lasta=1,this._lastb=1;for(var i=this._nodes.size(),n=0;n<i;n++){var s=this._nodes.get(n);s.cx*=this._radius/e,s.cy*=this._radius/e,s.cz*=this._radius/e}this._freeze?this._updateNodes(0,0,0):this._update()}this._lastWidth=this._network.getView().offsetWidth,this._lastHeight=this._network.getView().offsetHeight},reload:function(){this._freeze=!1,this._centeringNode=null,this._localPoint=null,this._centering=!1,this._nodes=new oe,this._box.forEach(function(t){if(t&&this.isLayoutable(t)){var e={};e.node=t,this._nodes.add(e)}},this),this._sineCosine(0,0,0),this._active=!1,this._lasta=1,this._lastb=1;for(var t=0,e=0,i=this._nodes.size(),n=0;n<i;n++){t=Math.acos((2*(n+1)-1)/i-1),e=Math.sqrt(i*Math.PI)*t;var s=this._nodes.get(n);s.cx=this._radius*Math.cos(e)*Math.sin(t),s.cy=this._radius*Math.sin(e)*Math.sin(t),s.cz=this._radius*Math.cos(t)}},_sineCosine:function(t,e,i){var n=Math.PI/180;this._sa=Math.sin(t*n),this._ca=Math.cos(t*n),this._sb=Math.sin(e*n),this._cb=Math.cos(e*n),this._sc=Math.sin(i*n),this._cc=Math.cos(i*n)},handleSelectionChange:function(t){this.centerNode(this._network.getSelectionModel().getLastData())},handleDataBoxChange:function(t){(this._reloadOnDataBoxChanged||\"clear\"===t.kind)&&this.reload()},handleMouseMove:function(t){this._centering||this._updateLogicalPoint(t),this._mouseMoveFunction?this._active=this._mouseMoveFunction(t):this._active=!0},handleMouseOver:function(t){this._centering||this._updateLogicalPoint(t),this._mouseOverFunction?this._active=this._mouseOverFunction(t):this._active=!0},_updateLogicalPoint:function(t){this._localPoint=this._network.getLogicalPoint(t)},handleRollOut:function(t){this._active=!1},handleResize:function(t){if(\"validateEnd\"===t.kind){if(!this._updateLayoutRectOnResized)return;if(Math.abs(this._network.getView().offsetWidth-this._lastWidth)<=2&&Math.abs(this._network.getView().offsetHeight-this._lastHeight)<=2)return;this.updateLayoutRect()}},handleNetworkPropertyChange:function(t){\"elementBox\"===t.property&&(this._box.removeDataBoxChangeListener(this.handleDataBoxChange,this),this._box=this._network.getElementBox(),this._box.addDataBoxChangeListener(this.handleDataBoxChange,this),this.reload()),\"zoom\"===t.property&&(this._localPoint=null,this.updateLayoutRect())},_adjustIndex:function(){this._nodes.sort(this._sortFunction);for(var t=this._nodes.size(),e=0;e<t;e++){var i=this._nodes.get(e).node,n=this._box.getDatas().indexOf(i);this._box.getDatas().removeAt(n),this._box.getDatas().add(i,e),this._box.fireIndexChange(i,n,e),this.updateNode(i,e,t,this._nodes.get(e).alpha)}},_sortFunction:function(t,e){return e.cz>t.cz?1:e.cz<t.cz?-1:0},updateNode:function(t,e,i,n){this._updateNodeFunction&&this._updateNodeFunction(t,e,i,n)},_update:function(){if(!this._freeze){var t,e;if(this._centering&&this._centeringNode){if(this.isAtCenter(this._centeringNode.node,this._centeringNode.perspective,this._centeringNode.cx,this._centeringNode.cy,this._centeringNode.cz))return this._freeze=!0,this._centering=!1,void(this._centeringNode=null)}if(!this._freeze&&(this._active||this._centering)&&this._localPoint?this.isElliptical()?(t=(this._centerY-this._localPoint.y)/(this._rect.height/2)*this._moveSpeed,e=(this._localPoint.x-this._centerX)/(this._rect.width/2)*this._moveSpeed):(t=(this._centerY-this._localPoint.y)/this._radius*this._moveSpeed,e=(this._localPoint.x-this._centerX)/this._radius*this._moveSpeed):(t=this._lasta*this._ceaseRate,e=this._lastb*this._ceaseRate),this._lasta=t,this._lastb=e,Math.abs(t)>this._ceaseLimit||Math.abs(e)>this._ceaseLimit){this._sineCosine(t,e,0);for(var i=0,n=this._nodes.size();i<n;i++){var s=this._nodes.get(i),o=s.cx,r=s.cy*this._ca+s.cz*-this._sa,a=s.cy*this._sa+s.cz*this._ca,h=o*this._cb+a*this._sb,l=r,c=o*-this._sb+a*this._cb,d=h*this._cc+l*-this._sc,u=h*this._sc+l*this._cc,_=c;s.cx=d,s.cy=u,s.cz=_;var g=2*this._radius;g/=g+_,s.perspective=g,s.alpha=(this._radius-_)/(2*this._radius);var f=this._horizontalElliptical*d*g-2*this._horizontalElliptical+this._centerX,v=u*g*this._verticalElliptical+this._centerY;s.node.setCenterLocation(f,v)}this._adjustIndex()}}},centerNode:function(t){if(t&&this.isLayoutable(t)){if(this._centeringNode&&t===this._centeringNode.node&&this._freeze)return;for(var e=0,i=this._nodes.size();e<i;e++){var n=this._nodes.get(e);if(n&&t===n.node){this._centering=!0,this._freeze=!1,this._active=!0,this._centeringNode=n,this._localPoint=this.createControlPoint(this._centeringNode.node);break}}}else this._centering=!1,this._freeze=!1,this._active=!1,this._localPoint=null},createControlPoint:function(t){var e=t.getCenterLocation(),i=this.getLayoutRect(),n=i.x+i.width/2,s=i.y+i.height/2,o=Math.atan2(e.y-s,e.x-n),r=i.width+i.height;return{x:n+r*Math.cos(o),y:s+r*Math.sin(o)}},isAtCenter:function(t,e,i,n,s){if(this._moveSpeed<=0)return!0;var o=16/this._moveSpeed;return o>20?o=20:o<2&&(o=2),-s/Math.sqrt(i*i+n*n)>o},_updateNodes:function(t,e,i){this._sineCosine(t,e,i);for(var n=0,s=this._nodes.size();n<s;n++){var o=this._nodes.get(n),r=o.cx,a=o.cy*this._ca+o.cz*-this._sa,h=o.cy*this._sa+o.cz*this._ca,l=r*this._cb+h*this._sb,c=a,d=r*-this._sb+h*this._cb,u=l*this._cc+c*-this._sc,_=l*this._sc+c*this._cc,g=d;o.cx=u,o.cy=_,o.cz=g;var f=2*this._radius;f/=f+g,o.perspective=f;var v=this._horizontalElliptical*u*f-2*this._horizontalElliptical+this._centerX,m=_*f*this._verticalElliptical+this._centerY;o.node.setCenterLocation(v,m)}this._adjustIndex()},_installListeners:function(){this._box=this._network.getElementBox(),this._box.addDataBoxChangeListener(this.handleDataBoxChange,this),this._network.getSelectionModel().addSelectionChangeListener(this.handleSelectionChange,this),this._network.addViewListener(this.handleResize,this),X.addEventListener(\"mouseout\",\"handleRollOut\",this._network.getView(),this),X.addEventListener(\"mousemove\",\"handleMouseMove\",this._network.getView(),this),X.addEventListener(\"mouseover\",\"handleMouseOver\",this._network.getView(),this),this._network.addPropertyChangeListener(this.handleNetworkPropertyChange,this)},_uninstallListeners:function(){this._box.removeDataBoxChangeListener(this.handleDataBoxChange,this),this._network.getSelectionModel().removeSelectionChangeListener(this.handleSelectionChange,this),this._network.removeViewListener(this.handleResize,this),X.removeEventListener(\"mouseout\",this._network.getView(),this),X.removeEventListener(\"mousemove\",this._network.getView(),this),X.removeEventListener(\"mouseover\",this._network.getView(),this),this._network.removePropertyChangeListener(this.handleNetworkPropertyChange,this)}}),R.layout.AutoLayouter=function(t,e){this._box=t,this._network=e},D.ext(\"twaver.layout.AutoLayouter\",Object,{_expandGroup:!1,_repulsion:1,_type:null,_animate:!0,_explicitXOffset:Number.NaN,_explicitYOffset:Number.NaN,_xOffset:0,_yOffset:0,isExpandGroup:function(){return this._expandGroup},setExpandGroup:function(t){this._expandGroup=t},getRepulsion:function(){return this._repulsion},setRepulsion:function(t){this._repulsion=t},getType:function(){return this._type},isAnimate:function(){return this._animate},setAnimate:function(t){this._animate=t},getElementBox:function(){return this._box},getExplicitXOffset:function(){return this._explicitXOffset},setExplicitXOffset:function(t){this._explicitXOffset=t},getExplicitYOffset:function(){return this._explicitYOffset},setExplicitYOffset:function(t){this._explicitYOffset=t},getNodeRect:function(t){if(t instanceof R.Group&&t.isExpanded()&&t.getChildrenSize()>0){for(var e=null,i=0,n=t.getChildrenSize();i<n;i++){var s=t.getChildAt(i);s instanceof R.Node&&(e=R.Util.unionRect(e,this.getNodeRect(s)))}var o=t.s(\"group.padding\"),r=t.s(\"group.padding.top\"),a=t.s(\"group.padding.bottom\"),h=t.s(\"group.padding.left\"),l=t.s(\"group.padding.right\");return o&&R.Util.grow(e,o,o),r&&(e.y-=r,e.height+=r),a&&(e.height+=r),h&&(e.x-=h,e.width+=h),l&&(e.width+=l),e}if(this._network){var c=this._network.getElementUI(t);return c.invalidate(),c.validate(),c.getViewRect()}return null},getDimension:function(t){var e=this.getNodeRect(t);return e?{width:e.width,height:e.height}:{width:t.getWidth(),height:t.getHeight()}},isVisible:function(t){return!0},isMovable:function(t){return!0},getGroupLayoutType:function(t){return this._type},getElements:function(){var t,e=this._box,i=e.getSelectionModel().size()>1;i?t=e.getSelectionModel().getSelection():(t=new oe,e.forEachByBreadthFirst(t.add,null,t)),this._xOffset=-1,this._yOffset=-1;for(var n=new oe,s=0,o=t.size();s<o;s++){var r=t.get(s);this.isVisible(r)&&(r instanceof R.Link?n.add(r):this.isMovable(r)&&r instanceof Pe&&(n.add(r),i&&((this._xOffset<0||r.getX()<this._xOffset)&&(this._xOffset=r.getX()),(this._yOffset<0||r.getY()<this._yOffset)&&(this._yOffset=r.getY()))))}return i||(isNaN(this._explicitXOffset)?this._xOffset=50/this._repulsion:this._xOffset=this._explicitXOffset,isNaN(this._explicitYOffset)?this._yOffset=50/this._repulsion:this._yOffset=this._explicitYOffset),n},getLayoutResult:function(t){var e={};return this.doLayoutImpl(t,null,e),e},doLayout:function(t,e){return this.doLayoutImpl(t,e)},doLayoutImpl:function(t,e,i){var n=this,s=e;e=function(t){n._box._layoutMovingElements=!1,s&&s(t)},this._type=t;var o=null;if(\"round\"===t?o=new qi:\"symmetry\"===t?o=new un:\"hierarchic\"===t?o=new xn:\"topbottom\"!==t&&\"bottomtop\"!==t&&\"rightleft\"!==t&&\"leftright\"!==t||(o=new Ni),null==o)return!1;n._box._layoutMovingElements=!0;var r={},a=this.getElements(),h=new _n(this,a,!0,null);a=h.process();var l=new an(this,a,t,!0,null);try{o.i2(l)}catch(t){return h.resetGroup(),null!=e&&e(!1),!1}var c,d;for(c in l._a){d=l._a[c];var u=l.g4(d);r[c]={x:u.x+this._xOffset,y:u.y+this._yOffset}}var _;if(\"rightleft\"===t||\"leftright\"===t||\"bottomtop\"===t){var g=_n.createMatrix(t),f=Number.MAX_VALUE,v=Number.MAX_VALUE;for(c in r){d=l._a[c],_=r[c];var m=g.transform(_);_.x=m.x,_.y=m.y;var p;\"rightleft\"===t||\"leftright\"===t?((p=m.x-l.g9(d)/2/this._repulsion)<f&&(f=p),(p=m.y-l.gj(d)/2/this._repulsion)<v&&(v=p)):((p=m.x-l.gj(d)/2/this._repulsion)<f&&(f=p),(p=m.y-l.g9(d)/2/this._repulsion)<v&&(v=p))}for(c in r)d=l._a[c],(_=r[c]).x=_.x-f+this._xOffset,_.y=_.y-v+this._yOffset}if(null==i&&this._animate){var w=new oe,y=new oe;for(c in r)w.add(l._a[c].node),y.add(r[c]);n._box._dataBoxChangeDispatcher.fire({kind:\"layouting\"}),R.animate.AnimateManager.start(new R.animate.AnimateCenterLocation(w,y,function(){h.resetGroup(),n._box._dataBoxChangeDispatcher.fire({kind:\"layoutEnd\"}),null!=e&&D.callLater(e,null,[!0])}))}else{n._box._dataBoxChangeDispatcher.fire({kind:\"layouting\"});for(c in r)d=l._a[c],_=r[c],null==i?d.node.setCenterLocation(_.x,_.y):i[d.node.getId()]=_;h.resetGroup(),n._box._dataBoxChangeDispatcher.fire({kind:\"layoutEnd\"}),null!=e&&D.callLater(e,null,[!0])}return!0}});var ze=function(t,e){this.x=t,this.y=e};D.ext(ze,Object,{equals:function(t){return this===t||t instanceof ze&&(t.x==this.x&&t.y==this.y)}});var Fe=function(t,e){this.width=t,this.height=e};D.ext(Fe,Object,{});var Ve=function(t,e){this.x=t,this.y=e};D.ext(Ve,Object,{});var Ue=function(){2===arguments.length?(Ue.superClass.constructor.call(this,arguments[1].width,arguments[1].height),this.x=arguments[0].x,this.y=arguments[0].y):(Ue.superClass.constructor.call(this,arguments[2],arguments[3]),this.x=arguments[0],this.y=arguments[1])};D.ext(Ue,Fe,{});var He=function(t,e){if(He.a2(t.x,e.x))this._a=1,this._b=0,this._c=-t.x;else{this._b=-1;var i=(e.y-t.y)/(e.x-t.x),n=t.y-t.x*i;this._a=i,this._c=n}};D.ext(He,Object,{a3:function(){return this._a},a4:function(){return this._b},a5:function(){return this._c}}),He.a6=function(t,e){if(He.a1(t.a3())&&He.a1(e.a3()))return null;if(He.a1(t.a4())&&He.a1(e.a4()))return null;if(He.a1(e.a4())){var i=t;t=e,e=i}var n,s,o=t.a3(),r=t.a4(),a=-t.a5();He.a1(t.a3())?(n=e.a4(),s=-e.a5()):(n=e.a4()-e.a3()/t.a3()*t.a4(),s=-e.a5()-e.a3()/t.a3()*-t.a5());var h=s/n;return new ze((a-h*r)/o,h)},He.a1=function(t){return He.a2(t,0)},He.a2=function(t,e){return Math.abs(t-e)<1e-5};var We=function(t){if(this._a=new ci,t)for(var e=0;e<t.size();e++)this._a.aa(t.get(e))};D.ext(We,Object,{c:function(){return this._a.ah()},d:function(){return this._a.ah()},a:function(){for(var t=new oe,e=this.c();e.i1();e.i2())t.add(e.i6(),0);return new We(t)},b:function(){return this._a.ay()}});var Ze=function(t,e){this.x=t,this.y=e};D.ext(Ze,Object,{a:function(t,e){this.x=t,this.y=e}});var Ge=function(t,e){this.x=t||0,this.y=e||0};D.ext(Ge,Object,{b:function(){return new Ge(this.x,this.y)},a:function(t){this.z=t},c:function(){return this.x},d:function(){return this.y},f:function(t,e){this.x=t,this.y=e}});var Xe=function(t){this._c=new ci,t?(this.ac(t.a8().b()),this.ad(t.a9().b())):(this.ac(new Ge),this.ad(new Ge))};D.ext(Xe,Object,{a6:function(){return this.a5(this)},ac:function(t){t.a(this),this._a=t},ad:function(t){t.a(this),this._b=t},a8:function(){return this._a},a9:function(){return this._b},a1:function(t,e){return this.a4(t,e,this.aa())},a2:function(){return this._c.ay()},a7:function(t){return this._c.ak(t)},aa:function(){return 0===this._c.ay()?null:this._c.as()},a3:function(){this._c.af()},i2:function(t){var e=this.a7(t);return null!=e?new ze(e.x,e.y):null},i1:function(){return this.a2()},i6:function(){var t=this.a8();return new ze(t.c(),t.d())},i7:function(){var t=this.a9();return new ze(t.c(),t.d())},i8:function(t){this.a8().f(t.x,t.y)},i9:function(t){this.a9().f(t.x,t.y)},i3:function(t,e,i){var n=this.a7(t);null!=n&&n.a(e,i)},i4:function(t,e){this.a1(t,e)},i5:function(){this.a3()}});var Ye=function(t){Ye.superClass.constructor.call(this,t)};D.ext(Ye,Xe,{a5:function(t){return new Ye(t)},a4:function(t,e,i){var n=new Ze(t,e);return this.ab(n,i),n},ab:function(t,e){this._c.an(t,this._c.al(e))}});var je=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];this._s=!1,this._w=30,this._h=30,this._x=t-this._w/2,this._y=e-this._h/2}else{var i=arguments[0];this._s=i._s,this._w=i._w,this._h=i._h,this._x=i._x,this._y=i._y}};D.ext(je,Object,{m3:function(){return this.m2(this)},m4:function(){return this._x+this._w/2},m5:function(){return this._y+this._h/2},m6:function(t,e){this._x=t-this._w/2,this._y=e-this._h/2},i1:function(){return this._x},i2:function(){return this._y},i5:function(t,e){this._x=t,this._y=e},i3:function(){return this._w},i4:function(){return this._h},i6:function(t,e){var i=(this._w-t)/2,n=(this._h-e)/2;this._x+=i,this._y+=n,this._w=t,this._h=e},m1:function(t){var e,i,n,s;t.width<=0?(e=this._x,i=this._x+this._w,n=this._y,s=this._y+this._h):(e=Math.min(this._x,t.x),i=Math.max(this._x+this._w,t.x+t.width),n=Math.min(this._y,t.y),s=Math.max(this._y+this._h,t.y+t.height)),t.x=e,t.y=n,t.width=i-e,t.height=s-n}});var Ke=function(t){t?Ke.superClass.constructor.call(this,t):Ke.superClass.constructor.call(this,0,0)};D.ext(Ke,je,{m2:function(t){return new Ke(t)}});var Je={};Je.a2=function(t){var e=Di.a2(kn.a(t.xa()));return Je.a4(t,e,Je.a3(t,e))},Je.a3=function(t,e){for(var i=t.x9();i.i1();i.i2())e.i7(i.i9(),-1);for(var n=0,s=new vi(t.xa()),o=t.x9();o.i1();o.i2()){var r=o.i9();-1===e.i2(r)&&Je.a(r,s,e,n++)}return n},Je.a6=function(t){for(var e=new di,i=Je.a2(t),n=0;n<i.length-1;n++){var s=t.xo(i[n].x2(),i[n+1].x3());e.aa(s)}return e},Je.a4=function(t,e,i){for(var n=[],s=0;s<i;s++)n[s]=new Li;for(var o=t.x9();o.i1();o.i2())n[e.i2(o.i9())].ae(o.i9());return n},Je.a=function(t,e,i,n){for(e.c(t),i.i7(t,n);!e.a();){for(var s=(t=e.b()).ag();null!=s;s=s.a8()){var o=s.a3();-1===i.i2(o)&&(i.i7(o,n),e.c(o))}for(var r=t.ae();null!=r;r=r.a7()){var a=r.a2();-1===i.i2(a)&&(i.i7(a,n),e.c(a))}}},Je.a1=function(t,e,i){var n=new oi(e,i);return n.a8(t),n._i},Je.a5=function(t,e,i){for(var n=[],s=0;s<i;s++)n[s]=new di;for(var o=t.xf();o.i1();o.i2())n[e.i2(o.i8())].aa(o.i8());return n},Je.a7=function(t){var e=new di,i=Di.a3(kn.b(t.xa())),n=Di.a4(kn.a(t.xh())),s=Je.a1(t,n,i),o=Je.a5(t,n,s);if(o.length>1){for(var r=new Li,a=0;a<o.length;a++){var h=o[a],l=null;if(1===h.ay()){var c=h.c2();1===c.a2().ad()?l=c.a2():1===c.a3().ad()&&(l=c.a3())}else{for(var d=h.c1();d.i1();d.i2()){var u=d.i8();if(i.i4(u.a2()))if(null==l)l=u.a2();else if(l!==u.a2()){l=null;break}if(i.i4(u.a3()))if(null!=l){if(l!==u.a3()){l=null;break}}else l=u.a3()}if(null!=l){var _=h.c2();l=_.a2()!==l?_.a2():_.a3()}}null!=l&&r.aa(l)}for(var g,f=r.x4();!r.ar();f=g)g=r.x4(),e.ac(t.xo(f,g))}return e};var qe=function(){this._c=0,this._d=0,this._e=0,this._b=!0,this._f=!1};D.ext(qe,Object,{a6:function(t){this._f=t},a7:function(t){this._b=t},a8:function(t){0!==t.x0()&&this.a9(t,t.x9().i9())},a9:function(t,e){if(this._xx=t.xk(),this._c=t.xl(),this._d=0,this._e=0,this.a0(e),this._b)for(var i=t.x9();i.i1();i.i2()){var n=i.i9();null==this._xx.i1(n)&&(this.a1(n),this.a0(n))}t.xi(this._xx),t.xj(this._c)},a0:function(t){var e=++this._d;this._xx.z1(t,qe._B),this.a5(t,e);for(var i=this._f?t.ap():t.af();i.i1();i.i2()){var n=i.i8();if(!this._c.i4(n)){this._c.i7(n,!0);var s=n.a1(t);null==this._xx.i1(s)?(this.a3(n,s,!0),this.a0(s),this.a2(n,s)):this.a3(n,s,!1)}}this.a4(t,e,++this._e),this._xx.z1(t,qe._C)},a5:function(t,e){},a4:function(t,e,i){},a3:function(t,e,i){},a2:function(t,e){},a1:function(t){}}),qe._B={},qe._C={};var Qe=function(t){this._a=t};D.ext(Qe,qe,{a5:function(t,e){var i=this._a._ah.i2(t);this._a._ad[i].ae(t)}});var $e=function(t){this._a=t};D.ext($e,qe,{a2:function(t,e){var i=t.a1(e),n=this._a[i.al()],s=this._a[e.al()];s._a+1>n._a?(n._c=n._a,n._b=n._d,n._a=s._a+1,n._d=t):s._a+1>n._c&&(n._c=s._a+1,n._b=t)}});var ti=function(t){this._a=t};D.ext(ti,qe,{a3:function(t,e,i){i&&t.a2()===e&&this._a.ac(t)}});var ei=function(){this._a=0,this._c=0};D.ext(ei,Object,{});var ii=function(){this._a=0};D.ext(ii,Object,{a1:function(t,e){this._a=0;for(var i=e.length-1;i>=0;i--)e[i]=-1;for(var n=t.x9();n.i1();n.i2()){var s=n.i9();if(0===s.ak()){this.a2(s,s.al(),e);break}}for(var o=t.x9();o.i1();o.i2()){var r=o.i9(),a=r.al();-1===e[a]&&this.a2(r,a,e)}},a2:function(t,e,i){i[e]=-2;for(var n=t.ag();null!=n;){var s=n.a3(),o=s.al();switch(i[o]){case-1:this.a2(s,o,i);case-2:default:n=n.a8()}}i[e]=this._a++}});var ni={};ni.a1=function(t){var e=new si;return e.a8(t),e._n},ni.a2=function(t){var e=t.x9(),i=null,n=0;for(e.i4();e.i1();e.i2())0===e.i9().ak()&&(i=e.i9(),n++);if(1===n)return i;for(n=0,e.i4();e.i1();e.i2())0===e.i9().ao()&&(i=e.i9(),n++);return 1===n?i:ni.a8(t)},ni.a8=function(t){var e=kn.a(t.x0()),i=Di.a2(e);return ni.a6(t,i)},ni.a6=function(t,e){var i=t.xd(),n=kn.d(1),s=kn.a(t.x0(),-1),o=ni.a4(t,i);ni.a7(i,e,n,s,-1);for(var r=o.c1();r.i1();r.i2())t.x3(r.i8());return n[0]},ni.a7=function(t,e,i,n,s){for(var o=0,r=t.ag();null!=r;r=r.a8()){var a=r.a3(),h=ni.a7(a,e,i,n,s);h>s&&(s=h),o+=n[a.al()]}for(var l=o*(t._g.xa()-1-o),c=t.ag();null!=c;c=c.a8())for(var d=c.a3(),u=c.a8();null!=u;u=u.a8()){var _=u.a3();l+=n[d.al()]*n[_.al()]}return e.i7(t,l),n[t.al()]=o+1,l>s&&(s=l,i[0]=t),s},ni.a4=function(t,e){var i=new di,n=new ti(i);n.a6(!1),n.a9(t,e);for(var s=i.c1();s.i1();s.i2())t.x3(s.i8());return i},ni.a3=function(t){return ni.a4(t,ni.a2(t))};var si=function(){this._n=!0,this.a6(!1)};D.ext(si,qe,{a3:function(t,e,i){i||(this._n=!1)},a1:function(t){this._n=!1}});var oi=function(t,e){this._i=0,this._m=e,this._j=t,this._l=!1};D.ext(oi,qe,{a8:function(t){this._h=kn.a(t.x0()),this._k=kn.a(t.x0()),this._g=new vi(t.xh()),oi.superClass.a8.call(this,t)},a5:function(t,e){this._k[t.al()]=this._h[t.al()]=e},a3:function(t,e,i){if(this._g.c(t),!i){var n=t.a1(e);this._h[n.al()]=Math.min(this._h[n.al()],this._k[e.al()])}},a1:function(t){this._l=!1},a2:function(t,e){var i=t.a1(e);if(this._h[e.al()]>=this._k[i.al()]){for(;this._g.d()!==t;this._j.i5(this._g.b(),this._i));this._j.i5(this._g.b(),this._i),this._i++,this._g.a()?this._l?this._m.i5(i,!0):this._l=!0:this._m.i5(i,!0)}this._h[i.al()]=Math.min(this._h[i.al()],this._h[e.al()])}});var ri=function(t,e){this._h=!1,this._i=t,this._g=e};D.ext(ri,Object,{z1:function(t,e){t._c[this._i]=e},i1:function(t){return t._c[this._i]},i5:function(t,e){t._c[this._i]=e},i4:function(t){return t._c[this._i]},i7:function(t,e){t._c[this._i]=e},i2:function(t){var e=t._c[this._i];return null==e?0:e},i6:function(t,e){t._c[this._i]=e},i3:function(t){var e=t._c[this._i];return null==e?0:e},c:function(){return this._h},d:function(){this._h=!0}});var ai=function(t,e){this._c=!1,this._d=t,this._b=e};D.ext(ai,Object,{i8:function(t,e){t._c[this._d]=e},i1:function(t){return t._c[this._d]},i7:function(t,e){t._c[this._d]=e},i4:function(t){var e=t._c[this._d];return null!=e&&e},i5:function(t,e){t._c[this._d]=e},i2:function(t){var e=t._c[this._d];return null==e?0:e},i6:function(t,e){t._c[this._d]=e},i3:function(t){var e=t._c[this._d];return null==e?0:e},a:function(){return this._c},b:function(){this._c=!0}});var hi=function(t){this._bb=t,this.i4()};D.ext(hi,Object,{i1:function(){return null!=this._aa},i2:function(){this._aa=this._aa._a},i3:function(){this._aa=this._aa._b},i4:function(){this._aa=this._bb._b},i5:function(){this._aa=this._bb._c},i7:function(){return this._bb.ay()},i6:function(){return this._aa._c}});var li=function(t){li.superClass.constructor.call(this,t)};D.ext(li,hi,{i8:function(){return this.i6()}});var ci=function(t){if(this._id=D.id(),this._a=0,t)for(t.i4();t.i1();t.i2())this.ae(t.i6())};D.ext(ci,Object,{ac:function(t){var e=this.ag(t);return null==this._b?this._b=this._c=e:(this._b._b=e,e._a=this._b,this._b=e),this._a++,e},ae:function(t){var e=this.ag(t);return null==this._c?this._b=this._c=e:(this._c._a=e,e._b=this._c,this._c=e),this._a++,e},z1:function(t){t._b=null,t._a=null,null==this._c?this._b=this._c=t:(this._c._a=t,t._b=this._c,this._c=t),this._a++},ad:function(t){t._b=null,t._a=null,null==this._b?this._b=this._c=t:(this._b._b=t,t._a=this._b,this._b=t),this._a++},aa:function(t){return this.ae(t),!0},ab:function(t){for(;t.i1();t.i2())this.ae(t.i6())},ao:function(t,e){if(e===this._b)return this.ac(t);if(null==e)return this.ae(t);var i=this.ag(t);return this.aq(i,e),i},aq:function(t,e){if(null==e)this.ad(t);else if(e===this._b)this.ad(t);else{if(null==this._c)t._b=null,t._a=null,this._b=this._c=t;else{var i=e._b;e._b=t,t._a=e,i._a=t,t._b=i}this._a++}},ap:function(t,e){if(null==e)this.z1(t);else if(e===this._c)this.z1(t);else{if(null==this._b)t._b=null,t._a=null,this._b=this._c=t;else{var i=e._a;e._a=t,t._a=i,i._b=t,t._b=e}this._a++}},an:function(t,e){if(e===this._c)return this.ae(t);if(null==e)return this.ac(t);var i=this.ag(t);return this.ap(i,e),i},ay:function(){return this._a},ar:function(){return 0===this._a},af:function(){this._b=this._c=null,this._a=0},am:function(){return this._b._c},at:function(){var t=this.am();return this.aw(this._b),t},as:function(){return this._c._c},au:function(){return this.aw(this._c)},ak:function(t){for(var e=0,i=this._b;null!=i;){if(t===e)return i._c;i=i._a,e++}return null},aj:function(t){return null==t._a?this._b:t._a},ai:function(t){return null==t._b?this._c:t._b},aw:function(t){return t!==this._b?t._b._a=t._a:this._b=t._a,t!==this._c?t._a._b=t._b:this._c=t._b,this._a--,t._c},av:function(t){return this.aw(t._aa)},ah:function(){return new hi(this)},al:function(t){for(var e=this._b;null!=e;){if(null==e._c&&null==t)return e;if(e._c===t)return e;e=e._a}return null},a0:function(){for(var t=kn.d(this._a),e=0,i=this._b;null!=i;)t[e]=i._c,i=i._a,e++;return t},ax:function(){for(var t=this._b;null!=t;t=t._b){var e=t._a;t._a=t._b,t._b=e}var i=this._b;this._b=this._c,this._c=i},a1:function(t){var e=this.a0();e.sort(t);for(var i=0,n=this._b;null!=n;)n._c=e[i],n=n._a,i++},a2:function(){var t=this.a0();t.sort(kn.c);for(var e=0,i=this._b;null!=i;)i._c=t[e],i=i._a,e++},az:function(t){null==this._b?(this._b=t._b,this._c=t._c):null!=t._b&&(this._c._a=t._b,t._b._b=this._c,this._c=t._c),this._a+=t._a,t._b=t._c=null,t._a=0},ag:function(t){return new gi(t)}});var di=function(t){di.superClass.constructor.call(this,t)};D.ext(di,ci,{c1:function(){return new li(this)},c2:function(){return this.am()},c3:function(){return this.at()}});var ui=function(){this._c=0};D.ext(ui,Object,{a:function(t){this._c++,t._b=this._b,t._a=null,null!=this._b?(this._b._a=t,this._b=t):this._b=this._a=t},b:function(t,e){if(null!=e){var i=e._b;null!=i?i._a=t:this._a=t,t._b=i,t._a=e,e._b=t,this._c++}else this.a(t)},c:function(t){var e=t._a,i=t._b;this._c--,null!=e?e._b=i:this._b=i,null!=i?i._a=e:this._a=e}});var _i=function(t,e){this._p=t,this._j=e,this._o=t._o[e]};D.ext(_i,Object,{i1:function(){return null!=this._o},i2:function(){this._o=this._o._k[this._j]},i3:function(){this._o=this._o._f[this._j]},i4:function(){this._o=this._p._o[this._j]},i5:function(){this._o=this._p._q[this._j]},i7:function(){return this._p._n[this._j]},i6:function(){return this._o},i8:function(){return this._o}});var gi=function(t){this._c=t};D.ext(gi,Object,{a:function(){return this._a},b:function(){return this._b},c:function(t){this._c=t},d:function(){return this._c}});var fi=function(t,e,i,n){this._r=t,this._s=e,this._q=i,this._p=n};D.ext(fi,Object,{i1:function(t){return this._p[t.a5()]},i3:function(t){return this._r[t.a5()]},i2:function(t){return this._s[t.a5()]},i4:function(t){return this._q[t.a5()]},i8:function(t,e){this._p[t.a5()]=e},i6:function(t,e){this._r[t.a5()]=e},i5:function(t,e){this._s[t.a5()]=e},i7:function(t,e){this._q[t.a5()]=e}});var vi=function(t){this._a=kn.d(t),this._b=-1};D.ext(vi,Object,{d:function(){return this._a[this._b]},b:function(){return this._a[this._b--]},c:function(t){this._a[++this._b]=t},a:function(){return this._b<0}});var mi=function(){};D.ext(mi,Object,{a0:function(t){this._c=kn.d(t)}});var pi=function(t,e,i,n,s,o,r){this._g=0,t.xt(this,e,i,n,s,o,r)};D.ext(pi,mi,{a5:function(){return this._h._u&&this._h.b1(),this._g},a2:function(){return this._d},a3:function(){return this._e},a1:function(t){return this._d!==t?this._d:this._e},a4:function(){for(var t=0;t<=1;t++)this._k[t]=null,this._f[t]=null},a8:function(){return this._k[0]},a7:function(){return this._k[1]},a6:function(t,e,i,n){this.a0(n),this._h=t,this._k=kn.d(2),this._f=kn.d(2),this._d=e,this._e=i}});var wi=function(t){this._j=0,this._h=t,this.i4()};D.ext(wi,Object,{i2:function(){this._k=this._k._k[this._j],null==this._k&&0===this._j&&(this._k=this._h._o[1],this._j=1)},i3:function(){this._k=this._k._f[this._j],null==this._k&&1===this._j&&(this._k=this._h._q[0],this._j=0)},i4:function(){this._k=this._h._o[0],null==this._k?(this._k=this._h._o[1],this._j=1):this._j=0},i5:function(){this._k=this._h._q[1],null==this._k?(this._k=this._h._q[0],this._j=0):this._j=1},i1:function(){return null!=this._k},i6:function(){return this._k},i8:function(){return this._k},i7:function(){return this._h.ad()}});var yi=function(){this._a=$i._A,this._b=$i._A,this._c=new oe};D.ext(yi,Object,{i1:function(){return this._c.size()},i2:function(t){return this._c.get(t)},i3:function(t,e,i){this._c.set(t,new ze(e,i))},i4:function(t,e){this._c.add(new ze(t,e))},i5:function(){this._c.clear()},i6:function(){return this._a},i7:function(){return this._b},i8:function(t){this._a=t},i9:function(t){this._b=t}});var Ai=function(){this._x=0,this._y=0,this._w=0,this._h=0};D.ext(Ai,Object,{i5:function(t,e){this._x=t,this._y=e},i6:function(t,e){this._w=t,this._h=e},i4:function(){return this._h},i3:function(){return this._w},i1:function(){return this._x},i2:function(){return this._y}});var xi=function(t,e,i,n){this._m=t,this._n=e,this._l=i,this._k=n};D.ext(xi,Object,{i1:function(t){return this._k[t.al()]},i3:function(t){return this._m[t.al()]},i2:function(t){return this._n[t.al()]},i4:function(t){return this._l[t.al()]},z1:function(t,e){this._k[t.al()]=e},i6:function(t,e){this._m[t.al()]=e},i7:function(t,e){this._n[t.al()]=e},i5:function(t,e){this._l[t.al()]=e}});var Ci=function(t,e){this._b=t,this._r=e,this._a=[];for(var i=this._b-1;i>=0;i--)this._a.push(i);this._c=new oe};D.ext(Ci,Object,{a1:function(t){var e;if(0===this._a.length){this.a2(t,this._b,this._b+this._r);for(var i=this._b+this._r-1;i>this._b;i--)this._a.push(i);e=this._b,this._b+=this._r}else e=this._a.pop();return e},b:function(t){var e=this.a1(t),i=new ri(e,this);return this._c.add(i),this.a4(t,e),i},c:function(t){var e=this.a1(t),i=new ai(e,this);return this._c.add(i),this.a4(t,e),i},a2:function(t,e,i){for(var n=t._a;null!=n;n=n._a){var s=kn.d(i);kn.f(n._c,s,e),n._c=s}},a3:function(t,e,i){var n=kn.d(i);kn.f(t._c,n,e),t._c=n},a4:function(t,e){for(var i=t._a;null!=i;i=i._a)i._c[e]=null},a5:function(t,e){if(t instanceof ri){var i=t;if(i.c())throw\"Error\";i.d();var n=t._i;this._a.indexOf(n)<0&&(this.a4(e,n),this._a.push(n),this._c.remove(t))}},a6:function(t,e){if(t instanceof ai){var i=t;if(i.a())throw\"Error\";i.b();var n=i._d;this._a.indexOf(n)<0&&(this.a4(e,n),this._a.push(n),this._c.remove(t))}}});var Ei=function(t){this._id=D.id(),this._p=0,t.xs(this)};D.ext(Ei,mi,{ad:function(){return this._n[0]+this._n[1]},ak:function(){return this._n[1]},ao:function(){return this._n[0]},al:function(){return this._g._y&&this._g.c(),this._p},ag:function(){return this._o[0]},ae:function(){return this._o[1]},af:function(){return new wi(this)},am:function(){return new _i(this,1)},ap:function(){return new _i(this,0)},an:function(){return new ki(this)},aq:function(){return new Ti(this,1)},aw:function(){return new Ti(this,0)},ah:function(t){for(var e=this._o[0];null!=e;e=e._k[0])if(e.a3()===t)return e;return null},ai:function(t){for(var e=this._o[1];null!=e;e=e._k[1])if(e.a2()===t)return e;return null},aj:function(t){var e=this.ah(t);return null==e&&(e=this.ai(t)),e},au:function(t){this.at(t,1,kn.d(this.ak()))},av:function(t){this.at(t,0,kn.d(this.ao()))},as:function(t,e){this.a0(e),this._g=t,this._o=kn.d(2),this._q=kn.d(2),this._n=kn.a(2)},ab:function(t,e,i,n,s){if(null!=e){var o;if(o=e._d===e._e?n:this!==e._d?1:0,0===s){var r=e._k[o];t._f[n]=e,t._k[n]=r,e._k[o]=t,null==r?this._q[i]=t:r._d===r._e?r._f[n]=t:r._f[this!==r._d?1:0]=t}else{var a=e._f[o];t._k[n]=e,t._f[n]=a,e._f[o]=t,null==a?this._o[i]=t:a._d===a._e?a._k[n]=t:a._k[this!==a._d?1:0]=t}this._n[i]++}else this.aa(t,i,n)},aa:function(t,e,i){var n=this._q[e];t._k[i]=null,null==n?(this._o[e]=t,t._f[i]=null):(t._f[i]=n,n._d===n._e?n._k[i]=t:n._k[this!==n._d?1:0]=t),this._q[e]=t,this._n[e]++},ar:function(t,e,i){var n,s;n=t._k[i],s=t._f[i],null==n?this._q[e]=s:n._f[n._d!==this?1:0]=s,null==s?this._o[e]=n:s._k[s._d!==this?1:0]=n,this._n[e]--},ac:function(){for(var t=0;t<=1;t++)this._o[t]=null,this._q[t]=null,this._n[t]=0},at:function(t,e,i){if(!(this._n[e]<2)){var n,s=this._n[e],o=0;for(n=this._o[e];null!=n;n=n._k[e])i[o]=n,o++;kn.s(i,s,t);var r=this._o[e]=i[0];r._f[e]=null;for(var a=1;a<s;)(n=i[a])._f[e]=r,r._k[e]=n,a++,r=n;this._q[e]=n,n._k[e]=null}}});var Ti=function(t,e){Ti.superClass.constructor.call(this,t,e),this._h=1!==e?1:0};D.ext(Ti,_i,{i6:function(){return this.i9()},i9:function(){return 0!==this._h?this._o._e:this._o._d}});var ki=function(t){ki.superClass.constructor.call(this,t)};D.ext(ki,wi,{i6:function(){return this._k.a1(this._h)},i9:function(){return this._k.a1(this._h)}});var bi=function(t){bi.superClass.constructor.call(this,t)};D.ext(bi,hi,{i9:function(){return this.i6()}});var Si=function(t){this._o=t,this._c=t._a};D.ext(Si,Object,{i1:function(){return null!=this._c},i2:function(){this._c=this._c._a},i3:function(){this._c=this._c._b},i5:function(){this._c=this._o._b},i4:function(){this._c=this._o._a},i7:function(){return this._o._c},i6:function(){return this._c},i9:function(){return this._c},i8:function(){return this._c}});var Li=function(t){if(t&&t.length){Li.superClass.constructor.call(this);for(var e=0;e<t.length;e++)this.ae(t[e])}else Li.superClass.constructor.call(this,t)};D.ext(Li,ci,{x1:function(){return new bi(this)},x2:function(){return this.am()},x3:function(){return this.as()},x4:function(){return this.at()}});var Ii=function(t){this._d=t,Ii.superClass.constructor.call(this)};D.ext(Ii,Li,{});var Pi=function(t){this._a=t,this._b=new di,this._c=new Li};D.ext(Pi,Object,{a:function(){for(var t=this._a.x9();t.i1();t.i2())this.e(t.i9())},b:function(){this.c(),this.d()},c:function(){for(;!this._c.ar();){var t=this._c.x4();this._a.xq(t)||this.g(t)}},d:function(){for(;!this._b.ar();){var t=this._b.c3();this._a.xp(t)||this.f(t)}},e:function(t){for(var e=t.af();e.i1();e.i2())this._b.ac(e.i8()),this._a.h1(e.i8());this._c.ac(t),this._a.h2(t)},f:function(t){this._a.u1(t)},g:function(t){this._a.h3(t)}}),Pi.h=function(t,e){for(e.i4();e.i1();e.i2()){var i=e.i8();t.xq(i.a2())||t.h3(i.a2()),t.xq(i.a3())||t.h3(i.a3()),t.xp(i)||t.u1(i)}},Pi.i=function(t,e){for(e.i4();e.i1();e.i2()){var i=e.i8();t.xp(i)&&t.h1(i),0===i.a2().ad()&&t.h2(i.a2()),0===i.a3().ad()&&t.h2(i.a3())}};var Ri=function(){this._g=arguments[0],this._f=this._g.xk(),this._h=this._g.xk(),this._d=new ci,this._e=0,1!==arguments.length&&this.a(arguments[1],arguments[2],arguments[3],arguments[4])};D.ext(Ri,Object,{a:function(t,e,i,n){for(var s=kn.d(i-e+1),o=e;o<=i;o++)s[o]=new Ii(o);for(var r=this._g.x9();r.i1();r.i2()){var a=r.i9();(null==n||n.i4(a))&&(this._f.z1(a,s[t.i2(a)-e].ac(a)),this._e++)}for(var h=0;h<s.length;h++)for(var l=s[h],c=this._d.ae(l),d=l.x1();d.i1();d.i2())this._h.z1(d.i9(),c)},c:function(){this._g.xi(this._h),this._g.xi(this._f)},e:function(){return 0===this._e},g:function(){for(;this._d.am().ar();this._d.at());this._e--;var t=this._d.am().x4();return this._h.z1(t,null),this._f.z1(t,null),t},f:function(){for(;this._d.as().ar();this._d.au());this._e--;var t=this._d.as().x4();return this._h.z1(t,null),this._f.z1(t,null),t},d:function(t){var e=this._f.i1(t),i=this._h.i1(t),n=i.d(),s=null,o=i.a();null!=o?(s=o.d(),this._h.z1(t,o)):(s=new Ii(n._d+1),this._h.z1(t,this._d.ae(s))),n.aw(e),this._f.z1(t,s.ac(t))},b:function(t){var e=this._f.i1(t),i=this._h.i1(t),n=i.d(),s=null,o=i.b();null!=o?(s=o.d(),this._h.z1(t,o)):(s=new Ii(n._d-1),this._h.z1(t,this._d.ac(s))),n.aw(e),this._f.z1(t,s.ac(t))}});var Di={};Di.a1=function(t){return new xi(t,null,null,null)},Di.a2=function(t){return new xi(null,t,null,null)},Di.a3=function(t){return new xi(null,null,t,null)},Di.a4=function(t){return new fi(null,t,null,null)},Di.a5=function(t){return new fi(null,null,t,null)},Di.a6=function(t){return new fi(null,null,null,t)};var Mi=function(){if(2===arguments.length){this._a=new ci,this._b=new ci,this._c=0;var t=arguments[0],e=arguments[1],i=new Oi(t._j2.gj(e)/2,0);this._a.ac(i),i=new Oi(t._j2.gj(e)/2,0),this._b.ac(i)}else this._a=arguments[1],this._b=arguments[2],this._c=arguments[3]};D.ext(Mi,Object,{});var Oi=function(t,e){this._b=t,this._a=e};D.ext(Oi,Object,{});var Bi=function(){this._cx=!0,this._cs=new ji,this._ct=new Xi,this._cw=new Yi};D.ext(Bi,Object,{i5:function(t){this._cx=t},k:function(){var t=new Ki(this);return this._cx&&(this._cs.w1(t),t=this._cs),this._cw.w1(t),t=this._cw,this._ct.w1(t),t=this._ct},i2:function(t){this.k().i2(t)},i1:function(t){return this.k().i1(t)}});var Ni=function(){Ni.superClass.constructor.call(this),this._jv=20,this._jw=40,this._jx=function(t,e){var i=t.a3(),n=e.a3(),s=i._g;return Math.floor(100*(s.g5(i)-s.g5(n)))}};D.ext(Ni,Bi,{i4:function(t){return ni.a1(t)},i3:function(t){if(!this.i4(t))throw\"Error\";var e=ni.a3(t);if(this._j2=t,this._j3=new zi(t),hn.c(t),this._jy=t.xk(),!t.xb()){this.bu();var i=this._j3.c1();this.f(i),this.b(this._j3),this.c(this._j3)}for(var n;!e.ar();t.x3(n))n=e.c3(),hn.b(t.g2(n))},bu:function(){if(null!=this._jx)for(var t=this._j2.x9();t.i1();t.i2())t.i9().av(this._jx)},c:function(t){for(var e=this.a2(t),i=kn.a(e.length),n=0;n<e.length;n++){for(var s=0,o=e[n].ah();o.i1();o.i2()){var r=o.i6();s=Math.max(s,this._j2.g9(r))}i[n]=s}for(var a=-this._jw,h=0;h<e.length;h++){a+=this._jw+i[h];for(var l=e[h].ah();l.i1();l.i2()){var c=l.i6();this._j2.s2(c,this._j2.g5(c),a-i[h]/2)}}},a2:function(t){for(var e=kn.d(t.b()),i=0,n=t.b();i<n;i++)e[i]=new ci;return t.c1(),this.a1(t.c1(),0,e),e},a1:function(t,e,i){i[e].ae(t);for(var n=t.aw();n.i1();n.i2())this.a1(n.i9(),e+1,i)},b:function(t){var e=t.c1();this._j2.s2(e,0,this._j2.g6(e)),this.g(e)},g:function(t){for(var e=t.aw();e.i1();e.i2()){var i=e.i9(),n=this._jy.i1(i);this._j2.s2(i,this._j2.g5(t)+n._c,this._j2.g6(i)),this.g(i)}},f:function(t){if(this._j3.c2(t))this._jy.z1(t,new Mi(this,t));else{var e=t.aw(),i=e.i9();e.i2(),this.f(i);var n=this._jy.i1(i),s=new Mi(this,n._a,n._b,0);if(!e.i1())return s._a.ac(new Oi(this._j2.gj(t)/2,0)),s._b.ac(new Oi(this._j2.gj(t)/2,0)),void this._jy.z1(t,s);for(;e.i1();){i=e.i9(),e.i2(),this.f(i),n=this._jy.i1(i);for(var o=s._b.ah(),r=n._a.ah(),a=2147483647,h=0,l=0;o.i1()&&r.i1();){var c=o.i6();o.i2();var d=r.i6();r.i2(),l+=c._a,h+=d._a,a=Math.min(a,h-l-c._b-d._b)}n._c=this._jv-a,h+=n._c;if(n._b.am()._a=n._c,o.i1()&&!r.i1())for(var u=l-this.a3(n._b);o.i1();u=0){var _=o.i6();o.i2(),n._b.ae(new Oi(_._b,_._a+u))}else if(!o.i1()&&r.i1()){var g=this.a3(s._a);for(g=h-g;r.i1();g=0){var f=r.i6();r.i2(),s._a.ae(new Oi(f._b,f._a+g))}}s._b=n._b}this._jy.z1(t,s);for(var v=-n._c/2,m=t.aw();m.i1();){var p=m.i9();m.i2();var w=this._jy.i1(p);w._c+=v;var y=w._b.am();y._a+=v,(y=w._a.am())._a+=v}s._a.ac(new Oi(this._j2.gj(t)/2,0)),s._b.ac(new Oi(this._j2.gj(t)/2,0))}},a3:function(t){for(var e=0,i=t.ah();i.i1();i.i2()){e+=i.i6()._a}return e}});var zi=function(t){this._b=t,this.a()};D.ext(zi,Object,{c1:function(){return null==this._a&&this.a(),this._a},b:function(){return null==this._a?-1:this.d(this._a)},d:function(t){for(var e=0,i=t.aw();i.i1();i.i2())e=Math.max(e,this.d(i.i9()));return e+1},c2:function(t){return 0===t.ao()},a:function(){for(var t=this._b.x9();t.i1();t.i2())if(0===t.i9().ak())return void(this._a=t.i9())}});var Fi=function(t){this._d=0,this._e=0,this._f=0,this._a=0,this._b=0,this._g=t,this._c=new ci};D.ext(Fi,Object,{a:function(){return this._d+this._e+this._f}});var Vi=function(){Vi.superClass.constructor.call(this),this._kl=340,this._km=360,this._kk=40,this._ko=.5};D.ext(Vi,Bi,{ic:function(){return this._km},ia:function(){return this._kl},i9:function(){return this._ko},i3:function(t){if(!ni.a1(t))throw\"Error\";this._a=t;var e=this.i8(),i=ni.a4(t,e);hn.c(t),this._kn=kn.d(t.x0());for(var n=t.x9();n.i1();n.i2()){var s=n.i9();s!==e?this.aa(s,new Fi(this._kk+this.q(s.aq().i9()))):this.aa(s,new Fi(this._kk))}this.s(e),t.s2(e,0,0),this.t(e);for(var o;!i.ar();t.x3(o))o=i.c3()},i4:function(t){return ni.a1(t)},i0:function(t){return this._kn[t.al()]},i8:function(){return ni.a2(this._a)},i7:function(t){for(var e,i=this.ib(t);;){if((e=this.i6(t))<=i)break;for(var n=t.aw();n.i1();n.i2()){var s=n.i9();this.i0(s)._g*=1+this._ko}}var o=(i-e)/(2*t.ao());e=0;for(var r=t.aw();r.i1();r.i2()){var a=this.i0(r.i9());a._d+=o,a._e+=o,e+=a._d+a._e}this.id(t)},id:function(t){for(var e=kn.d(t.ao()),i=0,n=t.ap();n.i1();)e[i]=n.i8(),n.i2(),i++;var s=this;e.sort(function(t,e){var i=t.a3(),n=e.a3(),o=s.i0(i).a()-s.i0(n).a();return o>0?1:o>=0?0:-1});for(var o=0;o<e.length;o++)this._a.h1(e[o]);for(var r=0;r<e.length;r+=2)this._a.u1(e[r]);for((i=e.length-1)%2==0&&i--;i>0;i-=2)this._a.u1(e[i])},ib:function(t){return 0===t.ak()?this._km:2===t.ao()?Math.min(180,this._kl):this._kl},i6:function(t){for(var e=0,i=t.ap();i.i1();i.i2()){for(var n,s=i.i8().a3(),o=this.i0(s),r=-o._g,a=o._b,h=o._c,l=0,c=l+1,d=h._b,u=d.d();c>l;c=(n.y-a)/(n.x-r))n=u,l=((u=(d=h.ai(d)).d()).y-n.y)/(u.x-n.x);for(o._d=180*-Math.atan(c)/Math.PI,c=(l=0)-1,u=(d=h._b).d();d.a().d().x===u.x;u=d.d())d=d.a();for(var _;c<l;c=(_.y-a)/(_.x-r))_=u,l=((u=(d=h.aj(d)).d()).y-_.y)/(u.x-_.x);o._e=180*Math.atan(c)/Math.PI,e+=o._d+o._e}return e},aa:function(t,e){this._kn[t.al()]=e},p:function(t){var e=this.i0(t),i=new ci,n=2*this.q(t);i.aa(new ze(0,0)),i.aa(new ze(0,n)),i.aa(new ze(n,n)),i.aa(new ze(n,0)),e._c=i,e._a=n/2,e._b=n/2},r:function(t){if(0===t.ao())this.p(t);else{var e=this.i0(t),i=this.q(t),n=new ci;n.aa(new ze(-i,-i)),n.aa(new ze(-i,i)),n.aa(new ze(i,-i)),n.aa(new ze(i,i));for(var s=t.aw();s.i1();s.i2()){var o=this.i0(s.i9());n.az(o._c)}for(var r=$i.h(n),a=Number.MAX_VALUE,h=Number.MAX_VALUE,l=Number.MIN_VALUE,c=Number.MIN_VALUE,d=r.ah();d.i1();d.i2()){var u=d.i6();u.x<a&&(a=u.x),u.x>l&&(l=u.x),u.y<h&&(h=u.y),u.y>c&&(c=u.y)}for(var _=new ci,g=r.ah();g.i1();g.i2()){var f=g.i6();_.aa(new ze(f.x-a,f.y-h))}e._c=_,e._a=-a,e._b=-h}},s:function(t){if(0===t.ao())this.r(t);else{for(var e=t.aw();e.i1();e.i2())this.s(e.i9());this.i7(t);for(var i=0,n=t.aw();n.i1();n.i2()){var s=n.i9(),o=this.i0(s),r=180-(360-this.ib(t))/2-i-(o._e+o._f);i+=o.a(),r=r/180*Math.PI;for(var a=Math.sin(r),h=Math.cos(r),l=o._c._b;null!=l;l=l.a()){var c=l.d(),d=c.x+o._g,u=c.y-o._b,_=new ze(d*h-a*u,d*a+h*u);l.c(_)}var g=o._a+o._g;o._a=g*h,o._b=g*a}this.r(t)}},t:function(t){var e=this._a.g4(t),i=0;if(t.ak()>0){var n=t.aq().i9(),s=this._a.g4(n);i=Math.PI+Math.atan2(s.y-e.y,s.x-e.x)}for(var o=t.aw();o.i1();o.i2()){var r=o.i9(),a=this.i0(r);if(0!==i){var h=Math.cos(i),l=Math.sin(i),c=a._a*h-l*a._b,d=a._a*l+h*a._b;a._a=c,a._b=d}this._a.s2(r,e.x+a._a,e.y+a._b),this.t(r)}},q:function(t){return Math.max(this._a.gj(t),this._a.g9(t))/2*1.41}});var Ui=function(){};D.ext(Ui,Object,{i2:function(t){return t.ad()},i1:function(t){throw\"Error\"},i3:function(t){throw\"Err